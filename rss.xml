<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[银凤梨]]></title><description><![CDATA[梁伯豪的笔记, 只负责写, 不负责其他]]></description><link>https://pakholeung37.github.io</link><generator>GatsbyJS</generator><lastBuildDate>Wed, 03 Mar 2021 16:03:55 GMT</lastBuildDate><item><title><![CDATA[vite-plugin-vue2-svg插件开发和总结]]></title><description><![CDATA[前言 最近在做旧项目（vue2）的 vite 工程化改造中，遇到了 svg 引入和优化的问题。因为 vite 是相对新的一个工程工具，所以相应的生态也不是特别丰富。目前这个阶段而言，关于可用的 vite svg 工程化库有三个，分别是vite-svg, vite-svg…]]></description><link>https://pakholeung37.github.io/vite-plugin-vue2-svg插件开发和总结/</link><guid isPermaLink="false">https://pakholeung37.github.io/vite-plugin-vue2-svg插件开发和总结/</guid><pubDate>Wed, 03 Mar 2021 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;前言&lt;/h2&gt;
&lt;p&gt;最近在做旧项目（vue2）的 vite 工程化改造中，遇到了 svg 引入和优化的问题。因为 vite 是相对新的一个工程工具，所以相应的生态也不是特别丰富。目前这个阶段而言，关于可用的 vite svg 工程化库有三个，分别是&lt;a href=&quot;https://github.com/visualfanatic/vite-svg/tree/master/packages/vite-plugin-vue-svg&quot;&gt;vite-svg&lt;/a&gt;, &lt;a href=&quot;https://github.com/jpkleemans/vite-svg-loader&quot;&gt;vite-svg-loader&lt;/a&gt;, &lt;a href=&quot;https://github.com/meowtec/vite-plugin-svg-sprite&quot;&gt;vite-plgin-svg-sprite&lt;/a&gt;。这里面前两个库都是针对 vue3 的，所以排除了，只剩下 vite-plugin-svg-sprite 可选。这个库的功能还是比较齐全的，单 svg svgo 优化，svg sprite，框架无关，算是很不错的选择。介意的地方有几个&lt;/p&gt;
&lt;h3&gt;模版代码&lt;/h3&gt;
&lt;p&gt;在调用上，不是特别清晰，需要写一些模版代码，下面是一个比较典型的 svg 引用&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;vue&quot;&gt;&lt;pre class=&quot;language-vue&quot;&gt;&lt;code class=&quot;language-vue&quot;&gt;&amp;lt;template&amp;gt;
  &amp;lt;svg&amp;gt;&amp;lt;use :xlink:href=&amp;quot;`#${icon}`&amp;quot;&amp;gt;&amp;lt;/use&amp;gt;&amp;lt;/svg&amp;gt;
&amp;lt;/template&amp;gt;
&amp;lt;script&amp;gt;
import icon from &amp;quot;./icon.svg&amp;quot;
export default {
  data() {
    return {
      icon,
    }
  },
}
&amp;lt;/script&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看到，处理引入 svg，还需要写一些模版 template 才可以引用真正的 svg&lt;/p&gt;
&lt;h3&gt;动态加载&lt;/h3&gt;
&lt;p&gt;这个是 svg sprite 的通病，因为 svg sprite 需要把所有 svg 全部压在一个文件里面，这样你的网站加载的时候只能一次性把所有需要用到的 svg 加载进来，没办法加载到页面的决定性的资源。我猜测这是大部分网站放弃 svg sprite 的原因。目前比较主流的方法都是将 svg 转换成组件使用的。&lt;/p&gt;
&lt;h2&gt;vite-plugin-vue2-svg 插件开发&lt;/h2&gt;
&lt;p&gt;看了这几个插件的源码，发现现阶段没有特别适合 vue2 的方案，所以决定开发一个新的插件&lt;a href=&quot;https://github.com/pakholeung37/vite-plugin-vue2-svg&quot;&gt;vite-plugin-vue2-svg&lt;/a&gt;。虽然以前也有一些插件开发和包发布的经验，但是这次决定采取更高的标准去完成这件事。&lt;/p&gt;
&lt;h2&gt;工具栈&lt;/h2&gt;
&lt;p&gt;这次选用的组合是 yarn、typescript，以及一些必要的规范工具。&lt;/p&gt;
&lt;h2&gt;开发&lt;/h2&gt;
&lt;p&gt;这个插件是参考 vite-svg 完成的。在 compileSvg 的阶段有一些麻烦。这个函数主要的作用是接受一个 svg file 的 content，然后返回 vue component 的 file content
一开始选择纯手撸 render&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;compileSvg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;svg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
    export default {
      render(h) {
        h(&apos;span&apos;, {
          domProps: {
            innerHTML: &apos;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;svg&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;,
          }
        })
      }
    }
  &lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;咋一看好像没有什么问题，但是问题很大&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;svg 需要由一个 wrapper tag 包裹，这样在调用时一些 dom props 就没办法传递到真正的 svg tag 上面。&lt;/li&gt;
&lt;li&gt;有 xss 风险，这里将一个 svg 作为 innerHTML 直接插入到 dom 中，如果 svg 文件里面有一些 script 标签，也会一并插入到 dom 中，虽然所有的 svg 都来自内部，但是作为一个插件开发者应该考虑各种状况。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;所以看来，得上 vue template compiler 了&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; compile &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;vue-template-compiler&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;compileSvg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;svg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;compile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    id&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    source&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; svg&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    filename&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里又有一个比较麻烦的地方，我使用 vue-template-compiler 编译后，代码中有&lt;code class=&quot;language-text&quot;&gt;with(this)&lt;/code&gt;的代码，这样根本没办法在严格模式下运行。果不其然，引用后直接就报错了。&lt;/p&gt;
&lt;p&gt;于是我参考了另一个库 vite-plugin-vue2，它里面使用了一个@vue/component-compiler-utils 的包，用于将*.vue 文件编译出 vue component。于是最终代码变成这样&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; compileTemplate&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; parse &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;@vue/component-compiler-utils&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; compiler &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;vue-template-compiler&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;compileSvg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;svg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; template &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    source&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
      &amp;lt;template&gt;
        &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;svg&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
      &amp;lt;/template&gt;
    &lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    compiler&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; compiler&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    filename&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;template&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;template&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;compileTemplate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    compiler&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; compiler&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    source&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; template&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;content&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    filename&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
    export default {
      render: render,
    }
  &lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;整体看上去还是比较简洁的。&lt;/p&gt;
&lt;h2&gt;打包&lt;/h2&gt;
&lt;p&gt;一开始是使用 rollup 打包，但是总是发现会将一些外部的包引入到最终代码中，导致运行报错，一开始没意识到这个插件在 node 中运行，其实只需要将 typescript 编译到 javascript 就可以了，后来放弃使用 rollup 包，只使用 tsc 即可。&lt;/p&gt;
&lt;h3&gt;tsc 配置&lt;/h3&gt;
&lt;p&gt;tsconfig 打包配置有几个关键的字段是要声明的&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;compilerOptions&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;target&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;es5&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 这里其实填es6也是可以的，毕竟只是在node中运行&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;module&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;commonjs&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 会添加额外的runtime将import转换成cjs。虽然有些node开了esmodule实验特性，不过还是转换比较好&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;outDir&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;./lib&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 这里是输出目录&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;declaration&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 这一步会确定*.d.ts文件会不会输出到目录，没有这个type文件，那你的插件就没办法被正确的类型推断&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;调试&lt;/h2&gt;
&lt;p&gt;以往的调试我都是直接在 src 里面加调试文件和代码做调试的，所以这次参考了其他一些库，更加标准地做这件事。&lt;/p&gt;
&lt;p&gt;这里主要是将一个调试用的项目放在/examples 目录下，与 src 文件夹区分开来。examples 下是一个完整的 vite 项目，可以用于测试插件。主要的难点是如何将插件链接到这个项目中。
一开始使用 yarn 本地依赖的方法，在 package.json 中添加&lt;code class=&quot;language-text&quot;&gt;&amp;quot;vite-plugin-vue2-svg&amp;quot;: &amp;quot;file:../&amp;quot;&lt;/code&gt;，这样 yarn 会将插件的目录链接到调试项目中。但是这里有一个问题，每次修改完代码我都需要重新 build 然后&lt;code class=&quot;language-text&quot;&gt;yarn --force&lt;/code&gt;安装依赖，过程比较缓慢。&lt;/p&gt;
&lt;p&gt;后来我参考了&lt;code class=&quot;language-text&quot;&gt;yarn link&lt;/code&gt;的方案，彻底解放调试效率。&lt;/p&gt;
&lt;h2&gt;发版&lt;/h2&gt;
&lt;p&gt;npm 发包需要在 package.json 填写一些必要的字段&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  ...
  &lt;span class=&quot;token property&quot;&gt;&quot;main&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;lib/index.js&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 这里需要指定包入口文件&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;types&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;lib/index.d.ts&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 这里需要指定types入口&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;files&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;lib&quot;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 这个字段比较关键， 我一开始发包的时候，尝试数次都只能将*.js发上去，自动忽略了*.d.ts和sourcemap，指定了这个字段后，该目录下所有文件都会入npm包&lt;/span&gt;
  ...
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;然后执行&lt;code class=&quot;language-text&quot;&gt;yarn publish --registry=&amp;quot;https://registry.npmjs.org/&amp;quot;&lt;/code&gt;，添加后面 registry 是因为我用的是 taobao 源，所以发版会发不上去，需要将注册源临时换到官方 npm&lt;/p&gt;</content:encoded></item><item><title><![CDATA[svg优化及相关思考]]></title><description><![CDATA[最近一直在做项目重构相关工作，有一些关于 svg 优化的事项，思考，一并总结在此。 背景 这次重构工作，本质上是工程化的开端。在以前的项目中，js 使用的 gulp 合并压缩，而在这次重构工程化中，使用了 vite 作为工程工具。所以工程化和相关优化都是围绕 vite…]]></description><link>https://pakholeung37.github.io/svg优化及相关思考/</link><guid isPermaLink="false">https://pakholeung37.github.io/svg优化及相关思考/</guid><pubDate>Fri, 26 Feb 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;最近一直在做项目重构相关工作，有一些关于 svg 优化的事项，思考，一并总结在此。&lt;/p&gt;
&lt;h2&gt;背景&lt;/h2&gt;
&lt;p&gt;这次重构工作，本质上是工程化的开端。在以前的项目中，js 使用的 gulp 合并压缩，而在这次重构工程化中，使用了 vite 作为工程工具。所以工程化和相关优化都是围绕 vite 生态展开的。svg 的优化也一并提上了日程。在以前的 svg 依赖引入，是使用一个脚本，将所有 svg 文件，打包到一个 svg-manage.js 中，这个脚本会在运行时，向页面注入一个 svg-sprite&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;svg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;symbol&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;sth&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;symbol&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;svg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这样在运行时，就可以通过&lt;code class=&quot;language-text&quot;&gt;&amp;lt;svg&amp;gt;&amp;lt;use xlink:href=&amp;quot;#sth&amp;quot;&amp;gt;&amp;lt;/use&amp;gt;&amp;lt;/svg&amp;gt;&lt;/code&gt;，引用到该 svg 了。
这个方案有几个问题：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;每次新增一个 *.svg 的时候，要通过一个额外的脚本，去生成一个 svg-manage.js 的文件，这样才能引用在运行时调用到相应的 svg，这不是一个符合直觉的前端工作流。在这种工作流中，svg 的应用，打包，优化会割裂在一个相对独立的环境中，没办法做整体的优化。&lt;/li&gt;
&lt;li&gt;依赖引用非常不明确。首先，*.svg 需要放在一个指定的目录下，指定的文件夹层级下，才能被成功打包。这种行为既不符合直觉，确定性也很差。如果有一天你想整理 svg 的文件夹，想新增文件夹或想将 svg 放置到不同的目录下，你只能再次重写相应的打包脚本。这对于一个只想整理的人来说是不合理的。其次，引用的 svg 是通过全局&lt;code class=&quot;language-text&quot;&gt;use xlink:href=&amp;quot;#sth&amp;quot;&lt;/code&gt;来引用的，这种方案和全局依赖一样糟糕。如果那天 svg 被误删，或者 svg 被优化，或者想整体剔除不再需要用到的 svg，你基本不可能发现和做到。对于重构来说，不确定性会很高。&lt;/li&gt;
&lt;li&gt;由于全局 symbol 的关系，没办法处理重名的 svg。虽然有几种方案处理这种状况，例如人为添加 sufix 或添加&lt;code class=&quot;language-text&quot;&gt;[filename]-&lt;/code&gt;prefix 等方案（现在因为只允许单层目录，所以不会重名），这样在调用时会造成难度，另外重构时也麻烦，在项目中也经常出现&lt;code class=&quot;language-text&quot;&gt;icon-undo-2&lt;/code&gt;这样的 svg 文件。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;所以我比较认同 webpack everything is a module 的观点。一个合格的模块，他的依赖图必须是确定的，无论是脚本还是资源，你必须有明确的依赖关系，在这个例子中。svg 必须通过 import 或 url 载入到调用的模块。&lt;/p&gt;
&lt;h2&gt;方案&lt;/h2&gt;
&lt;p&gt;目前的主流方案基本有几种，svgo 是基本的单 svg 优化，就不叙述了。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;vite 原生&lt;/li&gt;
&lt;li&gt;将 svg 编译到相应框架的组件。&lt;/li&gt;
&lt;li&gt;类似 svg symbol sprite，将 import 的 svg 打包成一个 svg symbol&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在 vite 原生中，导入的静态资源一律是作为 url 处理的&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;vue&quot;&gt;&lt;pre class=&quot;language-vue&quot;&gt;&lt;code class=&quot;language-vue&quot;&gt;&amp;lt;template&amp;gt;
  &amp;lt;img src=&amp;quot;./assets/sth.svg&amp;quot; /&amp;gt;
&amp;lt;/template&amp;gt;
&amp;lt;script&amp;gt;
import sthSvg from &amp;quot;./assets/sth.svg&amp;quot;

console.log(sthSvg) // &amp;quot;./assets/sth.svg&amp;quot;
&amp;lt;/script&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这种方式有一些问题：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;应用的 svg，没有做优化，例如合并 svg 请求，需要配合一些其他的插件完成（暂时还没有）。&lt;/li&gt;
&lt;li&gt;没法对 svg 做 css animation，css 和 js 处理，只能用作简单显示。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;vite 对于第二种方案， 以&lt;a href=&quot;https://github.com/jpkleemans/vite-svg-loader&quot;&gt;Vite SVG loader&lt;/a&gt;为例， ，是这样引用的&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;vue&quot;&gt;&lt;pre class=&quot;language-vue&quot;&gt;&lt;code class=&quot;language-vue&quot;&gt;&amp;lt;template&amp;gt;
  &amp;lt;SthSvg /&amp;gt;
&amp;lt;/template&amp;gt;
&amp;lt;script&amp;gt;
import SthSvg from &amp;quot;./assets/sth.svg&amp;quot;
export default {
  data() {
    SthSvg,
  }
}
&amp;lt;/script&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看到导入的 svg 变成了一个 vue component。这种方案会将 svg 改写成为一个 component，这样就可以在 SFC 中直接调用这个 svg 了。&lt;/p&gt;
&lt;p&gt;这种做法有好有坏：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;不太符合直觉，因为跳了一步，不了解的人，很难理解导入 svg -&gt; vue 的过程。针对这个问题，另外一个库&lt;a href=&quot;https://github.com/visualfanatic/vite-svg/tree/master/packages/vite-plugin-vue-svg&quot;&gt;vite-plugin-vue-svg&lt;/a&gt; 通过一种 query string 的方案去回避这个问题。&lt;code class=&quot;language-text&quot;&gt;import SthSvg from &amp;quot;./assets/sth.svg?component&amp;quot;&lt;/code&gt;或&lt;code class=&quot;language-text&quot;&gt;import SthSvg from &amp;quot;./assets/sth.svg?url&amp;quot;&lt;/code&gt;来控制载入的是 url 还是 vue component&lt;/li&gt;
&lt;li&gt;符合&lt;code class=&quot;language-text&quot;&gt;everything in js&lt;/code&gt;的前端趋势。很多的 ui 库其实都是这样处理的，像 antd 等也是直接将 svg 转换成相应的 component 的。&lt;/li&gt;
&lt;li&gt;自然的优化方案，保留 tree-shaking 的方法同时对 async component 有效，不会引入多余的资源。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;不过最大的问题还是这两个库只支持 vue3，所以目前也用不了。&lt;/p&gt;
&lt;p&gt;最后一种方案，以&lt;a href=&quot;https://github.com/meowtec/vite-plugin-svg-sprite&quot;&gt;vite-plugin-svg-sprite&lt;/a&gt;为例，他的引入方案是这样的&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;vue&quot;&gt;&lt;pre class=&quot;language-vue&quot;&gt;&lt;code class=&quot;language-vue&quot;&gt;&amp;lt;template&amp;gt;
  &amp;lt;svg&amp;gt;&amp;lt;use :xlink:href=&amp;quot;`#${SthSvg}`&amp;quot;&amp;gt;&amp;lt;/use&amp;gt;&amp;lt;/svg&amp;gt;
&amp;lt;/template&amp;gt;
&amp;lt;script&amp;gt;
import sthSvg from &amp;quot;./assets/sth.svg&amp;quot;
console.log(sthSvg) // &amp;quot;sth&amp;quot;
export default {
  data() {
    SthSvg,
  }
}
&amp;lt;/script&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;当你引入一个 svg 的时候，其实是引入了他的 symbol，这样在代码中可以使用 xlink:href 引用到对应的 svg。暂时来说，我也是使用这种方案。这种方案和以前的方案其实是一样的，不过他处理了明确依赖的问题，也可以通过 hash 解决同名的问题。重点是，你不再需要关注导入的 svg 是什么 symbol 了，一切都非常自然。
这种方案最大的问题还是封装的力度不是很够，你需要写额外的&lt;code class=&quot;language-text&quot;&gt;&amp;lt;svg&amp;gt;&amp;lt;use /&amp;gt;&amp;lt;/svg&amp;gt;&lt;/code&gt;代码去调用相应的 svg。对于 typescript 不是太友好，如果你用其他的图标库就会发现，大部分的库都是按照第二种方法将 svg 直接封装成 component 的，他的 compoennt， props 都有明确的类型的。
在调用时可以写成&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; React &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;react&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; SthIcon &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;./SthIcon&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; SomeComponent &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;./SomeComponent&quot;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;App&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;SomeComponent&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;icon&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;SthIcon&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果使用 svg-sprite，这种风格就不再那么自然了， 你需要再用额外的方案去处理这个问题。&lt;/p&gt;
&lt;p&gt;所以目前来说，虽然我还是偏好第二个方案，我暂时会选择这个方案，写一个针对 vue2 的 vite svg plugin 在这个时间节点不是一件收益特别高的事，而且兼容旧有的风格，这种方案看起来也没有那么不堪。&lt;/p&gt;
&lt;h2&gt;references&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://una.im/svg-icons/&quot;&gt;A Gulp-Based External SVG Symbol Sprite Icon System&lt;/a&gt;
&lt;a href=&quot;https://www.jianshu.com/p/cb1a64cbcf4e&quot;&gt;重要的图像优化之六：SVG 的优化&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[现存项目 问题 分析 解决方案]]></title><description><![CDATA[在这里对在工作中的项目中代码，编码模式进行集中吐槽, 分析, 并提出各类解决方案的成本， 优劣点. 基础设施 svn…]]></description><link>https://pakholeung37.github.io/现存项目 问题 分析 解决方案/</link><guid isPermaLink="false">https://pakholeung37.github.io/现存项目 问题 分析 解决方案/</guid><pubDate>Mon, 26 Oct 2020 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;在这里对在工作中的项目中代码，编码模式进行集中吐槽, 分析, 并提出各类解决方案的成本， 优劣点.&lt;/p&gt;
&lt;h2&gt;基础设施&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;svn 项目管理&lt;/strong&gt;, 没有分支, 所有人都在同一条主分支上开发. 这种线性的开发模式导致敏捷开发的循环被各种环境打破, 开发代码和生产环境代码常常混杂在同一个主分支中, 导致迭代的周期被固定, 已上线的 bug 难以 bugfix, 因为能不能上代码的问题,加大同事间沟通成本, 降低效率. 虽然, 公司正在逐步迁移到 gitlab 中, 但是, 也存在一定的问题. 首先, 没有统一的 gitflow, 一部分的项目和 svn 时期一样, 只有 master 一条分支. 大部分项目用的是 gitlab flow, 多少也算是一种进步. 第二, 以往的 svn 记录并没有保留下来, 对于这一点我是相当疑惑的. 只要稍微有些常理也知道如果没办法保留 commit 信息, 那迁移的成本是不是太高? 稍微搜索一下就会有解决方案. 我是没看到除我以外有人在迁移的同时花些时间考虑一下保留 svn commit.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;代码质量管理方案欠缺&lt;/strong&gt;, 以前是完全没有代码质量管理. 近期才添加了 eslint prettier 的支持. 但是…很可惜, 大量代码已经因为前期的质量方案问题, 已经造成代码风格百花齐放的局面, 要么忍受各种飘红的错误信息, 要么直接把 eslint prettier 关掉. 代码质量这东西, 我个人认为是非 0 即 1 的, 今天你能忍受一条错误, 明天你就能忍受第二条. 只能说, 终吃了基础设施落后的恶果, 现在要弥补这个缺陷, 可以抽个时间用 eslint fix 直接跑一遍, 将所有错误信息全部先 fix 掉, 但是这是不太可能的. 以现今代码项目规模来看, 大概有 10%(估算而已)的代码是需要人为修复, 不管怎么看, 这个代码量都太大. 另一种可能就是引入 lint-stage 的方案, 只对新提交的代码进行质量检测. 这个方案落地我是比较看好的, 虽然对我来说, 这个项目有没有质量管理, 其实都好像没太大意义. 对我而言, 这个项目重写的效率大于重构.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;打包策略&lt;/strong&gt;, 已知使用 gulp 打包 js, postCSS 编译 CSS. 没有好的现代打包机制, 直接影响整个前端基础设施的进步. 现代 bundler 如 webpack, rollup. 都是依赖模块化进行打包的. 而 gulp, 则天生不是用来打包 module like 的 JS 的. 要转换到 webpack, 就必须转向模块化. 这个迁移成本其实在我看来是可以接受的. webpack 和 rollup 都是入口导向的, gulp 则是以文件导向的, 其实两者转换并没有那么困难. 在以往的经验中, 这种迁移并没有很难, 在内部也有成功的先例.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;社区建设&lt;/strong&gt;, 以往社区的缺失直接导致工程师间交流出现障碍, 大家都闭门造车, 反复地造轮子, 浪费人力. 对于造轮子, 我一向是持保留意见的. 自己通过造轮子, 了解技术原理可以. 但是在有现存成熟方案的前提是, 自己搞一套上生产环境, 我觉得是一种非常不负责任的表现. 我非常不赞成工程师搞一套只能解决现状, 没有充分考虑未来变化的方案大干快上. 闭门造车的结果就是维护困难, 扩展困难, 迁移困难, 这些都是血一样的教训.你要知道工程师遇到的大部分问题都是别人遇到过的, 最起码, 你得知道别人是怎么解决问题, 站在巨人的肩膀上看问题, 解决问题, 才是一个工程师合格的修养.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;社区缺乏的现状稍微有些减轻, 因为有 gitlab 存在. 但是工程师的开源项目经验太少, 没办法在内部推广自己的轮子. 这点确实是工程师经验的不足, 也是氛围的问题. 在未来需要持续改进.&lt;/p&gt;
&lt;p&gt;我司一直在谈如何提升人效的问题. 其实加大对基础设施的投入, 也不失为一种高性价比提升人效的方法. 以我的经验, 最应该先做的是打包策略和 git 接入, git 接入成本会更高一些, 主要体现在 diff 和 commit, 未来维护的成本和沟通成本会有所降低. webpack 则是目前现代化前端的发动机, 有了 bundler, 对目前很多问题都可以更有效的解决, 这里列举一些&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;esnext 支持, 支持更高标准的 JavaScript 语法.&lt;/li&gt;
&lt;li&gt;treeShaking 减少代码体积.&lt;/li&gt;
&lt;li&gt;更方便引入私有库和额外库, 减少重复造轮子, 更好地维护依赖关系.&lt;/li&gt;
&lt;li&gt;代码静态分析, 减少各种依赖错误.&lt;/li&gt;
&lt;li&gt;更现代, 更快的编译, 更短的压缩代码时间.&lt;/li&gt;
&lt;li&gt;引入测试框架.&lt;/li&gt;
&lt;li&gt;更好的应对未来升级.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;上面提到的这些, 其实都是现在主流的前端构建方案. 新进来的开发, 多少都有共识, 就是现存的工程化实在是太久了. 以上这些问题的解决方案, 有些我们已经在做了, 但是还做的不够好.&lt;/p&gt;
&lt;h2&gt;代码质量&lt;/h2&gt;
&lt;h3&gt;CSS&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;随意的命名规则&lt;/strong&gt;, 在各个项目中, 命名规则基本是 pascal, snake 等混用, 对怎么命名其实是没有太大约束力的, 这一点, 其实也没什么所谓.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;缺失 CSS scoped, 大量覆盖性代码和重复代码&lt;/strong&gt;, 这个问题是迄今为止我觉得 css 管理中最严重的问题. 为了大量互相覆盖的 css 代码,我们必须写更多的 css 代码去覆盖. 结果就是, css 越写越多, 换个环境, 瞬间就不一致, 因为你不知道到底原来引用了哪里的 css, 也不知道需要覆盖什么 css, 所以每次都需要直接复制一份在此基础上继续改, 进而使 css 代码量增加, 最后变成一坨意大利面, 越来越难维护. 这个问题.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;过量的 CSS hack&lt;/strong&gt;, 以前是为了兼容旧的浏览器, 所以必须要 hack. 但是现在已经不需要再兼容远古浏览器了, 兼容版本基本都是 ie9 起步, 过量的 hack 其实让 css 的正交性, 局部性, 可预测性都出现非常多的问题. 有时候有些 css 代码, 不知道有什么用, 但是又不敢删掉. 扩展起来, 又让人莫名其妙. 比如, 有时候应该用 flex 布局的地方, 各种用其他 table, grid, float 之类的 css 方法, 强行布局. 我觉得到了这个年代, flex 是已经可以不假思索直接就上的.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;要解决 css 问题, 最好的方法还是引入有效的具有 css scope 属性的 css 集成方案, 比如 scoped css 或者 css module.类似 BEM 的方案, 其实我是不太看好的. BEM 并不是一种强制性规则, 对于写些简单 css 的后端工程师是一种负担, 即便对于有经验的前端工程师, 完整的 BEM 规则也显得非常多余, 间接提高工程师的心智负担. 在我司全面使用 vue 的环境下, 我觉得 scoped css 就是一个不错的选择&lt;/p&gt;
&lt;h3&gt;JS&lt;/h3&gt;
&lt;p&gt;先说一下现状，目前基本上所有的项目，都已经做了工程化的处理了。jzallsite，site，mobi 使用了自己编写的 jz-cli 的打包方案，mallapp 的方案暂时确定是 vite。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;全局变量管理&lt;/strong&gt;, 这一点是我觉得比较大的历史遗留问题了。现代前端工程师都知道，如果你要在代码中引用一个外部变量，你应该直接 import 这个变量，而不是将这个变量做成全局变量，然后在项目里肆意地引用。目前所有项目基本都有这个通病，大量地在顶层创建全局变量，然后再在其他地方引用。比较常见就是 SIte，MallApp，Mobi 全局变量。我在做 mallapp 工程化的时候就发现一些代码在无意间创建全局变量的。例如在顶层调用&lt;code class=&quot;language-text&quot;&gt;var variable1 = 1&lt;/code&gt;，或者更夸张，在某个地方在变量还没做声明的时候直接调用&lt;code class=&quot;language-text&quot;&gt;variable2 = 2&lt;/code&gt;，这样的隐式全局变量声明，具有非常大的隐患。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;跨 iframe 调用脚本&lt;/strong&gt;，这种模式在 jzallsite 和 mobi 两个项目中非常常用，因为这两个项目在一个页面中至少会有 1 个 iframe（其实所有人都知道这是一种反模式，但几乎没人求变）。在里层的 iframe 经常会调用外层的页面的代码，这是一件非常违反代码松耦合原则的一件事，同时也是非常不可控的。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Common 通病&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;svn base 项目管理, 没有分支, 所有人都在同一条主分支上开发, 极度残忍. 没有 code review 也不需要, 因为没有分支合并.&lt;/li&gt;
&lt;li&gt;代码没有 format 直接提交, 这点尤其无语, 经常打开文档会出现空格, tab 混用的代码, 代码一长一短的, 实在寒心.&lt;/li&gt;
&lt;li&gt;global css 落后 gulp 打包. 全局污染非常严重.&lt;/li&gt;
&lt;li&gt;js 依然有落后 gulp 打包, 全局变量特别多, 依赖打包顺序. 按道理模块规范何其多, 但我们任性一个也不用.&lt;/li&gt;
&lt;li&gt;过于简单的 workflow, 没有讨论的空间, 不需要 review, 基本我提交项目就照单全收.&lt;/li&gt;
&lt;li&gt;iframe base 调优困难, 重复引入依赖.&lt;/li&gt;
&lt;li&gt;没有调优的概念, 能用就行.&lt;/li&gt;
&lt;li&gt;重复造轮子, 造劣质轮子直接用于项目. 为什么不优先考虑行业成熟方案.我觉得是看的少, 不知道有成熟方案.&lt;/li&gt;
&lt;li&gt;也是因为自己造轮子, 特质化, 没有标准. 引入方案困难.&lt;/li&gt;
&lt;li&gt;没有注释标准. 反正想怎么写就怎么写, 更多的是直接不写, jsDoc 了解一下?&lt;/li&gt;
&lt;li&gt;大量 hard coding, 纯手写 url, 不会用变量来管理吗\&lt;/li&gt;
&lt;li&gt;css 命名混乱, 有使用 camelCase 的, 有使用 snake 的, 有使用 underscore 的,&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Mobi&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;粗暴迭代, 直接创建新文件&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;请看新时代 coding 风格, 面向复制新文件的编程风格. 需求风格 2.0 =&gt; 3.0 直接每个模块复制一段新的代码到 xxxV3.jsp.inc. 跟接着同样新赠 xxxV3.src.css, 维护水平指数上升, 极具文艺复兴特质. 在代码中到处可以看到 if(…ThemeV3) 的代码复用字样. 估计也是因为 2.0 代码太捞, 没办法实现 3.0 功能. 另 3.0 的主开发已经离职, 牛逼. 所以直接搞一套新的.虽然我目前写的代码也是面向复制新文件. 后面会再说到.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;文艺复兴系列之 jquery&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;大量代码逻辑依赖 jQuery, 依赖于视图层. 就问你敢不敢动 dom 结构. 我感情 5, 6 年前没有 vue react angular. 前端的框架不是还有 ember 之流? 怎么想到直接一把梭子就是干?&lt;/p&gt;
&lt;p&gt;给各位欣赏一下面向 jq 的响应式编程&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7c99291e6512f7d6ab9072d97c869b39/38cea/image-20200821165327699.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 107.43243243243244%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAACv0lEQVQ4y42U6XKbMBSF/Rw1m1YkAcb7lrhJO9O+/xudngskdRLc6Y87whgd3eU7Wmit0IQah7bGLnlEq9EHh1106BuPtbyLHilGVK6BqlvoukGeZyiKAkWej+sUi5wvrDN4vbZ4XkXc+ganVY3nc4fXW4cmam6Wj/Mhcm7Kp835JCbrWyzkY200zvvIrDwOTUBfG+y2AU88xJkc35YZskxiiZxrLuud2IcMrfPoYoNgFcs1sKpC4AGJz57lB4bVGrW3rCSgNDW0Tygr9UVsEFQUSLHGjxNL7hP2TY1TG3DbN7geG+w6Nwh6tsXYmoIeykWUZTUvKKVUusLlEIdBiNg6GBwp9nRJMLrAMrsvefml5HvhRaUMQh2wXXlsON118GiZTd957HeJZZecZMGMJPh8H/M9dFjFhE20Ay6W2bbs17q2iLImrtbyUIcmpQmdjuikecHP2Egf37B5eR6x+dyn+5gVFGyux4QDIT61kWVbHPYJNwo6K9jkUw+zv9jIOoPOgE0bEmoz4mI4da/V4BjP3zVxsophZNIOpXaoiE5l3HyGih+3KeCV2NwEm0RsOmKzTZx8g0PveZiGczI8EQrEJkFZPy84YqNwnbA5CjYc0JFil3OcsBlLXv5PyUK8Z9nbfsRmyww7T2yI0Yks1q4cBO/9KhfDQ+tpTYsZyxPHPyQL4a4QEYYib5qHGqOgyGxR6bF/j5wi1msm64099DhvIn5/32C/cnDssTMGkdk7slfaCB26x14ueaK1vPvo2Y4grwTooLHdRgRfvZebDRlnY7nZP0p2Ti7SZhjEmlkIMi1F5ZJI7KXcOsGJSzw8MxOnmLRGpfR8hkVRwnmHl0uLK51yITKHTcCvn1tsOj1kNvq4mPz72Mfvl4OuzOiCuzIymWbxebofY7bksirQnQK6Y4BvzPu0H2XwLx9L/AHr9VCgZIxlXAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image-20200821165327699&quot;
        title=&quot;image-20200821165327699&quot;
        src=&quot;/static/7c99291e6512f7d6ab9072d97c869b39/fcda8/image-20200821165327699.png&quot;
        srcset=&quot;/static/7c99291e6512f7d6ab9072d97c869b39/12f09/image-20200821165327699.png 148w,
/static/7c99291e6512f7d6ab9072d97c869b39/e4a3f/image-20200821165327699.png 295w,
/static/7c99291e6512f7d6ab9072d97c869b39/fcda8/image-20200821165327699.png 590w,
/static/7c99291e6512f7d6ab9072d97c869b39/38cea/image-20200821165327699.png 678w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/36a45626b682094408fa6fb8019b356f/cab43/image-20200821165405251.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 52.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABxklEQVQoz21S6Y6bMBjMgwAJhw8wPiGQpN2oUXfVff8Xmo4dpe1K/TGyP9uM5uBg0g3pxyfm7YYQLPYlYbMTJiXQHI+o6wZHrsfTiWh5luem3D3B87Z93nM+CKnhlivC7QH/7YH1+h3BB0xGY54NjIsYtIEwDmI0kONEaAxq5Hnem3Lfk2cQPQ51XaGpKuhxhtvvRalLC6K3CM7ChgQXIvTs0QtRCAr5ZCFIKKQsiuu6RkWew1N2g1FOVPcTy+MT675j2y5IziCFgO32BmUjZAajGI2FDmfIOUBlaImmORbSQ9M8M9FCI5zfEO/vCOsZy7LCmRHee6TzFdoGKvMQSkKTULkESaWSSrPVTPaFUPYSNu6wlzttRhYU4SYNM00IceGHMzrm1vctrTI/EvVqIrgf/iGsmxpD12NkhtnSwMdSKSg+ElJR0VhyavsBXdeiGxTaIc8CbdcVMVVVIwv7q5DQbMrnUmjPxQTPQpwlPJVSYSlB6aIu2yz2WVAvSN6evlpuSoYjYsnwg+uGdd0Q+T8GZrjutz8ZSinYODP0jCHPzDOf/ZcwXR78yX8hbRs2FhPnCTFkwlcprthXVJZLyapfpbws/wawESd7AU97hAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image-20200821165405251&quot;
        title=&quot;image-20200821165405251&quot;
        src=&quot;/static/36a45626b682094408fa6fb8019b356f/fcda8/image-20200821165405251.png&quot;
        srcset=&quot;/static/36a45626b682094408fa6fb8019b356f/12f09/image-20200821165405251.png 148w,
/static/36a45626b682094408fa6fb8019b356f/e4a3f/image-20200821165405251.png 295w,
/static/36a45626b682094408fa6fb8019b356f/fcda8/image-20200821165405251.png 590w,
/static/36a45626b682094408fa6fb8019b356f/cab43/image-20200821165405251.png 755w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;面向拼接字符串的前端模板编程.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5d33d2cff71e8a9084d82d9975424d88/cab43/image-20200821165418036.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABmElEQVQoz41SSZLbMBDTO2JJ3ERSXCTbkjPxTFKVQyq3/P87CJqSL5lLDijuaDTAbtQO8/aB/dcf5P2J+vyJ9cdv5NsG6wyGYcQ4/j864zz8nOGdRfIknxxK8FhiQOZaK4VLP6AfBpL/g77/tNf5suL69gEzDghUtOeIb3XG9zXjnZACkfuRBZ3RmE5Y6+DmAjN5WK0QrMFkNToXM8pthyLhF1aUg3sKWKPHc0l4nAXuKSKRXFTPJPchYr4+4GJqBWuY2lk35QXr4wlNQqVGXGffsPCCEBdeEuSJJEaUnAqpzNcbrI/c162YdNFNlF23N6ihb6Yu8SDaBFQnvm5lxloylrog0Vvf2jPQWn8OpRHeH02hBJBeigghl/mjpkaYS4VzrnkpUCSQYPrL5RgllNby16NlIdhLbCQ1OIZkWxGBoR3ShWMAjsokCIGWcJiDkZHrzvHLFCpUZLe8KCGIh+KJFEj0rjIgMT2cSQvsSaqMaT5qY9u6pZyvGwINL3zkeEEUvRQYmZvjsexLWy+8/l7fs+Xh+JN/AV/EHH0DWu1YAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image-20200821165418036&quot;
        title=&quot;image-20200821165418036&quot;
        src=&quot;/static/5d33d2cff71e8a9084d82d9975424d88/fcda8/image-20200821165418036.png&quot;
        srcset=&quot;/static/5d33d2cff71e8a9084d82d9975424d88/12f09/image-20200821165418036.png 148w,
/static/5d33d2cff71e8a9084d82d9975424d88/e4a3f/image-20200821165418036.png 295w,
/static/5d33d2cff71e8a9084d82d9975424d88/fcda8/image-20200821165418036.png 590w,
/static/5d33d2cff71e8a9084d82d9975424d88/cab43/image-20200821165418036.png 755w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;我丢, 即便上个年代上模板引擎他不香吗. pug, handlebar, 那样是上个年代没有的, 即便在 java 端也有相应的模板引擎. 你直接给我 srcipt.append 是要玩什么? 拼接模板就拼接模板吧, 你能不能对齐? 来看看各种风格&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1bec3658d25af8f709fba7cb34dd3c23/7527b/image-20200821165527744.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 49.32432432432432%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABlklEQVQoz42SyY7UQBBE/R20l9r3sntsQzdixAGJG///O0Fmjgch5sIhVapy+WVEZA2zskjHNxw/fqEcT/Tnd6yvP1HuO4zVmKYZ8/z/NWjn4VOBtwbZE9xZlODRo0ehvVoW3MYJ4zQR/J8axw9ng693bF++Qs8TAik6S8SjRbxuBc+epUGkc/5mtYK7yhgLmypYkFELgtHwRmHgw0r2FqJ/oo6BlL7kgC15PHrCWblBorOIzOrZBcF9SEjbCRszIsFacPJtcGXFej6gSOFC9hi0Ri6HO4ErXWrBEszA60sJK+So2gYbouyzODEEzB19/0wKRwmVYaxw5yL7nOteE9Za0FtDDgGOoE5raKU+DsXlhvpyiEIeAMvmYmWsktezZWyVomkd1lrJkmtZZhnMeLu9rTIUsfwUYCfAQaqK2HSSJzfRUrO4sDQAQ8qMrAuUNpKjtk7211AOucwXecqcI0M7QTk7fkL1avCuzl7QhYDGR2ia+h9g2XYJnH+ylA2relegeeUhEIDP2dbfxW9vHMny9PYmfwN2MRyQ5vEB1QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image-20200821165527744&quot;
        title=&quot;image-20200821165527744&quot;
        src=&quot;/static/1bec3658d25af8f709fba7cb34dd3c23/fcda8/image-20200821165527744.png&quot;
        srcset=&quot;/static/1bec3658d25af8f709fba7cb34dd3c23/12f09/image-20200821165527744.png 148w,
/static/1bec3658d25af8f709fba7cb34dd3c23/e4a3f/image-20200821165527744.png 295w,
/static/1bec3658d25af8f709fba7cb34dd3c23/fcda8/image-20200821165527744.png 590w,
/static/1bec3658d25af8f709fba7cb34dd3c23/7527b/image-20200821165527744.png 754w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/060268011afb8e4532229126b3df75cf/cab43/image-20200821165543016.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 76.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACaklEQVQ4y2VUWY7bMBSbY0wSb1qtzVuSNtMpWqBA738llk92OgPMByHp2X6iSMov1lpYaxBiRp4XpBiQRo8UAvZnH3DOY9uumKYJKSWUUjhm1h2cFVi8tG0HozW6YUDXEW2D5nJB0zQ4c7wQ5/O5Quan11ecTqejdmLtXN+VZ/2g8NK1LbxPuP3+i+vtCksWU4pYUsCWEzLZTusV83Yj+4goIHvvPWyI0NZDk4zXCsE7Nuw6DCzEecP6eOOxJwQe48pxLpkouK4rtmXFytq6LNi4Ltx04oYjGwejkZ2u0v1v6GysTWOJMGMikwQ79LCqhydk7r6MQ4UmOxOoJX2oDbVxGKcVMWdY7uaIvhdNuy/oD3yutZSt63p0fb9r6Kjh8v4H27c7DaLjRiGR/uQtkuOac01GAnWMhswEtaYUFEkN2uwNB22Rb2+Yl1wdz2wU2UiaRasxEmYYqvh744FS7JC64jfS0LhxbyiL+fEL1/tSG06jQyGm0VaWwtBRJ6v3JuLoyFNITWBG6u4DmeqnKQo9affU4KnLpWlxlixKxoiGa6ntY1PndU1CbcO8MpPyHRl2NYfl/o6ZcQjMoewqUfBmZyJzd7Cqa5FBnrOmRT8e1ZelZrIyTI55Wx+YGezM4Ioh+dBPdJS5NJB5sgrF7zVZe9YVj5vuPxj0csRGO8TlhpzD8aGu2s3UsPhdx3I4XtJ+e56bCEtjqHOaeMs+mVK+/8S6FgSaMh9GRDkqTZAjC1thI4GXn8DTZZFFRjd0NQGVoWPDhX+QlVdtmWesnAe6nDK1IaPAW6Bo2EC08vOgKRLmD3S1psj0HzJsqtK4/c9PAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image-20200821165543016&quot;
        title=&quot;image-20200821165543016&quot;
        src=&quot;/static/060268011afb8e4532229126b3df75cf/fcda8/image-20200821165543016.png&quot;
        srcset=&quot;/static/060268011afb8e4532229126b3df75cf/12f09/image-20200821165543016.png 148w,
/static/060268011afb8e4532229126b3df75cf/e4a3f/image-20200821165543016.png 295w,
/static/060268011afb8e4532229126b3df75cf/fcda8/image-20200821165543016.png 590w,
/static/060268011afb8e4532229126b3df75cf/cab43/image-20200821165543016.png 755w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ce57df9c0c463f71e915e7799df91ab2/17a7a/image-20200821165446947.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 74.32432432432432%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAB50lEQVQ4y4VTWXbjMAzLOSZeZGuxZHmLneS1vf+9WIKSUs+08/qBB5mOKRBELtP2pPX5Qdvjne7HjebZU1gW6rWha1VRVdeCOvMZdUbTNC++tErRGGd6Hgdt3tHC2MeBJmfIm14w6I50p4QDP4dcN1w7N5OGcuBCr1qaB0N7cPSMnj6WQAc3jlZLHRcAy2CFne5Jte3PDdvygrF5Sxs3neVjI883Bi7CeXaaVq7jkjaLKc3+aghgrBt/OLIq23fkGKrnc1xJjzPZaRM21sr4+ObsL/jVEAWMd4+DKDtGJ8oiK4XiffS0sr+3MLA6KyO7fCm8hADTq9QQXsDksggo1bws+NoxtGpzLTHqvdTV6xln/PaicOjQPY1wrWr6w3G5CurMHJ/T+Xp6/33kluX6iaZtp+A9e5MiUUbASLZPKsCOvRsydI7ND0tpyPMP4Bmi8jYHic3OPgb2Fd4Gkxi2RJeWBqtEXfUV8NdS6syIRwE2vvICDuYHLwuLklhllHBjqpLnb7G5j4NkTEZnGMOLmlca4kJ+WjlCCzk/UtCdqEQWu6L039iMPNYjIh42xYaVSWw4MnsMtAawl78nLMCFydsSHfXVEIqKsi7HAqxaKGjSc2F5nxYFHwsDF0RGd2lr6pT8/+G39585i6YVZ9U4SAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image-20200821165446947&quot;
        title=&quot;image-20200821165446947&quot;
        src=&quot;/static/ce57df9c0c463f71e915e7799df91ab2/fcda8/image-20200821165446947.png&quot;
        srcset=&quot;/static/ce57df9c0c463f71e915e7799df91ab2/12f09/image-20200821165446947.png 148w,
/static/ce57df9c0c463f71e915e7799df91ab2/e4a3f/image-20200821165446947.png 295w,
/static/ce57df9c0c463f71e915e7799df91ab2/fcda8/image-20200821165446947.png 590w,
/static/ce57df9c0c463f71e915e7799df91ab2/17a7a/image-20200821165446947.png 753w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;实在是让人赏心悦目&lt;/p&gt;
&lt;h2&gt;Qz PC &amp;#x26; Mall PC&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;引入整个 antd bundle&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/054f1e337d0f5c357710e8e0c6f5754c/a4262/image-20200821165606271.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 61.48648648648649%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAACbklEQVQozzVT2W7bMBD0//9PWzQt0JxN4jPxIduND9k6KEriIUpW5ADNdCSjD4PdHXJJ7s6yV5sp5PERedRHFg6Qhn2oeIw0uMTJsY/I7yPYPkIGQ+4bcP8T15+R+G0euXiCJByjqfboVdrj5gcU2QxOLWHSOWy2uNh8AZ3OoOQMuZiSn6NUlzVDvkWRe5c489CUOx5op4h2d3xVH1qMeNsARk5oh1Bi2L1YhkPEhyeohOtigCxuOb4yfOZDXslPkIkXfNQ+eqfDFPHbEFYsUaRvsMkfWHmxRqyh4xVUtIQNPZTBAnVE2/rkHNccczT9nNxJseQyFBBBBBHGRITQPxIHRIcAqZBI4wQ616hNAVQnoG6A5gOf5Qln69i3muUq5DJD7SoeqOeQYsXkJSRvF+G8Qxsn4ayDTtco7R5G+7DGR2EOUPkOKtsiTzdQhGF8fpfo1QUP6vrU9mbE5ClSKucUmy4ZJ0Ni1HFpNIKg6vGRCnO/4CSIYMBqGNP/eKcodcoEjo1lg0/yBRUb7ChIiyK6wPGiE5WvMvZNLlCm7GG66PwiofK0jV7h021Y8vonkskVxPgb1OwK2eQL8pev0LPvMPMfKNc3MN417OoOZnkPtbiB9m472NV9Z/PZL9jNb5zHV1Q5fIDZcYGjU/gPsHv629sOanNNe9PBsTTH4TWHAWwwgj2yMvoFuTKaoE5e8Vd5LLncw+otnN110Nm6s5XboyzImQ0FYVz4aBqJho1v7fm//57AuYBiHcgnfKGlSsLjxHPu5IoD3f6CFX/EBpXZ4kR1nXpDxUsrvWG8Q0mlVbqlsvvOBv68w6kI8A9PJW6Zz+Bn1wAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image-20200821165606271&quot;
        title=&quot;image-20200821165606271&quot;
        src=&quot;/static/054f1e337d0f5c357710e8e0c6f5754c/fcda8/image-20200821165606271.png&quot;
        srcset=&quot;/static/054f1e337d0f5c357710e8e0c6f5754c/12f09/image-20200821165606271.png 148w,
/static/054f1e337d0f5c357710e8e0c6f5754c/e4a3f/image-20200821165606271.png 295w,
/static/054f1e337d0f5c357710e8e0c6f5754c/fcda8/image-20200821165606271.png 590w,
/static/054f1e337d0f5c357710e8e0c6f5754c/a4262/image-20200821165606271.png 814w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;明明在 console 已经说了不要引入整个 antd 包, 但是依然整个包引入了. 公司原本使用自己的组件库, 貌似放弃了, 转而使用 antd-vue 了. 之后应该自己魔改了. 不过看了看 antd-vue 的代码貌似是全程使用 render + jsx. 这魔改难度略大. 毕竟这个 antd-vue 的版本就是 antd 魔改出来的.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;全局风格&lt;/p&gt;
&lt;p&gt;全局风格的实现在我看来也是相当下饭的操作. 使用内联 style 的架构. 风格效果全靠覆盖. 怎么, 大家是没听过 css-in-js 还是咋地. 以后每新建一个模块都要使用 window.globalcolor 来设置颜色和其他东西. 我谢谢你.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;没有使用任何 state management 框架, 改数据全靠在全局变量上改.&lt;/p&gt;
&lt;p&gt;我…都上 vue 了, 上 vuex 能把你咋地. 导致代码耦合已经相当严重. 到处都引用全局变量卧槽. 当然在其他项目这个也中招了. 数据保护不存在的, 想怎么改就怎么改.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;utils 只有一个文件, 目前已超过 10000+行. utils 和 api 全放这了, 这个文件能不大? 另外作为 utils 函数你不注释, 你是写给自己用的吗&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Qz 小程序&lt;/h2&gt;
&lt;p&gt;迭代有些问题, 版本管理不是很明确, 这玩意在手机中常常会占用非常多的内存, 常常一打开就飙到 600m+, 要知道小程序的上限貌似只有 1G. 没仔细研究过代码, 按道理说不应该能占用这么多内存的. 可能是因为大量的 component 创建导致的. 另外需求也是不是很合理, 例如视频列表, 地图列表等, 其实是不应该可以插入多个这样的模块的. 这个项目 api 编写不是很规范, 而且里面有些异步代码没有回调, 没有考虑到连锁的异步场景, 典型的是登录的模块, 代码那是比较不科学. 状态管理的缺失也导致我开发全局订阅事件这样的库. 里面很多黑科技. 不过在公司众多项目中代码算是比较中规中矩了.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Miniprogram Transformer Review: javscript parser 应用]]></title><description><![CDATA[前言 我们组从小程序推出的开始就一直在小程序相关的业务，一直到现在大概…]]></description><link>https://pakholeung37.github.io/Miniprogram Transformer Review javscript parser 应用/</link><guid isPermaLink="false">https://pakholeung37.github.io/Miniprogram Transformer Review javscript parser 应用/</guid><pubDate>Thu, 22 Oct 2020 10:32:00 GMT</pubDate><content:encoded>&lt;h2&gt;前言&lt;/h2&gt;
&lt;p&gt;我们组从小程序推出的开始就一直在小程序相关的业务，一直到现在大概 3 年时间，这几年时间里面， 小程序语法添加了一些新特性, 也出现很多新的框架. 但是, 我们的小程序依然维持在一个非常原始的状态. 而现在必须考虑到迁移的问题.&lt;/p&gt;
&lt;h2&gt;现状&lt;/h2&gt;
&lt;p&gt;先来谈谈目前项目的组成, 除了基本的 Component, Page, 还有一些混合 Component 的开发模式. Component, Page 其实都比较好理解, 关键是混合开发. 这类混合模式的特点在于, 看起来像一个组件, 但是其实不是.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;// /component1
component1.wxml
component1.wxss
component1.js&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;看起来很像一个组件是不是, 但其实不是. wxml 里面其实是一个 wx template, js 是用别的方式直接混入到 Page 对象,&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;Page&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;asign&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; component1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;css 是直接在全局 css 中 import 依赖的. 即 template 中的方法不是来自于组件本身, 而是来自于 Page 对象的. 拥有这种模式是因为在小程序的初期是不支持自定义组件的, 所以这种模式则被继承了下来, 并逐步扩大到大量的组件.至此, 某类组件都使用这种开发模式.&lt;/p&gt;
&lt;p&gt;如果要迁移到 uniapp, 则必须要解决一个问题, 怎么将这种模式转换到 uniapp 中.&lt;/p&gt;
&lt;h2&gt;目标&lt;/h2&gt;
&lt;p&gt;其实在这此前, 我已经做过一个基本一样的需求, 那时候没有考虑到 ast 转换的问题, 都是基本纯手写 + string replace 来修改原有的项目. 同时在重构的过程中, 暴露出了很多问题. 第一, 迁移的过程中开发的需求, 为了不影响线上的小程序, 我们必须在旧的小程序写一套, 然后又在新的小程序上写一套. 第二, 因为基本上是重构, 没有办法做覆盖性测试, 在上线之后暴露出很多问题. 然后开始思考有什么办法能做的更好, 然后就想到了 codemod, babel,开始萌生构建 ast 转换器的想法. 基于此搭建的转换器, 需要满足的基本需求是, 必须不影响线上功能的情况下, 完成迁移, 要么一步到位, 要么转换可以渐进式地进行, 仅通过转换器加快迁移效率.&lt;/p&gt;
&lt;h2&gt;原理&lt;/h2&gt;
&lt;p&gt;先来看看组件.
一个完整的 Component 形式的小程序组件转换到 vue 语法完整的过程包括, 将 wxml 转换成对应的 vue template, 将 wx component js 代码转换成 vue component js 代码, 然后最后将 template, js, css 拼接起来. template 转换和 js 转换, 说白了就是 ast 转换. 使用 parser 将 wxcomponent 解析成 ast, 再转换成 vuecomponent 对应的 ast, 最后转换回最终的代码.&lt;/p&gt;
&lt;h2&gt;方案&lt;/h2&gt;
&lt;p&gt;一开始使用&lt;a href=&quot;https://github.com/zhangdaren/miniprogram-to-uniapp&quot;&gt;miniprogram-to-uniapp&lt;/a&gt;进行转换, 但是发现了一些问题, 最大的问题是这个库使用的 htmlparser2 这个库对 wxml 进行转换. 但是这个库并不能有效对一些语法进行有效的解析. 转换的问题.&lt;/p&gt;
&lt;h2&gt;结语&lt;/h2&gt;
&lt;p&gt;虽然这次转换器只实现了其中一部分, 但是其中的调研, 思考, 实践也让我成长了很多&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Tree Component code review: 从构建一个组件看react最佳实践]]></title><description><![CDATA[Storybook 实践 使用 Storybook 加速开发测试 Hooks 应用 RenderProps State 管理]]></description><link>https://pakholeung37.github.io/Tree Component code review 从构建一个组件看react最佳实践/</link><guid isPermaLink="false">https://pakholeung37.github.io/Tree Component code review 从构建一个组件看react最佳实践/</guid><pubDate>Thu, 22 Oct 2020 10:32:00 GMT</pubDate><content:encoded>&lt;h2&gt;Storybook 实践&lt;/h2&gt;
&lt;h2&gt;使用 Storybook 加速开发测试&lt;/h2&gt;
&lt;h2&gt;Hooks 应用&lt;/h2&gt;
&lt;h2&gt;RenderProps&lt;/h2&gt;
&lt;h2&gt;State 管理&lt;/h2&gt;</content:encoded></item><item><title><![CDATA[不同操作系统下的node路径]]></title><link>https://pakholeung37.github.io/不同操作系统下的node路径/</link><guid isPermaLink="false">https://pakholeung37.github.io/不同操作系统下的node路径/</guid><pubDate>Sun, 27 Sep 2020 15:14:00 GMT</pubDate><content:encoded></content:encoded></item><item><title><![CDATA[我是如何重构fabric.js的]]></title><description><![CDATA[本文将记录我在重构 fabric.js 的思考和实践 ps: 由于项目 canvas 库从 fabric.js 迁移到 konva, 相关重构工作已停止. 动机 在进行 twilight…]]></description><link>https://pakholeung37.github.io/我是如何重构fabricjs的/</link><guid isPermaLink="false">https://pakholeung37.github.io/我是如何重构fabricjs的/</guid><pubDate>Wed, 23 Sep 2020 16:00:00 GMT</pubDate><content:encoded>&lt;p&gt;本文将记录我在重构 fabric.js 的思考和实践&lt;/p&gt;
&lt;p&gt;ps: 由于项目 canvas 库从 fabric.js 迁移到 konva, 相关重构工作已停止.&lt;/p&gt;
&lt;h2&gt;动机&lt;/h2&gt;
&lt;p&gt;在进行 twilight 项目编写的时候, 我就有意在寻找一些库, 作为我编辑器的底层库调用. 在浏览了一些库以后, 最终选择了 &lt;a href=&quot;fabricjs.com&quot;&gt;fabric.js&lt;/a&gt; 作为编辑器的底层. 这个库点赞过 10k, 稳定, 快. 没有外部依赖, 基本是基于原生 canvas 等一系列 browser api 进行编写. 足够接近底层, 单元测试接近完整. 而且原生带有互动层, 可以减少我再建模的时间和精力. 但是, 这个库是在 08 年编写, 以现今前端技术栈来看, 或多或少存在一些问题: 使用 iife 构建模块, 没有模块管理. 所以, 缺少 tree-shaking. 只能通过全局初始化, 对 esm 导入不利. 另外就是打包太大, 把以及一些不必要的工具函数打包进来. 基于 prototype 的类模型也不够直观, 并且难以调试. 所以, 在种种历史问题下, 我决定尝试以下重构该项目.&lt;/p&gt;
&lt;h2&gt;目标&lt;/h2&gt;
&lt;ul&gt;
&lt;li class=&quot;task-list-item&quot;&gt;&lt;input type=&quot;checkbox&quot; checked disabled&gt; modern frontend workflow (rollup + eslint + prettier + babel)&lt;/li&gt;
&lt;li class=&quot;task-list-item&quot;&gt;&lt;input type=&quot;checkbox&quot; checked disabled&gt; migrate to esm&lt;/li&gt;
&lt;li class=&quot;task-list-item&quot;&gt;&lt;input type=&quot;checkbox&quot; disabled&gt; tree shaking&lt;/li&gt;
&lt;li class=&quot;task-list-item&quot;&gt;&lt;input type=&quot;checkbox&quot; disabled&gt; modern es6+ syntax (especially class)&lt;/li&gt;
&lt;li class=&quot;task-list-item&quot;&gt;&lt;input type=&quot;checkbox&quot; disabled&gt; heavy utils external&lt;/li&gt;
&lt;li class=&quot;task-list-item&quot;&gt;&lt;input type=&quot;checkbox&quot; disabled&gt; plugin system&lt;/li&gt;
&lt;li class=&quot;task-list-item&quot;&gt;&lt;input type=&quot;checkbox&quot; disabled&gt; excellent performance&lt;/li&gt;
&lt;li class=&quot;task-list-item&quot;&gt;&lt;input type=&quot;checkbox&quot; disabled&gt; typescript support&lt;/li&gt;
&lt;li class=&quot;task-list-item&quot;&gt;&lt;input type=&quot;checkbox&quot; checked disabled&gt; migrate test framework to jest&lt;/li&gt;
&lt;li class=&quot;task-list-item&quot;&gt;&lt;input type=&quot;checkbox&quot; disabled&gt; independent fabric config&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;引入现代前端工作流&lt;/h2&gt;
&lt;p&gt;在重构工作的开始, 需要先将整个项目引入到新的工作流当中. 引入新的工作流目可以为整个重构工作达成事半功倍的效果. 例如隔离模块变量, 如果没有静态代码检查, 将很难发现全局变量. 原项目的工作流当中, 是使用 eslint + raw scripts 的方式做代码检查和打包. eslint 是必须的, 这部分我只是将他升级到最新的版本, 并且将它替换到我顺手的 config. 原来的打包是 iife + raw script, 这部分则用 rollup 来替换, 在最开始的时候只需要将原来的 iife import 进入口文件, 就可以了, 这部完成后, 就可以进行 esm 的工作.&lt;/p&gt;
&lt;h2&gt;重构成 esModule&lt;/h2&gt;
&lt;p&gt;在完成 workflow 迁移以后, 首要的工作是将整个工程重构成 esm. 在原来的架构中, 模块脚本在第一次载入运行的代码过重, 运行上下文重度依赖于当前脚本的执行顺序.而且这种结构无法做 tree shaking, 我的想法是将整个项目做成一个库的形式, 只需要导入用到的代码就好了, 将上下文限制在脚本文件内部, 而不是依赖于全局, 方便压缩导入后的体积. 所以首要目标是将整个项目重构成 esm. 在重构的过程中, 遇到的最棘手的问题, 便是循环依赖引用. esm 和 cjs 是完全不一样的模块系统, 在 cjs 中, 模块的加载是同步的, 在 require 的时候就会立即运行 cjs 模块, 然后生成一个模块引用, 也就是说, 当执行类似&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; path &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;path&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;的代码的时候, 这个 path 的引用其实已经是完整的模块引用, 再往后就不会再调用这个模块的任何脚本, 而是使用已经在 cjs 模块 cache 中的”path”模块引用.对于 esm, 情况要更复杂一些. 在标准当中, 只规定了模块是如何获取, 执行. 但是并没有规定脚本执行的时机&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Blocking the main thread like this would make an app that uses modules too slow to use. This is one of the reasons that the ES module spec splits the algorithm into multiple phases. Splitting out construction into its own phase allows browsers to fetch files and build up their understanding of the module graph before getting down to the synchronous work of instantiating.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://hacks.mozilla.org/2018/03/es-modules-a-cartoon-deep-dive/&quot;&gt;ES modules: A cartoon deep-dive&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;尽管我使用了 esm 来编写我的模块, 但是当使用 rollup 打包的时候, 就会发现很不对劲.&lt;/p&gt;
&lt;p&gt;在面对 esm 循环引用的部分, rollup 显得有些力不从心.&lt;/p&gt;
&lt;p&gt;问题总是出现在脚本第一次调用的地方. 而不是在 event loop 中, 在脚本第一次被调用的时候, 所引用的依赖必须是初始化完成的. 但是 rollup 打包出来的 chunk 是没有 module 的概念的, 所以模块打包的先后顺序就显得尤为重要.&lt;/p&gt;
&lt;p&gt;解决这种问题的方法无非就两种: 调整打包顺序 或 移除首次加载时需要用到外部依赖的代码.&lt;/p&gt;
&lt;p&gt;在原项目中, 最大的问题是运行时继承. 每一个&lt;code class=&quot;language-text&quot;&gt;*.class.js&lt;/code&gt;文件都涉及到运行时继承, 第一次载入脚本就需要执行继承的代码. 导致依赖于父类的类的打包顺序必须在父类之后. 这点通常是可以保证的. 但是在循环引用的状况下则无办法保证. 在将 class 改造成 es6 class 之前, 这部分是不能动的. 那么只能将在 eventloop 中的依赖保留自运行时依赖. 这样, 可在打包阶段暂时解决这个问题.&lt;/p&gt;
&lt;p&gt;我的测试方法是, 直接运行一次打包文件, 通常而言, 如果依赖为空, 必定会引发 error, 可排除大量因打包顺序引发的错误.&lt;/p&gt;
&lt;h2&gt;迁移到 jest&lt;/h2&gt;
&lt;p&gt;原项目使用的 qunit 是 Jquery 的官方测试库, 但是过于老旧. 考虑到未来测试的扩展性和易用性, 并行测试等等, 还是将 qunit 迁移到 jest 上.&lt;/p&gt;
&lt;p&gt;这里需要用到 jest 官方的测试转换库&lt;a href=&quot;https://github.com/skovhus/jest-codemods&quot;&gt;jest-codemods&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Codemods that simplify migrating JavaScript and TypeScript test files from &lt;a href=&quot;https://github.com/avajs/ava&quot;&gt;AVA&lt;/a&gt;, &lt;a href=&quot;https://github.com/chaijs/chai&quot;&gt;Chai&lt;/a&gt;, &lt;a href=&quot;https://github.com/Automattic/expect.js&quot;&gt;Expect.js (by Automattic)&lt;/a&gt;, &lt;a href=&quot;https://github.com/mjackson/expect&quot;&gt;Expect@1.x (by mjackson)&lt;/a&gt;, &lt;a href=&quot;https://github.com/jasmine/jasmine&quot;&gt;Jasmine&lt;/a&gt;, &lt;a href=&quot;https://github.com/mochajs/mocha&quot;&gt;Mocha&lt;/a&gt;, &lt;a href=&quot;https://github.com/thlorenz/proxyquire&quot;&gt;proxyquire&lt;/a&gt;, &lt;a href=&quot;https://github.com/tj/should.js/&quot;&gt;Should.js&lt;/a&gt; and &lt;a href=&quot;https://github.com/substack/tape&quot;&gt;Tape&lt;/a&gt; to &lt;a href=&quot;https://facebook.github.io/jest/&quot;&gt;Jest&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;可以比较方便地将 qunit 迁移到 jest 上. 虽然说明上并没有说支持 qunit, 但是说实话, 所有的测试库 api 其实大同小异. 很简单就可以找到相对兼容, 能转换的转换器. 在我测试下来, Chai 是一个理想的转换器. 转换步骤大地如下&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;使用转换器转换成 jest&lt;/li&gt;
&lt;li&gt;引入打包后的文件&lt;/li&gt;
&lt;li&gt;将 Qunit.module 改成 describe, 并将所有 test 移到此方法下&lt;/li&gt;
&lt;li&gt;将 aferEach 方法迁到顶级&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这里其实还有些问题, unit test 应当是使用源码作为 unit 测试, 而非打包后的文件, 这部分需要以后再作优化. 但是其实问题不大.&lt;/p&gt;
&lt;p&gt;这里有几个注意点,&lt;/p&gt;
&lt;p&gt;首先是在原项目 Qunit 中使用最多的&lt;code class=&quot;language-text&quot;&gt;equal&lt;/code&gt;和&lt;code class=&quot;language-text&quot;&gt;deepEqual&lt;/code&gt;, 以及相对应的 Jest &lt;code class=&quot;language-text&quot;&gt;toEqual&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;toBe&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;equal&lt;/code&gt;相当于&lt;code class=&quot;language-text&quot;&gt;==&lt;/code&gt;, 而 Jest 没有相对应的接口, 只能使用更严格的&lt;code class=&quot;language-text&quot;&gt;toBe&lt;/code&gt;, 相当于&lt;code class=&quot;language-text&quot;&gt;===&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;而&lt;code class=&quot;language-text&quot;&gt;deepEqual&lt;/code&gt;相当于&lt;code class=&quot;language-text&quot;&gt;==&lt;/code&gt;的递归版本, Jest 也是没有相对应的接口, 只能使用&lt;code class=&quot;language-text&quot;&gt;toEqual&lt;/code&gt;, 相当于&lt;code class=&quot;language-text&quot;&gt;===&lt;/code&gt;的递归版本&lt;/p&gt;
&lt;p&gt;开始依靠 codemods, &lt;code class=&quot;language-text&quot;&gt;equal&lt;/code&gt;和&lt;code class=&quot;language-text&quot;&gt;deepEqual&lt;/code&gt;都转换成&lt;code class=&quot;language-text&quot;&gt;toEqual&lt;/code&gt;了, 这个方法原本没有什么问题, 出问题是在 Object 比较上. 因为&lt;code class=&quot;language-text&quot;&gt;toEqual&lt;/code&gt;可以递归比较对象, 但是&lt;code class=&quot;language-text&quot;&gt;equal&lt;/code&gt;只是简单对比对象的引用值. 所以这部分只能手动再改回来.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[uni-app h5端打包优化]]></title><description><![CDATA[前言 webpack 打包优化的话题已是老生常谈, 这次则将以一次完整的实践讨论打包优化方式, 规则选择等. Tree Shaking 这里谈到的 tree shaking, 是在 uni-app 规则下的 tree shaking. 和普通的 tree shaking…]]></description><link>https://pakholeung37.github.io/uni-app h5端打包优化/</link><guid isPermaLink="false">https://pakholeung37.github.io/uni-app h5端打包优化/</guid><pubDate>Fri, 14 Aug 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;前言&lt;/h2&gt;
&lt;p&gt;webpack 打包优化的话题已是老生常谈, 这次则将以一次完整的实践讨论打包优化方式, 规则选择等.&lt;/p&gt;
&lt;h2&gt;Tree Shaking&lt;/h2&gt;
&lt;p&gt;这里谈到的 tree shaking, 是在 uni-app 规则下的 tree shaking. 和普通的 tree shaking 不同的是, uni-app 在 tree-shaking, 特别是组件的摇树优化方面是不同的, 详细的摇树原理请参阅&lt;a href=&quot;https://ask.dcloud.net.cn/article/36279&quot;&gt;https://ask.dcloud.net.cn/article/36279&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// manifest.json&lt;/span&gt;
&lt;span class=&quot;token property&quot;&gt;&quot;h5&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;optimization&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;treeShaking&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;enable&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;import &amp;#x26; require&lt;/h3&gt;
&lt;p&gt;import 和 require 在摇树优化上有很大的区别. 只有通过 es6 export … 的方式导出的模块才能进行摇树处理, cjs 是不能通过摇树处理的, 另如果 esm 中有副作用的代码, 则也会导致摇树失败. 在本次项目中由于历史原因有很多 cjs, esm 甚至在同一个文件中 import export require module.exports 混用的四不像. 我做的第一步, 就是把这些模块都规范化, 统一转换成 esm, 如果是库, 则可以转换成 cjs. 总之, 处理最基本原则是不能 cjs, esm 混用, 有时候看起来能用的代码, 其实只是碰巧能用&lt;a href=&quot;https://juejin.im/post/6844904114183208968&quot;&gt;干货:import 和 require 如何在项目中混用&lt;/a&gt;. esm 是目前也是未来的标准, 力所能及地转换成 esm, 即为未来摇树做准备.&lt;/p&gt;
&lt;p&gt;设置完成后还需要设置 babel-&gt;modules 一项 &lt;a href=&quot;https://github.com/vuejs/vue-cli/tree/dev/packages/%40vue/babel-preset-app&quot;&gt;@vue/babel-preset-app&lt;/a&gt; &lt;a href=&quot;https://babeljs.io/docs/en/babel-preset-env#modules&quot;&gt;babel - preset-env - modules&lt;/a&gt;, 原来的 cjs 选项会使 babel 将所有模块当作 cjs 对待, 自然没有摇树. auto 则会依据文件内部的一些语法判定到底使 cjs 还是 esm, 一般而言, 只要调用 require 则会被当做 cjs 对待. 这里设置 auto 则可&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  presets&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;@vue/app&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        modules&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; process&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;env&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;UNI_PLATFORM&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;h5&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;auto&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;cjs&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 这个值会直接传到@babel/preset-env&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  plugins&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;babel polyfill&lt;/h3&gt;
&lt;p&gt;现代浏览器其实并不需要 babel, 更不需要 babel polyfill, 引入完整的 babel polyfill 可为项目带来 200+K 的体积增长, 在 babel.config.js 中可配置此项. 将 modules 设置为 false 则不会引入 polyfill.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  presets&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;@vue/app&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// false when building with webpack&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;//&apos;commonjs&apos; when running tests in Jest.&lt;/span&gt;
        useBuiltIns&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; process&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;env&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;UNI_PLATFORM&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;h5&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;usage&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;entry&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  plugins&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;公共组件&lt;/h2&gt;
&lt;p&gt;真正大幅减少 bundle 总体积的操作是需要提取公共的组件, 我当前项目为例, 未提取之前, bundle 总体积为 22mb 左右, 这部分其实要通过配置 splitChunks 来进行自定义分包优化. 在默认配置中, common 包是所谓代码总包存在的, 一般而言, chunk-vendor 会打包 node_modules 内的文件, 而 chunk-common 则打包 src 内的文件. 但是有例外, 重点在于 common 包中的 chunks 配置. &lt;a href=&quot;https://webpack.js.org/plugins/split-chunks-plugin/#optimizationsplitchunks&quot;&gt;webpack documentation - splitChunks&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// vue.config.js&lt;/span&gt;
module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  configureWebpack&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    optimization&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;// 默认配置&lt;/span&gt;
      splitChunks&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        cacheGroups&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          common&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            chunks&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;initial&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            minChunks&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            priority&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这个配置的意思是打包非异步的文件, 这与 vue-router 的一般引入方式不能自洽. 总所周知, vue-router 为了分开页面, 提高加载速度, 一般会建议使用懒加载来载入页面, 而这种写法就是异步模块.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&quot;path&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;pages/abde/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这种配置方案, 会使得 webpack 在打包的时候, 分开页面进行打包, 但是, 也正因为如此, 这样打包不会重复利用已打包的模块, 会将公共的组件重复打包. 所以用这种方案打包后, 体积非常大, 而且页面切换的网络开销, 运算开销也非常大, 没有最大限度的运用已加载的资源. 因此需要再配置一个公共组件的分包, 不管异步还是同步, 统统打包进来. 通过这种方案, 我将打包体积降低到了 4mb 大小. 另外由于公共组件在一个包中而不是在几个页面包中重复定义, 所以在切换页面的时候, 可以载入更小的页面包, 达到更快的加载速度的目的.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;configureWebpack&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    optimization&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      splitChunks&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        cacheGroups&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          commonComponents&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            name&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;chunk-common-component&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            test&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token regex&quot;&gt;/src\/components/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            chunks&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;all&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            minChunks&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// 只有引用超过10次的组件才打进此包&lt;/span&gt;
            maxSize&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;500000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// 因为公共组件也很大, 所以限制打包大小为500K&lt;/span&gt;
            priority&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;// 优先级11, 先进行此分包操作&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          components&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            name&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;chunk-component&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            test&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token regex&quot;&gt;/src\/components/&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            chunks&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;all&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            minChunks&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// 只有引用超过4次才打进此包&lt;/span&gt;
            maxSize&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;500000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// 由于公共组件很大, 允许最大打包大小为500K&lt;/span&gt;
            reuseExistingChunk&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// 重复利用已存在的包&lt;/span&gt;
            priority&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          common&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            chunks&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;initial&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            minChunks&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            priority&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;CSS&lt;/h2&gt;
&lt;p&gt;一种降低 js 体积, 提高解析速度的方法是进行 css 提取, 本来 vue-cli 项目是可以依靠 css.extract 参数在生产环境下实现 css 提取, 单独加载的. 但是官方直接覆盖了这个设置, 说明是 uni-app 有依赖到 css 运行时, 所以不允许提取独立的 css&lt;a href=&quot;https://github.com/dcloudio/uni-app/issues/148&quot;&gt;#148&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;删除没用的代码&lt;/h2&gt;
&lt;p&gt;这点我觉得是很多前端都不注重, 但是是最能减少打包体积的一种方法. 养成良好的编程习惯, 就可以有效减少扯皮, 减少 bug, 提高幸福感, 顺便减低打包体积.&lt;/p&gt;
&lt;p&gt;向我们团队, 本次项目是从旧项目迁移过来的, 很多代码是直接 copy 原来的代码, 更有些代码是从别的目录直接复制的, 美其名曰留副本. 我实在不知道, 你要这样留副本, 那要 git 来干嘛. 而且很多代码中也是直接注释, 明明已经没用的代码, 直接删除不就好了.&lt;/p&gt;
&lt;p&gt;更重要的是不要引入无关的依赖, 项目中很多模块引入一些不必要的模块, 除了徒增体积毫无用处. 我直接开 eslint, 把这些代码都删掉了. 又有一些旧的代码, 明明已经不用了, 却偏要留着. 杂七杂八删掉这些代码之后, 体积也有个几百 k 的提高, 还是可以的, 更重要的是可以提高幸福感, 看着一个几千行的文件, 实际只有几百行有用的代码, 换谁都受不了吧.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[uni-app 最佳实践]]></title><description><![CDATA[__call_hook uni-app 在构建的时候注入的一个方法, 可以直接调用生命周期函数, 这是因为 uniapp 自身定义了很多生命周期, 需要在额外的地方调用, 所以也暴露了这个接口. 这个接口强大的地方在于还可以调用那些非生命周期, 但是挂载到 vue…]]></description><link>https://pakholeung37.github.io/uni-app 最佳实践/</link><guid isPermaLink="false">https://pakholeung37.github.io/uni-app 最佳实践/</guid><pubDate>Wed, 12 Aug 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;__call_hook&lt;/h2&gt;
&lt;p&gt;uni-app 在构建的时候注入的一个方法, 可以直接调用生命周期函数, 这是因为 uniapp 自身定义了很多生命周期, 需要在额外的地方调用, 所以也暴露了这个接口. 这个接口强大的地方在于还可以调用那些非生命周期, 但是挂载到 vue 声明对象上的方法&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;vue&quot;&gt;&lt;pre class=&quot;language-vue&quot;&gt;&lt;code class=&quot;language-vue&quot;&gt;// index.vue
&amp;lt;script&amp;gt;
export default {
  onShareAppMessage() {
    console.log(&amp;quot;share shit&amp;quot;)
  },
}
&amp;lt;/script&amp;gt;

// anywhere.js imoprt index from &amp;quot;index.vue&amp;quot;; const component = new
Vue.extend(index); component.__call_hook(&amp;quot;onShareAppMessage&amp;quot;, { form: &amp;quot;fav&amp;quot; });&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;h5 端 css 强制 scoped&lt;/h2&gt;
&lt;p&gt;在这个 issue 中指出, h5 是强制开启 scoped CSS 的, 不论 style 是否填 scoped&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/dcloudio/uni-app/issues/1095&quot;&gt;https://github.com/dcloudio/uni-app/issues/1095&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;在另一篇官方 issue 中, 也讨论过如何关闭强制 scoped&lt;a href=&quot;https://github.com/dcloudio/uni-app/issues/327&quot;&gt;#327&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;chainWebpack&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;webpackConfig&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    webpackConfig&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;rule&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;vue&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;uses&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;delete&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;uniapp-h5-style-scoped&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 源issue写的是uniapp-scoped 但是看源码已经改了&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;source maps&lt;/h2&gt;
&lt;p&gt;这里可能只适用于一些适用了 yarn workspace 的人, 我在安装了 yarn workspace 后发现, 在 workspace 的项目在开发调试中丢失了 source map, 导致调试子项目非常的艰难, 所以我在开发时候的 webpack 配置中, 将这个 evalSourcemapDevToolPlugin 的配置又加了上去, 非常奇妙的是, 这部分代码我是直接抄 uni-app 的官方配置的, 一点都没有改, 然后新的配置 work fine, 也没有和久的配置冲突, 感觉有点不可思议.&lt;/p&gt;
&lt;h2&gt;preprocess-loader&lt;/h2&gt;
&lt;p&gt;官方文档阐述了条件编译的用法, 但是没有说明使用条件编译的库. 在源码中可以查证到, uni-app 是使用 &lt;a href=&quot;https://github.com/jsoverson&quot;&gt;jsoverson&lt;/a&gt;/&lt;a href=&quot;https://github.com/jsoverson/preprocess&quot;&gt;preprocess&lt;/a&gt; 这个库来实现条件编译的. 这说明两个问题, 1. 条件编译是生效在 webpack 构建阶段, 并且是在 html, js, css, json 中使用 comment 来生效. 第二点, 这个库不止实现的条件, 还实现了诸如 for each, include, exclude, echo 等模板行为. 而 uni-app 官方只宣称了条件编译. 实际上是一个优秀的模板引擎.&lt;/p&gt;
&lt;h2&gt;dataSet&lt;/h2&gt;
&lt;p&gt;在传统的小程序中习惯使用 dataSet 来回传数据&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;vue&quot;&gt;&lt;pre class=&quot;language-vue&quot;&gt;&lt;code class=&quot;language-vue&quot;&gt;&amp;lt;view bindtap=&amp;quot;buttonClick&amp;quot; data-first=&amp;quot;{{1}}&amp;quot; data-second=&amp;quot;{{2}}&amp;quot;&amp;gt;&amp;lt;/view&amp;gt;

buttonClick(e) { const { first, second } = e.target.dataset; console.log(first,
second) // 1 2 }&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;但是这一点在 h5 中表现变得非常不一致, 在 h5 中, 原本应该是 Number 的值, 变成了 String, 原本应该是 Object 的值变成了[object object], 这使得需要改造所有的接口来完成这个行为. dataset 获取值的方法, 需要完全的废弃.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://segmentfault.com/a/1190000015684864#item-7&quot;&gt;绑定事件传参&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;behaviors&lt;/h2&gt;
&lt;p&gt;在 uni-app 中 behaviors 的作用被 mixins 代替了, 但是有一种情况是特殊的&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;behaviors&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;uni://form-field&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这个值使得一个自定义组件被当成一个 form 组件来对待, 会向自定义组件注入 props: value 和 props: name, 自定义组件切记不能使用这两个特定值作为 data. 这个值会在&lt;code class=&quot;language-text&quot;&gt;&amp;lt;form&amp;gt;&lt;/code&gt; @submit 中回调得到. 尽管这个方法在 uni-app 官方文档中没有被提及, 但是确实可以这样做. 目前已知在微信, 百度, 头条(头条官方文档也没有这个 field, 但是确实可以用)都是有效的.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://uniapp.dcloud.io/component/form?id=form&quot;&gt;小程序注意事项&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;onPageShow&lt;/h2&gt;
&lt;p&gt;在小程序中组件生命周期 ready 被映射成 onPageShow, 但是在实践中发现, 在 h5 端这个 hook 并没有触发. 而且会发现, 相对于小程序页面, h5 会使页面 keep-alive, 但是是 inactive 的, 此时 vue 上相关动画 hook 是不会触发的. 需要以下代码来进行 hack&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token function&quot;&gt;activated&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;__call_hook&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;onPageShow&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;babel&lt;/h2&gt;
&lt;p&gt;优化 babel.config.js 文件里的 @vue/babel-preset-app 支持配置 modules:false ，让打包出来的代码体积更小，运行更快&lt;a href=&quot;https://github.com/dcloudio/uni-app/issues/929&quot;&gt;#929&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[vue 最佳实践]]></title><description><![CDATA[模板 采用 模板应当首选.vue + vue-loader 的组合, 可以提供最佳的代码 lint 体验, 其次在只能使用 inline template…]]></description><link>https://pakholeung37.github.io/vue 最佳实践/</link><guid isPermaLink="false">https://pakholeung37.github.io/vue 最佳实践/</guid><pubDate>Thu, 06 Aug 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;模板&lt;/h2&gt;
&lt;h3&gt;采用&lt;/h3&gt;
&lt;p&gt;模板应当首选.vue + vue-loader 的组合, 可以提供最佳的代码 lint 体验, 其次在只能使用 inline template 下, 最好使用模板字符串, 其次才是字符串拼接, 一来模板字符串有比较好的阅读体验, 不会到处是+号, 二来, 面对特殊字符诸如&amp;#x3C;’&gt;,&amp;#x3C;“&gt;等, 拼接的字符串需要转义, 三来, 大部分的 formatter 都对第二种格式支持不好, format 时会直接丢失原有格式, 不利于代码格式化&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// good:&lt;/span&gt;
template&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;
    &amp;lt;div&gt;
        &amp;lt;div&gt;helloworld&amp;lt;/div&gt;
    &amp;lt;/div&gt;
&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// bad:&lt;/span&gt;
template&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;div&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;div&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;helloworld&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;/div&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;/div&gt;&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;另有 template string in vue 插件, 最大化 inline template 体验, 前提是必须使用模板字符串&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;assets/a0e78ce3-b974-a4ee-c51e-6bf8ac8719e8&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;使用前&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;assets/f53dbfcc-f47c-80bc-7508-9e2efcf3c931&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;使用后&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;assets/5e1673fe-a192-7e9f-a280-daa4285f25d7&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;h2&gt;watch&lt;/h2&gt;
&lt;h3&gt;多个 watch 有同一个函数时, 宜采用 iife 即时创建&lt;/h3&gt;
&lt;p&gt;为避免编写大量重复代码, 应当使用即时函数&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;//good:&lt;/span&gt;
watch&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; watch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;b&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;c&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;watch&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;reduce&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;acc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; cur&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;acc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//watch methods }&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token function-variable function&quot;&gt;otherWatch&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;//bad:&lt;/span&gt;
watch&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// same methods },&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// same methods },&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// same, methods }&lt;/span&gt;
    &lt;span class=&quot;token function-variable function&quot;&gt;otherWatch&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;arrow function&lt;/h2&gt;
&lt;p&gt;如果情况允许, 请使用箭头函数, 而非 that, 另外需要注意在 vue 声明中, methods 是不能使用箭头函数的, 这点与 react 的常规操作不相同. 正常来说应当减少函数的变量的依赖, 若非必要, 不要冗余声明.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// good:&lt;/span&gt;
methods&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;functionA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;functionB&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;functionB&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// do sth }&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// bad:&lt;/span&gt;
methods&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;functionA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; that &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; that&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;functionB&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Vue proterty 顺序&lt;/h2&gt;
&lt;p&gt;遵循一定的 Property 能提高可读性, 也让团队在寻找相应的 property 更快, 排列更加 make sense. 应当遵循以下规则&lt;/p&gt;
&lt;p&gt;[ “template”, “inject”, “props”, “data”, “computed”, “watch”, “methods”, ”&lt;code class=&quot;language-text&quot;&gt;&amp;lt;life-ci&amp;gt;&lt;/code&gt;” ], 这种排列的依据于：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;template 排在头部, 与 vue 文件一致&lt;/li&gt;
&lt;li&gt;跟接着是外部属性&lt;/li&gt;
&lt;li&gt;再然后是内部属性和计算属性&lt;/li&gt;
&lt;li&gt;副作用的计算排在计算属性之后&lt;/li&gt;
&lt;li&gt;methods 内部应当优先排列 dom 相关方法, 如 handleClick 等&lt;/li&gt;
&lt;li&gt;尽量使用 computed 属性, 减少使用 data&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;更高效的 v-bind&lt;/h2&gt;
&lt;p&gt;一个鲜为人知的 vue 技巧, 在 React 中有非常常用 spread props 的技巧, 可以直接解构一个对象映射进子组件的 props.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;// example.jsx &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;Item&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;{{...props}}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;Item&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在 vue 中其实也存在这样的技巧, 在&lt;a href=&quot;https://cn.vuejs.org/v2/api/#v-bind&quot;&gt;官方文档&lt;/a&gt;表述中, v-bind 可以绑定一个对象, 这个对象以结构的形式传进子组件&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;&amp;lt;!-- 绑定一个全是 attribute 的对象 --&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;v-bind&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;{ id: someProp, &apos;other-attr&apos;: otherProp }&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/vuejs/vue/issues/4962&quot;&gt;https://github.com/vuejs/vue/issues/4962&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://cn.vuejs.org/v2/api/#v-bind&quot;&gt;https://cn.vuejs.org/v2/api/#v-bind&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;propsData&lt;/h2&gt;
&lt;p&gt;一个使用 script 生成 vue 对象的技巧, vue component 是声明式的, 他不像 svelte 或 react, 文件即组件, 要初始化一个 vue 组件需要用到一些技巧&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// Component.vue&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    props&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;prop1&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;prop2&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    data&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// some data&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;面对这样一个 vue 组件, 如要使用初始化, 则可以用到&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// root.js&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; Com &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;./Component.vue&quot;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Vue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Com&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这种方法可以生成一个 component 实例, 但是, 这个方法有些缺陷, 例如, 他只能生成一个实例, 这很违反直觉, 第二, 他不能把 props 传进去. 在这里, 就需要用 Vue.extend, 生成一个真正的 Vue 组件. 这个方法可以让组件在生成时, 通过 propsData 把 props 传进去.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// root.js&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; Com &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;./Component.vue&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; Component &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Vue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;extend&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Com&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 生成一个真正的Component组件&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  propsData&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    props1&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;abc&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    props2&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;abcde&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;computed watch 和 副作用&lt;/h2&gt;
&lt;p&gt;基本原则是不要在 computed 中编写有副作用的代码, 如果含有副作用, 请使用 watch 实现.&lt;/p&gt;
&lt;p&gt;我们可以通过一个案例看看这个最佳实践解决了哪些问题&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;vue&quot;&gt;&lt;pre class=&quot;language-vue&quot;&gt;&lt;code class=&quot;language-vue&quot;&gt;// index.vue

&amp;lt;template&amp;gt;
  &amp;lt;div v-for=&amp;quot;item in b&amp;quot;&amp;gt;
    &amp;lt;div @click=&amp;quot;item.click&amp;quot;&amp;gt;&amp;lt;/div&amp;gt;
  &amp;lt;/div&amp;gt;
&amp;lt;/template&amp;gt;
&amp;lt;script&amp;gt;
const a = [
  { click() =&amp;gt; console.log(&amp;quot;hello world&amp;quot;) },
  {}
]
export default {
    data() {
        a: a,
        text: &amp;quot;&amp;quot;,
    }
    computed: {
        b() {
              const text = this.text;
              a.click || a.click = () =&amp;gt; { console.log(text); }
              return this.a;
        }
    }
    mounted() { this.text = &amp;quot;hello world&amp;quot;; }
}
&amp;lt;/script&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上述这个例子中, 可以看到, 从逻辑上看, 是希望点击 div 时, 如果 item 有自己实现的 click, 则使用自己实现的 click, 否则应当是打印出 text 最新的值. 但是事实上并非如此. 无论 text 怎么改变, 都打印出了&quot;&quot;,&lt;/p&gt;
&lt;p&gt;这是因为计算属性 b 一共计算了两次, 第一次时闭包中 text 为 &quot;&quot;, 并且设置了 click, 第二次在 mounted 设置 text 后, 再一次触发 b 计算, 但是这次 click 已经被设置了, 所以没有执行.&lt;/p&gt;
&lt;p&gt;这种含有副作用的计算属性往往结果很难预测, 如果出现问题, 很难去定位到问题到问题出现的地方. 所以正确的做法时怎么样? 正确来说, 不应当在 computed 中使用有副作用的代码. 例如这个例子中, 不应当设置 a.click 这个值, 你应当返回一个新的对象, 以保证每次 computed 的结果都是一样的.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;computed&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;item&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;click&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;item
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;vue remote devtools&lt;/h2&gt;
&lt;p&gt;vue devtools 的 electron standalone 版本, 可以通过监听的方式进行. 不需要浏览器安装相关插件, 非常适合类似微信浏览器这种环境. 另外不要在 wsl 中安装, 需要图形界面, wsl 没有这玩意.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/vuejs/vue-devtools/blob/dev/packages/shell-electron/README.md&quot;&gt;vue-remote-devtools&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;唯一比较费解的是环境变量使用 NODE_ENV = development 致使 devtool 在项目的 console 中不断吐出 info. 需要用 console filter 来过滤.&lt;/p&gt;
&lt;h2&gt;v-if 与 v-show 指令对生命周期的影响&lt;/h2&gt;
&lt;p&gt;先说 v-show，由于 v-show 指令是通过控制元素的 css 属性(display)从而实现显示和隐藏的效果，这也就说无论 v-show 是 true 还是 false,元素都会有初始渲染，且状态改变元素不会导致元素或组件的重新生成和销毁。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;当 v-show 指令附属于普通元素时,v-show 指令状态变化不会影响父组件的生命周期。&lt;/li&gt;
&lt;li&gt;当 v-show 指令附属于组件时，v-show 指令状态变化时，父组件和本身组件的生命周期都不会被影响。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;v-if 就跟 v-show 不太一样了，因为 v-if 状态改变时，是真实进行相关的 dom 操作的(插入和删除)。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;当 v-if 指令附属于普通元素时，v-if 指令状态变化会使得父组件的 dom 发生变化，父组件将会更新视图，所以会触发父组件的 beforeUpdate 和 updated 钩子函数。&lt;/li&gt;
&lt;li&gt;当 v-if 指令令附属于组件时，v-if 指令状态变化对父组件的影响和上一条一致，但是对于本身组件的生命周期的影响是不一样的。&lt;/li&gt;
&lt;li&gt;
&lt;ol&gt;
&lt;li&gt;v-if 从 false 切换到 true 时，会触发 beforeCreate，created，beforeMount，mounted 钩子。 2.v-if 从 true 切换到 false 时，会触发 beforeDestroy 和 destroyed 钩子函数。&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;编程式组件&lt;/h2&gt;
&lt;p&gt;在正常的使用中, vue 推荐的方式都是通过 template 来编写渲染函数, 将各种组件的父子关系, 事件绑定在此阶段定义. 但是, 有时候不可避免需要脱离 template 的限制, 编程式地定义各类组件, 进行挂载, 销毁. 我目前遇到最多使用这种编程式组件的地方是 popup. 一般来说, popup 是使用 vitual dom 中比较尴尬的, 一方面, 你需要 popup mount 在根元素之上, 避免被其他元素覆盖, 遮挡或 css 污染( 最简单就是使用 overflow: hidden ), 而另一方面, 你又需要子组件和 popup 的通信能力. 这种场景你很难通过正常的事件系统来处理. 一种常被认为的最佳实践是使用 portal, 在 react 中拥有官方级别的组件, vue3 也将支持这样的组件. 另一种方法则是使用编程式组件, 动态地声明新的实例. 从而与当前组件( 甚至不一定是组件, 你可以在任何地方使用这种方法 )建立联系 .&lt;/p&gt;
&lt;h3&gt;提前使用$mount 并随后挂载&lt;/h3&gt;
&lt;p&gt;这种方法有点违反知觉, 但是在&lt;a href=&quot;https://cn.vuejs.org/v2/api/#vm-mount&quot;&gt;官方文档&lt;/a&gt;中有所提及. 官方说明, 当不提供 element 而直接使用$mount(), vue 内部会自行创建一个新的 element 并将此 vue 组件依附在其之上. 这种方法我通常使用在唯一组件上.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; el &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; popupInstance &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Vue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;extend&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Popup&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  propsData&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    show&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;$mount&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这样这个组件就完全实例化了, 并且是开始运作的. 进入到 update 周期. 然后你可以随意将该 el append 到任意元素.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;body&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;appendChild&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;popupInstance&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;$el&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;用这种方法好处在于, 一, 该组件可以是全局唯一的, 节省资源. 二, 生命周期完全由你自己控制. 你完全可以在想要的时候直接销毁&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;popupInstance&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;$destroy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;props 响应式&lt;/h3&gt;
&lt;p&gt;之前谈到编程式组件的 props 初始化是传递 propsData, 但是如何改变 props 的值. 查阅了相关资料, 目前已知的一种可行方法, 是直接改变$props&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;popupInstance&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;$props&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;show &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;第一, 改变最初的 propsData 并不会有什么效果, 这一点我已经验证过了, 目前已知的方法只有这个.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[chrome trick]]></title><description><![CDATA[console filter console 的 filter 可以使用正则来过 滤一些不需要的信息. 但是在实践中我发现没办法用 blacklist 来过滤, 尽管使用了/(?!flush)/但是却没有任何效果, 不禁让人感到沮丧. img…]]></description><link>https://pakholeung37.github.io/chrome trick/</link><guid isPermaLink="false">https://pakholeung37.github.io/chrome trick/</guid><pubDate>Thu, 16 Jul 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;console filter&lt;/h2&gt;
&lt;p&gt;console 的 filter 可以使用正则来过&lt;/p&gt;
&lt;p&gt;滤一些不需要的信息. 但是在实践中我发现没办法用 blacklist 来过滤, 尽管使用了/(?!flush)/但是却没有任何效果, 不禁让人感到沮丧.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;assets/eab4ab8f-5b03-9afd-6c3f-8143fc70c58a&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;在查阅资料的过程中发现, filter 可以只是用-[过滤字样]来进行 blacklist 过滤.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;assets/a0c65d50-301c-2ebe-9715-bf2afe55907b&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;整个世界都清净了..&lt;/p&gt;</content:encoded></item><item><title><![CDATA[常用正则表达式]]></title><description><![CDATA[console filter 匹配一段使用字符串拼接 html, 输出拼接后的 html 匹配一个匹配包括下划线, 连接线的任何单词字符并且不以 data 开头的, 以 true 结尾的字段]]></description><link>https://pakholeung37.github.io/常用正则表达式/</link><guid isPermaLink="false">https://pakholeung37.github.io/常用正则表达式/</guid><pubDate>Thu, 16 Jul 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;console filter&lt;/h2&gt;
&lt;p&gt;匹配一段使用字符串拼接 html, 输出拼接后的 html&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; r &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token regex&quot;&gt;/[&apos;&quot;](.*)[&apos;&quot;]\s?[\+;\b]?/g&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; template &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;div class=&apos;abcde&apos;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;div&gt;&amp;lt;/div&gt;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
    &lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;/div&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
cosnt output &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; template&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;replace&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;$&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; $&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//output = &quot;&amp;lt;div class=&apos;abcde&apos;&gt;&amp;lt;div&gt;&amp;lt;/div&gt;&amp;lt;/div&gt;&quot;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;匹配一个匹配包括下划线, 连接线的任何单词字符并且不以 data 开头的, 以 true 结尾的字段&lt;/p&gt;</content:encoded></item><item><title><![CDATA[rust 学习笔记]]></title><description><![CDATA[声明与可变性 在 rust 中声明和 javascript 有些类似, 基本可以总结为: 使用 let 声明变量, 使用 const 声明常量. 使用 mut…]]></description><link>https://pakholeung37.github.io/rust 学习笔记/</link><guid isPermaLink="false">https://pakholeung37.github.io/rust 学习笔记/</guid><pubDate>Tue, 14 Jul 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;声明与可变性&lt;/h2&gt;
&lt;p&gt;在 rust 中声明和 javascript 有些类似, 基本可以总结为:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;使用 let 声明变量, 使用 const 声明常量.&lt;/li&gt;
&lt;li&gt;使用 mut 显式声明对变量可变性.&lt;/li&gt;
&lt;li&gt;变量可重复声明, 后声明的变量覆盖前声明的变量. 重复定义的变量类型可不同.&lt;/li&gt;
&lt;li&gt;常量除了具有不可变性外, 还是编译时完全确定的, 具体来说, 常量体现在内存中就是就是值固定的.&lt;/li&gt;
&lt;li&gt;mut 只定义了可变性, 但是变量的类型是不变的, 一旦推断类型就是不变的.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;基本类型&lt;/h2&gt;
&lt;p&gt;rust 的基本类型有 4 中, 分别是整型, 浮点, 布尔和字符.&lt;/p&gt;
&lt;h3&gt;整型&lt;/h3&gt;
&lt;p&gt;整型分为有符号整型: i8, i16, i32, i64, i128, isize(取决于操作系统)&lt;/p&gt;
&lt;p&gt;无符号整型: u8, u16, u32, u64, u128, usize(取决于操作系统)&lt;/p&gt;
&lt;p&gt;如果不给定类型, 则首选推断类型为 i32&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;rust&quot;&gt;&lt;pre class=&quot;language-rust&quot;&gt;&lt;code class=&quot;language-rust&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 各进制写法&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;98_222&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// decimal&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;0xff&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// hex&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;0o77&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// octal&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;0b1111_0000&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;//binary&lt;/span&gt;
&lt;span class=&quot;token char string&quot;&gt;b&apos;A&apos;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;// byte 仅限u8&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;浮点&lt;/h3&gt;
&lt;p&gt;仅有 f32, f64&lt;/p&gt;
&lt;h3&gt;布尔&lt;/h3&gt;
&lt;p&gt;仅有 bool&lt;/p&gt;
&lt;h3&gt;字符&lt;/h3&gt;
&lt;p&gt;仅有 char, 大小为 4bytes&lt;/p&gt;
&lt;h2&gt;复合类型&lt;/h2&gt;
&lt;p&gt;复合类型原生有元组和数组&lt;/p&gt;
&lt;h3&gt;元组&lt;/h3&gt;
&lt;p&gt;形如(type1, type2, type3)的类型.&lt;/p&gt;
&lt;p&gt;操作:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;rust&quot;&gt;&lt;pre class=&quot;language-rust&quot;&gt;&lt;code class=&quot;language-rust&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 解构&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; tup&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i32&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; f64&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; u8&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6.4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; z&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; tup&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 访问&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; tup&lt;span class=&quot;token number&quot;&gt;.1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; tup&lt;span class=&quot;token number&quot;&gt;.2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; z &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; tup&lt;span class=&quot;token number&quot;&gt;.3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;数组&lt;/h3&gt;
&lt;p&gt;数组一旦声明, 长度就固定, 声明形如[type; length]&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;rust&quot;&gt;&lt;pre class=&quot;language-rust&quot;&gt;&lt;code class=&quot;language-rust&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 声明&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;i32&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 访问&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; first &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; end &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 初始化&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;函数&lt;/h2&gt;
&lt;p&gt;在 rust 中, 一个函数的定义如下&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;rust&quot;&gt;&lt;pre class=&quot;language-rust&quot;&gt;&lt;code class=&quot;language-rust&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;function_name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;param1&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; type1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;returnType&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;token punctuation&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在 rust 中, 要理解返回值, 必须理解好语句和表达式, 表达式有返回值的, 而语句则没有返回值.&lt;/p&gt;
&lt;p&gt;在 rust 中, 函数的返回值, 是由最后一个表达式的值决定的. 函数的定义是语句, 不返回任何值, 但是函数的调用则是表达式, 是可以返回值的, 这一定是必须要分清楚. 在这种严格的定义下可知, rsut 的赋值语句不返回任何值, 而 rsut 的代码块则是表达式, 所以在 rust 中会出现使用代码块来返回值的情况. 而控制流(if, loop, while, for)也被定义为表达式.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;rust&quot;&gt;&lt;pre class=&quot;language-rust&quot;&gt;&lt;code class=&quot;language-rust&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; u32 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// 代码块的返回值为最后一个表达式的值.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; u32 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;loop&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    counter &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; counter &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt; couter &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;The result is {}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这种严格区分表达式和语句的理念可以有效理解 rust 在各种情况下的行为, 减少出错. 另语句必须使用分号作为结束.&lt;/p&gt;
&lt;h2&gt;所有权, 转移, 引用及借用&lt;/h2&gt;
&lt;p&gt;变量作用域: 当变量进入作用域时, 它是有效的, 并持续到离开作用域.&lt;/p&gt;
&lt;p&gt;所有权是指一个变量拥有改变一个分配在堆上的数据的权力, 并且每时每刻, 当且仅有一个变量拥有改变同一份数据的能力.&lt;/p&gt;
&lt;p&gt;所有权可以转移, 引用, 借用&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;rust&quot;&gt;&lt;pre class=&quot;language-rust&quot;&gt;&lt;code class=&quot;language-rust&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 转移, 所有权从s转移到s2上&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; s &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; String&lt;span class=&quot;token punctuation&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;hello&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; s2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; s&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 引用&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; s &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; String&lt;span class=&quot;token punctuation&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;hello&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; s2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// 借用, 借用是引用的一个特例, 特指将获取的引用作为函数参数&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; s &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; String&lt;span class=&quot;token punctuation&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;hello&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;change&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;mut&lt;/span&gt; s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;change&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;some_string&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;mut&lt;/span&gt; String&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    some_string&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push_str&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;, world&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;而引用又分为可变引用和不可变引用, 可变引用可以改变数据, 但是不可变不能改变数据, 用 mut 指示.&lt;/p&gt;
&lt;p&gt;在同一作用域下, 同一份数据的要么存在多个不可变引用, 要么存在单个可变引用&lt;/p&gt;
&lt;p&gt;引用必须总是有效的,&lt;/p&gt;
&lt;p&gt;这个模型旨在解决以往编程语言的几个重要问题:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;一个变量如何释放分配的内存, rust 的答案是在离开作用域后就释放.&lt;/li&gt;
&lt;li&gt;在多线程下, 如何避免数据竞争, rust 的答案是所有权机制是一个自然的读写锁模型, 可以有效避免竞争.&lt;/li&gt;
&lt;li&gt;野指针, 野引用, rust 在编译阶段就不允许引用到不存在的数据.&lt;/li&gt;
&lt;/ol&gt;</content:encoded></item><item><title><![CDATA[跨域最佳实践]]></title><description><![CDATA[之前在工作中, 有过几次需要跨域的场景, 统一总结在这里吧. CORS 跨域资源共享(CORS) 是一种机制，它使用额外的 HTTP 头来告诉浏览器 让运行在一个 origin (domain) 上的 Web…]]></description><link>https://pakholeung37.github.io/跨域最佳实践/</link><guid isPermaLink="false">https://pakholeung37.github.io/跨域最佳实践/</guid><pubDate>Sun, 12 Jul 2020 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;之前在工作中, 有过几次需要跨域的场景, 统一总结在这里吧.&lt;/p&gt;
&lt;h2&gt;CORS&lt;/h2&gt;
&lt;p&gt;跨域资源共享(&lt;a href=&quot;https://developer.mozilla.org/zh-CN/docs/Glossary/CORS&quot;&gt;CORS&lt;/a&gt;) 是一种机制，它使用额外的 &lt;a href=&quot;https://developer.mozilla.org/zh-CN/docs/Glossary/HTTP&quot;&gt;HTTP&lt;/a&gt; 头来告诉浏览器 让运行在一个 origin (domain) 上的 Web 应用被准许访问来自不同源服务器上的指定的资源。当一个资源从与该资源本身所在的服务器&lt;strong&gt;不同的域、协议或端口&lt;/strong&gt;请求一个资源时，资源会发起一个&lt;strong&gt;跨域 HTTP 请求&lt;/strong&gt;。&lt;a href=&quot;https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS&quot;&gt;MDN&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;我所理解的跨域应当是一个浏览器的安全手段, 因为在某些条件下, 允许跨域可能会使得某些恶意应用通过一些手段造成恶意攻击&lt;a href=&quot;https://segmentfault.com/a/1190000015597029&quot;&gt;不要再问我跨域的问题了&lt;/a&gt;, 也就是所谓的 CSRF 攻击. 另外跨域还可能存在在 dom 查询上, 例如如果允许跨域的话, 就会允许另一个进程的网页通过 dom 查询访问到特定 url 的 dom, 这样可能会造成很多恶性的后果.&lt;/p&gt;
&lt;p&gt;但是跨域的限制方其实一直都是浏览器支持的, 这一点非常的重要, 因为有些浏览器其实是没有跨域限制的, 例如小程序环境, 小程序的开发模拟环境, 甚至 HBuilderX 里面浏览器插件, 这些环境的做法, 都是直接允许跨域的, 但是在标准的浏览器中: chrome, firefox, safari 都是需要不允许跨域的. 我之前在微信小程序的时候, 一个是访问后端服务接口, 另一个是需要访问到腾讯地图的 webservice api, 但是都没有跨域的问题, 在最近将 uni-app 小程序迁移到 h5 之后, 所有问题都爆发了, 然后才开始深入了解跨域的问题, 以及解决跨域的一些 hack 手段及正规的跨域方式.&lt;/p&gt;
&lt;h2&gt;访问后端接口&lt;/h2&gt;
&lt;p&gt;我在实现访问后端跨域接口的问题上陆续有些经验. 在最开始做自己的项目也有过同样的跨域问题, 场景大概是将本地端口 8080 的前端项目访问到后台的本地端口 80, 一般是 localhost:3000/api 这样一个链接. 当时应该是直接在后端做跨域支持的. 这个方法是在后端的 response 的 header 上加上 asscess-control-allow-origin 上加上需要跨域的域名, 当时&lt;/p&gt;</content:encoded></item><item><title><![CDATA[微信网页开发相关]]></title><description><![CDATA[令人迷惑的口令 暂时梳理一下在微信网页开发中的普通 accessToken, 授权 accessToken, openId, UnionID, jsapiTicket 和各种定义 普通 accessToken 在文档中的开始开发一章中开始谈到, 普通 accessToken…]]></description><link>https://pakholeung37.github.io/微信网页开发相关/</link><guid isPermaLink="false">https://pakholeung37.github.io/微信网页开发相关/</guid><pubDate>Fri, 03 Jul 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;令人迷惑的口令&lt;/h2&gt;
&lt;p&gt;暂时梳理一下在微信网页开发中的普通 accessToken, 授权 accessToken, openId, UnionID, jsapiTicket 和各种定义&lt;/p&gt;
&lt;h3&gt;普通 accessToken&lt;/h3&gt;
&lt;p&gt;在文档中的&lt;a href=&quot;https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Access_Overview.html&quot;&gt;开始开发&lt;/a&gt;一章中开始谈到, 普通 accessToken 是公众号的全局唯一接口凭据, 简单来说, 这个值是服务器向调用微信官方服务需要带上的, 这个值目前的有效期是两小时, 简单来说, 在前端, 你基本不会用到这个 accessToken, 这个值是微信服务器接口的凭据, 而前端一般是不会直接向微信服务器请求服务的, 一般是下类接口, 我个人理解这个凭据的其中一个目的应该是强制公众号开发架设自己的服务器, 降低官方服务器的压力.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;assets/ac1dc48d-3c8f-57f4-6cf1-2823dd26ff6c&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;所以很明显, 这个 accessToken 和网页开发几乎没有什么关系.&lt;/p&gt;
&lt;h2&gt;网页开发&lt;/h2&gt;
&lt;p&gt;在微信内打开的页面其实和普通浏览器打开的页面几乎没有任何区别, 唯一重要的区别在于微信浏览器内置了 JSBridge, 可以通过这个 bridge, 调用微信的一些能力, 注意, 这里很明确, 调用的是微信的能力而不是机器本身的能力, 这有本质上的区别.&lt;/p&gt;
&lt;p&gt;在微信客户端访问的第三方网页, 则可以通过 JSBridge, 通过微信网页的授权机制, 来获取用户基本信息.&lt;/p&gt;
&lt;h3&gt;jsapi_ticket&lt;/h3&gt;
&lt;p&gt;在使用 JSSDK 中的 config 一步, 需要用到的 timeStamp, nonceStr, signature, 其实都是在后端生成并返回到前端的&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;wx&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  debug&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。&lt;/span&gt;
  appId&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 必填，公众号的唯一标识&lt;/span&gt;
  timestamp&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 必填，生成签名的时间戳&lt;/span&gt;
  nonceStr&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 必填，生成签名的随机串&lt;/span&gt;
  signature&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token comment&quot;&gt;// 必填，签名&lt;/span&gt;
  jsApiList&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 必填，需要使用的JS接口列表&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;官方定义中写明, jsapi_ticket 是公众号用于调用微信 JS 接口的临时票据, 注意, 这里说的是公众号, 不是网页, 所以这个 ticket 不是给网页用的, 而是在公众号的服务器上使用的. 但是, 同时网页需要一个对应的 jsapi 票据的签名, 来确认网页调用 JS 接口对应是哪个公众号. 简单来说, 就是只是将公众号的能力赋予网页, 让网页完成接口调用. 再简单点说, 就是再调用 JS 接口时, 微信会询问是哪个公众号允许你这样调用. 所以在微信内部调用 JSBridge 能力, 按这样说, 是都需要公众号支持的.&lt;/p&gt;
&lt;p&gt;这样说来, 在任何地方, 调用微信相关的接口都是需要临时票据, 在服务器上, 需要的是 accessToken, 而在前端网页, 需要的是 jsapi&lt;em&gt;ticket, 只不过前端网页因为风险问题, 不适宜持有 jsapi&lt;/em&gt;ticket, 所以给了签名作为代替.&lt;/p&gt;
&lt;h2&gt;jsapi_ticket 和 accessToken&lt;/h2&gt;
&lt;p&gt;从上面分析, accessToken 和 jsapi&lt;em&gt;ticket 都是调用微信相关接口的临时票据, 一个是服务器使用, 一个是在前端使用, 但是在 JSSDK 权限签名算法一节中有提到, jsapi&lt;/em&gt;ticket 的生成其实是依附于 accessToken 的, 而且同样是 7200 秒. 所以比较合适的做法是, 服务器在生成 accessToken 的同时, 生成 jsapi&lt;em&gt;ticket, 并持久化, 在下一次过期后再次生成. 即不再需要关注 jsapi&lt;/em&gt;ticket 过期的问题.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[微信网页 本地调试方法汇总]]></title><description><![CDATA[问题 在微信服务号开发下因为微信接口的限制, 是需要配置安全域名的, 一个是微信 js 接口安全域名, 用于调用 js-SDK…]]></description><link>https://pakholeung37.github.io/微信网页 本地调试方法汇总/</link><guid isPermaLink="false">https://pakholeung37.github.io/微信网页 本地调试方法汇总/</guid><pubDate>Thu, 02 Jul 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;问题&lt;/h2&gt;
&lt;p&gt;在微信服务号开发下因为微信接口的限制, 是需要配置安全域名的, 一个是微信 js 接口安全域名, 用于调用 js-SDK, 另一个是授权的时候回调页安全域名(&lt;em&gt;用户在网页授权页同意授权给公众号后，微信会将授权数据传给一个回调页面，回调页面需在此域名下，以确保安全可靠。沙盒号即测试号回调地址支持域名和 ip，正式公众号回调地址只支持域名。).&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;而且官方说明了, 这两个域名都是支持 80 端口的. 如果在本地开发, 将会面临一定阻碍.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;本地开发, 特别指前后端分离的项目, 前端项目一般本地调试都是在 8080 端口, 对于一些开发来说, 本机的 80 端口是常年被占用的.&lt;/li&gt;
&lt;li&gt;在本地将没办法被解析&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;解决方案&lt;/h2&gt;
&lt;p&gt;这里列举几种方案, 用于解决这类问题, 核心都是如何将项目映射到一个固定域名上&lt;/p&gt;
&lt;h3&gt;内网穿透&lt;/h3&gt;
&lt;p&gt;内网穿透, 即使用一个拥有外网服务器作为请求服务器, 使用内网穿透, 将内网地址上的请求通过外网服务器来转发, 可以实现将内网地址映射到外网 ip 上.&lt;/p&gt;
&lt;p&gt;典型的应用有 ngork, natapp, 花生壳等. 例如我使用 natapp, 在 natapp 官网配置好域名和转发端口, 然后就可以在本地打开 natapp 应用和开发的项目, 将 natapp 服务器分配的域名 pakholeung.natapp1.cc 转发到本地 localhost:8080 端口上.&lt;/p&gt;
&lt;p&gt;优点, 使用方便, 只需要配置好 natapp 就可以进行开发, 而且因为使用了内网穿透, 调试不再局限在本地, 可以直接通过分配的外网域名来访问调试.&lt;/p&gt;
&lt;p&gt;缺点, natapp 分配的域名在使用中会不定期改变, 每次改变都要重新配置安全域名, 比较闹心, 不过可以通过购买二级域名解决. 而且访问速度取决于 natapp 分配的带宽, 一般来说免费 1M, 付费 2M, 算是够用了. 内网穿透仅限个人使用, 团队需要每人配置一份.&lt;/p&gt;
&lt;p&gt;问: 是否可以使用穿透到内网, 在内网架设 NAT 穿透, 这样可以解决域名和带宽问题? 这个方案很有创意, 但是我觉得略微占用服务器资源, 架设 NAT 是需要服务器跑相应的 NAT 服务的, 而且感觉和 nginx 配合不是很好, 可能需要另外架设一台干净的服务器, 这就变得浪费服务器资源了. 但是, 如果在内网, 为什么不直接在内网服务器配置 nginx, 将请求转发到本机呢.&lt;/p&gt;
&lt;h3&gt;修改 DNS + nginx 代理&lt;/h3&gt;
&lt;p&gt;安全域名只是一 个域名, 微信本是不会访问的, 所以这个域名并不限定需要在外网访问到. 这样, 可以通过改写本地 DNS 列表 + 80 端口代理, 将虚拟的域名代理到本地的任意端口上, 从而实现安全接口.&lt;/p&gt;
&lt;p&gt;这里根据颗粒度可以有几种做法. 第一种, 仅限本机访问. 即只改写本地的 DNS, 例如在本地的 DNS List 加上 www.test.cn = 127.0.0.1, 直接将 www.test.cn 解析到本地, 然后需要配置 nginx, 将本机的 80 上的请求, 代理到 8080 端口上. 完成转发. 或者直接将 devServer 配置成 80 端口, 这样连转发都不用.&lt;/p&gt;
&lt;p&gt;优点, 访问快, 因为都是在本机进行转发, 不受限于带宽.&lt;/p&gt;
&lt;p&gt;缺点, 仅限于本机, 别人没办法访问, 因为你只改了自己的 DNS 配置.&lt;/p&gt;
&lt;p&gt;所以加强版是, 在上游添加 DNS 规则, 而不是在本机上, 例如在公司的服务器将本机的 DNS 规则加上. 这样, 整个内网都可以访问到你的机器. 当然你需要开放你的端口, 这样别人才会访问到.&lt;/p&gt;
&lt;p&gt;缺点, 配置繁琐, 而且不适合在本地已经架设服务器的开发, 因为本地的 80 端口已经被占用. 另外使用手机进行调试的时候你会发现, 手机是没办法修改 DNS 的. 只能继续借助黑科技解决, 和本地开发配合不是和很好.&lt;/p&gt;
&lt;h3&gt;使用真正服务器开发&lt;/h3&gt;
&lt;p&gt;直接架设 http 服务器进行开发, 真实服务器拥有真实域名和 ip.&lt;/p&gt;
&lt;p&gt;优点: 最接近生产环境的方案. 如果在本机构建, 一般的前端项目可以将 webpack 的 devServer 端口设置成 80, 然后就可以进行开发, 或者直接发布到内网服务器, 使用内网服务器进行开发. 又或者直接在内网服务器构建项目, 但内网的 80 端口一般已经被占用, 所以在内网进行 webpack 构建基本没什么可能, 除非又使用 nginx 转发到 devServer 端口上, 又回到了解放前.&lt;/p&gt;
&lt;p&gt;缺点: 在本机, 是没有真实域名的, 只能使用 ip, 而安全接口测试号是可以填 ip 的, 但是这种方法没办法调试真实公众号, 除非你继续使用修改 DNS, 这种方法和上一种就没什么区别了, 省就省在不用在本机上架设 nginx. 如果是在内网服务器上进行这种操作, 就显得更加捞, 因为一样要修改 DNS, 而且只能架设一个项目, 团队中难道同时使用一个项目调试? 这样就不是很合理.&lt;/p&gt;
&lt;p&gt;综上, 总结这么多的方案, 其实我最推崇的还是第一种方案, 基本上, 你只要交钱就可以了, 因为用钱能解决的问题都不是问题. 通过修改 DNS 的方案都不是好方案. 修改 nginx 的方案也不是好方案.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[提供统一DX的uniapp工程构建/迁移]]></title><description><![CDATA[HBuilderX 项目迁移 将 uniapp-boilerplate 克隆到你的机器上 将原本使用 HBuilderX 生成的项目的根目录下的文件全部复制到 src 下 将原项目根目录下的 package.json, 合并到新项目的根目录下的 package.json…]]></description><link>https://pakholeung37.github.io/提供统一DX的uniapp工程构建迁移/</link><guid isPermaLink="false">https://pakholeung37.github.io/提供统一DX的uniapp工程构建迁移/</guid><pubDate>Wed, 01 Jul 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h3&gt;HBuilderX 项目迁移&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;将 uniapp-boilerplate 克隆到你的机器上&lt;/li&gt;
&lt;li&gt;将原本使用 HBuilderX 生成的项目的根目录下的文件全部复制到 src 下&lt;/li&gt;
&lt;li&gt;将原项目根目录下的 package.json, 合并到新项目的根目录下的 package.json&lt;/li&gt;
&lt;li&gt;打开 vscode 或其他可用编辑器, npm/yarn 安装依赖, 安装 eslint, prettier, editorconfig, vetur 插件&lt;/li&gt;
&lt;li&gt;开始愉快编程&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;小程序开发(微信小程序为例)&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;使用 vscode 或其他可用编辑器打开可用的基于 uniapp-boilerplate 项目&lt;/li&gt;
&lt;li&gt;命令行进入到项目目录下, 输入命令 npm run dev:mp-weixin&lt;/li&gt;
&lt;li&gt;打开微信开发者工具, 将项目下 dist/wp-weixin 目录导入到开发者工具&lt;/li&gt;
&lt;li&gt;开始愉快编程&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;H5 端开发&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;使用 vscode 或其他可用编辑器打开可用的基于 uniapp-boilerplate 项目&lt;/li&gt;
&lt;li&gt;使用代理或其他方式解决跨域问题, 下面内容有涉及&lt;/li&gt;
&lt;li&gt;命令行进入到项目目录下, 输入命令 npm run dev:h5&lt;/li&gt;
&lt;li&gt;打开微信开发工具, 调整到公众号网页开发(使用微信开发工具是因为未来项目里可能引入微信 h5 端特有的 api 和 SDK, 普通浏览器打开可能会报错)&lt;/li&gt;
&lt;li&gt;输入域名 localhost:8080(或你自己配置的端口)&lt;/li&gt;
&lt;li&gt;开始愉快编程&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;我还是想使用 HBuilderX&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;将基于 uniapp-boilerplate 项目下的.editorconfig, package.json, vue.config.js 复制到 src 内&lt;/li&gt;
&lt;li&gt;将 src 作为项目根目录导入到 HBuilderX&lt;/li&gt;
&lt;li&gt;开始和原来一摸一样的编程体验, 你将得到: 统一的缩进和换行符, 你将失去, 统一的 lint 和格式化, 命令行调用.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;changelog&lt;/h2&gt;
&lt;p&gt;2020 06 17
添加 eslint rules&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;    &lt;span class=&quot;token property&quot;&gt;&quot;no-extra-boolean-cast&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;off&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// 允许使用!!转换&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;prettier/prettier&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;off&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;        &lt;span class=&quot;token comment&quot;&gt;// 暂时::  暂停使用eslint-prettier, 因为团队中有使用tab进行换行, 而配置是space, 观感很不好&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;vue/no-use-v-if-with-v-for&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;warn&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// 项目中大量v-if v-for 混用, 这部分从error等级降到warn&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;vue/no-unused-components&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;warn&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;    &lt;span class=&quot;token comment&quot;&gt;// 暂时:: 项目中大量未使用的component声明, 从error等级降到warn&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;no-self-assign&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;warn&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;             &lt;span class=&quot;token comment&quot;&gt;// 暂时:: 项目中有少量自赋值的操作, 原因不明, 从error等级降到warn&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;vue/no-parsing-error&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token property&quot;&gt;&quot;x-invalid-end-tag&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// 允许使用end tag&amp;lt;input&gt;&amp;lt;/input&gt; 代替 单标签&amp;lt;input /&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;添加.eslintignore, 将不对这部分文件夹进行 lint 操作&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;src/libs/
src/components/jyf-parser/&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;2020 06 16
添加了两个依赖分析脚本&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;analyz:mp-weixin   // 对mp-weixin项目进行依赖分析
analyz:h5          // 对h5项目进行依赖分析&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;目的&lt;/h2&gt;
&lt;p&gt;本次工程的构建目的主要有:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;确定代码规范, 并贯彻执行, 关于规范代码的好处已是老生常谈, 不再多谈.&lt;/li&gt;
&lt;li&gt;利用 eslint 标记老项目重构后存在的潜在 bug.&lt;/li&gt;
&lt;li&gt;提高项目自由度和可定制性.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;详述&lt;/h2&gt;
&lt;p&gt;首先, 根据官方 quick-start 阐述, 工程的开始方式有两种, 一种 ① 是搭配 HBuilderX 进行工程创建, 工程目录如下&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;┌─components            uni-app组件目录
│  └─comp-a.vue         可复用的a组件
├─pages                 业务页面文件存放的目录
│  ├─index
│  │  └─index.vue       index页面
│  └─list
│     └─list.vue        list页面
├─static                存放应用引用静态资源（如图片、视频等）的目录，注意：静态资源只能存放于此
├─wxcomponents          存放小程序组件的目录，详见
├─main.js               Vue初始化入口文件
├─App.vue               应用配置，用来配置App全局样式以及监听 应用生命周期
├─manifest.json         配置应用名称、appid、logo、版本等打包信息，详见
├─package.json          配置uniapp
└─pages.json            配置页面路由、导航条、选项卡等页面类信息，详见&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;另一种方式 ② 是通过 &lt;code class=&quot;language-text&quot;&gt;vue create&lt;/code&gt; 模板创建, 创建的目录如下&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;┌── node_modules
├── public
│   └── index.html
├── src                     项目代码
│   ├── app.css
│   ├── App.vue
│   ├── components
│   ├── ext.json
│   ├── main.js
│   ├── manifest.json
│   ├── pages
│   ├── pages.json
├── tsconfig.json           typescript配置文件, 保留
├── postcss.config.js       postCSS配置文件
├── prettier.config.js      prettier配置文件
├── .eslintrc.js            eslint配置文件
├── .editorconfig           editorconfig配置文件
├── vue.config.js           vue-cli支持的额外配置文件
├── package.json
└── yarn.lock&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以看到, 其实使用 cli 生成的项目的 src 和使用 HBuilderX 生成的项目是基本一致的. 他们的差异优势和缺点主要集中在以下几个地方&lt;/p&gt;
&lt;h3&gt;1. ① 工程只能通过 HBuilderX 的界面来调用构建操作, 而 ② 工程可以直接调用命令行构建, 也可以使用 HBuilderX 来构建&lt;/h3&gt;
&lt;p&gt;这个问题出现在项目的构建和 HB 的构建思想上, HB 为了控制生态和降低 Node 包大小考虑, 直接将构建部分的依赖放到了 HbuilderX 的文件夹内部, 而不是在项目下. 这其实有点违反前端构建的直觉. 其实你会发现, HB 中的安装插件, 其实插件都安装到了 HBuilderX/plugins/这个目录下, 在构建的时候, 直接将一个项目路径赋值到一个 node 环境变量, 然后再进行构建. 等于直接把 node_modules 和项目分开存放, 等构建时再链接在一起.
这个构建思维直接导致了, HB 控制了内部插件的版本, 配置. 所用插件等. 你没什么办法再去添加依赖. 而且, 可定制化非常差.
例如, 你不想使用 HB 使用的格式化插件 js-beautify, 而想只使用 prettier, 官方会告诉你不行, 在 HB 中, 只有.vue 文件会使用安装的 prettier 来进行格式化, 其他都用 beautify. 尽管 beautify 已经几近淘汰.
这也导致了 ① 工程一旦脱离 HB, 就没有任何办法构建, 而 ② 工程, 只需要将 src 文件中部分文件补全, 就可以使用 HB 来构建.&lt;/p&gt;
&lt;h3&gt;2. 统一团队格式化代码和 eslint 上, ① 工程显然不是很够看&lt;/h3&gt;
&lt;p&gt;得益于 HB 的负优化, 在 HB 中使用 eslint 和 prettier 将会面临双设置(插件全局设置和目录下设置), 但是没有任何证据表明, 在目录下设置.eslintrc.js 和 prettier.config.js 会覆盖全局设置并能起到任何效果, 而且本身编辑器不是很支持 eslint 显示. 和 vscode 相比差的实在太远.&lt;/p&gt;
&lt;h3&gt;3. ① 工程定制化差&lt;/h3&gt;
&lt;p&gt;在构建 H5 的时候, 我发现入口文件 index.html 并非绑定到项目中, 而是隐藏在 plugins/uniapp-cli/内, 很明显, 这个文件所有项目都会引用到, 这也导致你没什么办法去改这里面的代码. 当然可以在项目 manifest 的 h5 属性有一个 template 属性.可以定义 h5 的入口, 但是, 依赖配置文件的工程, 定制性肯定是大打折扣. 例如 h5 下还有一个 devServer 属性用来配置 webpack 的 devServer 属性, 但是 webpack 配置用 json 来配置肯定是不行的, 虽然后来官方开放 vue.config.js 这个文件用来定制 webpack, 只能说这样改法, 哪天要加个配置, 还要先等官方改吗. 当然是自己动手, 丰衣足食.&lt;/p&gt;
&lt;h3&gt;4. HB 有广告&lt;/h3&gt;
&lt;p&gt;虽然官方文档对 HB 一顿狂吹, 虽然要感激 DCloud 做出 uniapp, 但是仍抵不住铺天盖地的广告. 我曾设想只用 HB 来作为一个有视窗的脚本触发器. 但是 HB 的 console 一是有广告, 二是 console 中貌似只保留了自己的日志. 转到 cli 后, 日志比较正常, 而且日志等级可以设定.&lt;/p&gt;
&lt;p&gt;综上所述, 我个人是比较倾向于使用 vue-cli 的方式来进行, 为此, 我创建了 uniapp-boilerplate 样板工程.
首先这个样板工程是基于 dcloudio/uni-preset-vue 生成的样板来设置的, 在设置中, 进行了以下定制:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;缩进, end-of-line, 编码格式 使用.editorconfig 进行设置, 不再在 prettier 进行冗余设置. 这部分规则是强制执行的, 目的也是为了规范这部分编码行为, 在过去经验中, 缩进和换行的统一能有效减少因为格式化导致的多余 commit 的问题, 具体如下&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;// .editorconfig
root = true
&lt;span class=&quot;token comment&quot;&gt;# 指定作用文件格式&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;*&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# 缩进的类型 [space | tab]&lt;/span&gt;
indent_style = space
&lt;span class=&quot;token comment&quot;&gt;# 缩进的大小&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# tab_width: 设置整数用于指定替代tab的列数。默认值就是indent_size的值，一般无需指定。&lt;/span&gt;
indent_size = 2
&lt;span class=&quot;token comment&quot;&gt;# 定义换行符 [lf | cr | crlf]&lt;/span&gt;
end_of_line = lf
&lt;span class=&quot;token comment&quot;&gt;# 编码格式。支持latin1、utf-8、utf-8-bom、utf-16be和utf-16le，不建议使用uft-8-bom。&lt;/span&gt;
charset = utf&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# 是否除去换行行首的任意空白字符&lt;/span&gt;
trim_trailing_whitespace = true
&lt;span class=&quot;token comment&quot;&gt;# 文件是否以一个空白行结尾 [true | false]&lt;/span&gt;
insert_final_newline = true&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;统一使用 prettier 进行格式化, 不再提供其他格式化工具. 我个人依赖 prettier 是因为我习惯代码拿到手直接格式化, 但是有部分人可能不是太喜欢这种操作, 所以在格式化方面是尽量做到克制, 但是引号分号这种还是有必要统一. 而且有部分设定是为了覆盖编辑器原本的设置, 这样做可以保证每个人格式化后的代码都是一致的.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
 semi&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//末尾分号&lt;/span&gt;
 singleQuote&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//使用双引号代替单引号&lt;/span&gt;
 printWidth&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//最长行宽&lt;/span&gt;
 trailingComma&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;es5&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//未随逗号&lt;/span&gt;
 arrowParens&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;always&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//箭头函数强制使用括号&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;eslint, 规则则是尽可能地做到克制, 只会在适当的地方做提示, 并调和和 uniapp 冲突的地方&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
 root&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
 env&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
   node&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;plugin:vue/essential&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;eslint:recommended&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;@vue/prettier&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
 parserOptions&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
   parser&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;babel-eslint&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
 rules&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;token string&quot;&gt;&quot;no-console&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; process&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;env&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;NODE_ENV&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;production&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;warn&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;off&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;token string&quot;&gt;&quot;no-debugger&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; process&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;env&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;NODE_ENV&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;production&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;warn&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;off&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;token comment&quot;&gt;// 条件编译下可能导致unreachable&lt;/span&gt;
   &lt;span class=&quot;token string&quot;&gt;&quot;no-unreachable&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;off&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;token comment&quot;&gt;// 没用的变量在编辑器本来就会有提示, 在这里不再做这种提示&lt;/span&gt;
   &lt;span class=&quot;token string&quot;&gt;&quot;no-unused-vars&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;off&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
 globals&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;token comment&quot;&gt;// 在uniapp中有定义的顶级变量, 需要在这里做出声明&lt;/span&gt;
   uni&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;readonly&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   wx&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;readonly&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   swan&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;readonly&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   getApp&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;readonly&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   getCurrentPages&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;readonly&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在实际使用中, eslint 会在几个关键的地方做出提示.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;不符合 prettier 规则, 包括使用错误的缩进和错误的换行. 显示 warning&lt;/li&gt;
&lt;li&gt;可能造成编译错误或运行时错误的代码. 显示 error&lt;/li&gt;
&lt;li&gt;其他地方则不再做出任何提示. 比较契合富有经验的前端团队, 如果对自己的代码规范有所顾虑, 可以替换成更高的 lint 规范. 另外需要注意的是, 在 vue.config.js 的配置中, lintOnSave 是默认关闭的. 即不会在编译阶段使用 lint. 我个人觉得 lint 有编辑器的提示已经足够的, 新项目可能还好, 在面对可能有成吨不符合规范的代码的老项目, 在编译阶段进行 lint 只会让团队显得尴尬.&lt;/li&gt;
&lt;li&gt;如果想使用 HB 来开发, 你还需要作如下处理: 复制 vue.config.js, .editorconfig, package.json 到 src 目录下, 导入项目时使用 src 作为项目根目录进行导入. 这样就可以在 HB 中进行开发, 但是同时你将失去: 统一的格式化方案, 统一的 lint 方案, 你可能和团队其他人使用不同的代码规范, 望知晓.&lt;/li&gt;
&lt;li&gt;内置 scss.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;最佳实践&lt;/h2&gt;
&lt;p&gt;众所周知, vscode 是世界上最好的编辑器, 以下实践部分将只在 vscode 中进行演示.
这份样板拉下来之后, 如果不对编辑器进行一些配置, 其实是没办法发挥他的作用的, 代码 clone 下来, 首先要做的操作当然是直接 npm/yarn. 然后你需要安装下列这部分插件, 以达到对应的支持和效果. 这部分必要的插件是&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Prettier 格式化代码必须&lt;/li&gt;
&lt;li&gt;EditorConfig for VsCode 对.editorconfig 支持必须&lt;/li&gt;
&lt;li&gt;ESLint 编辑器提示必须&lt;/li&gt;
&lt;li&gt;Vetur vue 开发必须&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;一般来说, 拿到一份代码, 如果你是这份代码的主要负责人, 你是有责任维护这份代码的, 所以请你毫不犹豫地先格式化一遍代码. 如果代码是像这样全屏黄, 那我建议你格式化后直接 commit 一次. 少量的格式化差异, 你可以选择 commit, 恢复.&lt;/p&gt;
&lt;p&gt;对于代码中 eslint 标红(error)的代码, 是必须要解决的.&lt;/p&gt;
&lt;p&gt;对于代码中 eslint 标黄(warning)的代码, 你可以选择性忽略或者直接 disable.&lt;/p&gt;
&lt;p&gt;对于由于 uniapp 条件编译标识错误的代码, 请更新 rule 到.eslintrc.js 中.&lt;/p&gt;
&lt;p&gt;对于由于必须存在的全局变量而标识错误的, 请更新到.eslintrc.js 的 globals 中.&lt;/p&gt;
&lt;p&gt;针对条件编译, 可以安装 better comments 插件, 并插入如下设置, 可为特殊的条件编译注释语句添加高亮&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token string&quot;&gt;&quot;better-comments.tags&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// 主要是第一个规则将#开头的注释显示为粉色, 下面都是沿用旧设置&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;tag&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;#&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;color&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;#f9297f&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;strikethrough&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;backgroundColor&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;transparent&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;tag&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;!&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;color&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;#FF2D00&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;strikethrough&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;backgroundColor&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;transparent&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;tag&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;?&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;color&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;#3498DB&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;strikethrough&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;backgroundColor&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;transparent&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;tag&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;//&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;color&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;#474747&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;strikethrough&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;backgroundColor&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;transparent&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;tag&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;todo&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;color&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;#FF8C00&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;strikethrough&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;backgroundColor&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;transparent&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;tag&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;color&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;#98C379&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;strikethrough&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;backgroundColor&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;transparent&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;提供的 scripts 有很多, 全部列在 package.json, 请仔细研究, 这里列几种比较常用的&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; run build:h5,  //构建h5版本
&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; run build:mp-weixin  // 构建微信小程序版本

&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; run dev:h5   //开发h5版本
&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; run dev:mp-weixin,  //持续构建微信小程序版本并监听&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;虽然很隐蔽, 但是 uniapp 很鸡贼地内置了 typescript, vue-typescirpt 支持(vue-class-component, vue-property-decorator), jest 测试框架. 有兴趣可以了解以下.&lt;/p&gt;
&lt;p&gt;开始开发 h5 版本的时候就会发现, 前端调用接口会出现跨域的问题. 我个人总结的方法是, 使用代理, 例如在 vue 的开发环境下, 会持续开启一个 webpack 构建的服务器(一般是 8080), 然后可以利用这个服务器进行一些代理操作, 绕过跨域的问题.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// vue.config.js 进行更多设置参看vue-cli文档&lt;/span&gt;
module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  configureWebpack&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    devServer&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token string&quot;&gt;&quot;/cros&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        target&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;http://abcd.com&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        pathReWrite&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;^cors&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这个设置可以将前端对 &lt;code class=&quot;language-text&quot;&gt;localhost:8080/cors&lt;/code&gt; 的部分请求, 通过这个 8080 的服务器代理到真正的&lt;code class=&quot;language-text&quot;&gt;http://abcd.com&lt;/code&gt;服务器上. 这样就可以绕过跨域的问题.&lt;/p&gt;
&lt;p&gt;开发小程序版本, 真正的目录位于/dist/dev/wp-XXX/下, 将这个目录作为项目根目录导入到相关小程序开发工具可解.&lt;/p&gt;
&lt;p&gt;HB 的发布操作应该是用 C++写的, 自然没有对应的脚本.&lt;/p&gt;
&lt;p&gt;在 2020 06 17 的提交中, 添加了一个”x-invalid-end-tag”规则, 用于允许如&lt;code class=&quot;language-text&quot;&gt;&amp;lt;input /&amp;gt;&lt;/code&gt;写成&lt;code class=&quot;language-text&quot;&gt;&amp;lt;input&amp;gt;&amp;lt;/input&amp;gt;&lt;/code&gt;, 但是在 vetur 中, 还是会使用内置的 eslint-plugin-vue 来对.vue 文件进行 lint. 所以有必要屏蔽这部分规则. 需要在.vscode/settings.json 添加&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token property&quot;&gt;&quot;vetur.validation.template&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;来屏蔽掉 vetur 的模板 lint 行为.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[各小程序登录/权限/接口]]></title><description><![CDATA[微信小程序 流程  接口 微信小程序和用户权限相关的接口有以下几个: wx.login, wx.checkSession, getUserInfo…]]></description><link>https://pakholeung37.github.io/各小程序登录权限接口/</link><guid isPermaLink="false">https://pakholeung37.github.io/各小程序登录权限接口/</guid><pubDate>Tue, 23 Jun 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;微信小程序&lt;/h2&gt;
&lt;h3&gt;流程&lt;/h3&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2fcc9f3575982a8fc3f05f29ae2748c1/67e9d/api-login.2fcc9f35.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 101.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe9FCjMCA//EABkQAQACAwAAAAAAAAAAAAAAAAABESAhMf/aAAgBAQABBQJxWEbQt//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABYQAAMAAAAAAAAAAAAAAAAAAAAwMf/aAAgBAQAGPwIiP//EAB0QAAICAQUAAAAAAAAAAAAAAAABESFBEDFRYdH/2gAIAQEAAT8hiNjoEnA258Kzo2Q8tyJ7P//aAAwDAQACAAMAAAAQYMAA/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAGxABAAMAAwEAAAAAAAAAAAAAAQARITFBUWH/2gAIAQEAAT8QGlqTE7LzUo3m4DtXxcbui/rCMnw5Uc9MfIvpjXE//9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;img&quot;
        title=&quot;img&quot;
        src=&quot;/static/2fcc9f3575982a8fc3f05f29ae2748c1/1c72d/api-login.2fcc9f35.jpg&quot;
        srcset=&quot;/static/2fcc9f3575982a8fc3f05f29ae2748c1/a80bd/api-login.2fcc9f35.jpg 148w,
/static/2fcc9f3575982a8fc3f05f29ae2748c1/1c91a/api-login.2fcc9f35.jpg 295w,
/static/2fcc9f3575982a8fc3f05f29ae2748c1/1c72d/api-login.2fcc9f35.jpg 590w,
/static/2fcc9f3575982a8fc3f05f29ae2748c1/67e9d/api-login.2fcc9f35.jpg 710w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;接口&lt;/h3&gt;
&lt;p&gt;微信小程序和用户权限相关的接口有以下几个: wx.login, wx.checkSession, getUserInfo 等. 在测试的时候我发现, 用户是否登录和用户是否授权用户信息是两个毫不相关的概念, 之前也以为授权必须建立在登录态之上但是发现并不是这样. 例如 getUserInfo 可以在 checkSession 为 err 下进行, getUserInfo success 后 checkSession 也依然为 err&lt;/p&gt;
&lt;h4&gt;wx.login&lt;/h4&gt;
&lt;p&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html&quot;&gt;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;调用接口获取登录凭证（code）. 测试发现使用非常宽松, 直接调用后回调返回{ errMsg, code }, 目前看不到 login 失败的案例&lt;/p&gt;
&lt;p&gt;注意, 只能获取登录凭证 code.&lt;/p&gt;
&lt;h4&gt;wx.checkSession&lt;/h4&gt;
&lt;p&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.checkSession.html&quot;&gt;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.checkSession.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;检查登录态是否过期. 非常简单的接口, 从这里可以发现, 很明显, 小程序定义的登录态只和是否持有 code 有关, 其他用户信息等和用户的其他权限是有关的, 即用户登录后持有唯一 code, 并且这个 code 可能过期. 在此阶段用户登录后是匿名的, 且获取小程序获取不了任何信息.&lt;/p&gt;
&lt;h4&gt;wx.getUserInfo&lt;/h4&gt;
&lt;p&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserInfo.html&quot;&gt;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserInfo.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;获取用户信息. 这是一个比较有争议的接口, 在之前的小程序中, 调用这个接口如果用户在登录态且没有授权用户信息, 则会直接弹出授权窗口. 但是在新的改动中, 这个行为被分开了, 弹出授权窗口有另外的接口, 不再在此接口中提供. &lt;a href=&quot;https://developers.weixin.qq.com/community/develop/doc/0000a26e1aca6012e896a517556c01&quot;&gt;https://developers.weixin.qq.com/community/develop/doc/0000a26e1aca6012e896a517556c01&lt;/a&gt;. 所以在目前的逻辑中, 小程序在调用该接口前, 必须先调用 wx.authroize 接口&lt;/p&gt;
&lt;h4&gt;open-type=“getUserInfo”&lt;/h4&gt;
&lt;p&gt;getUserInfo 的另一个版本, 需要用户主动点击才会生效, 和 wx.getUserInfo 不同的是, 这个版本会直接调起授权弹窗, 另外这个版本中, 是必定会带上 withCredentials=true&lt;/p&gt;
&lt;h4&gt;wx.authorize&lt;/h4&gt;
&lt;p&gt;用于申请某项权限, 参数 scope, 即可申请调用权限. 非常重要的是一旦用户明确同意或拒绝过授权，其授权关系会记录在后台，直到用户主动删除小程序. 但是这个条件和 getUserInfo 相悖, open-type=“getUserInfo”, 拒绝多次后依然可以调起授权窗口. 并且此接口同样无法调起授权窗口, 并且使用 scope.userLocation 需要在 minifest.json 中设置相应的 permission.&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;scope&lt;/th&gt;
&lt;th&gt;对应接口&lt;/th&gt;
&lt;th&gt;描述&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;scope.userInfo&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserInfo.html&quot;&gt;wx.getUserInfo&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;用户信息&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;scope.userLocation&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/location/wx.getLocation.html&quot;&gt;wx.getLocation&lt;/a&gt;, &lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/location/wx.chooseLocation.html&quot;&gt;wx.chooseLocation&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;地理位置&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;scope.userLocationBackground&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/location/wx.startLocationUpdateBackground.html&quot;&gt;wx.startLocationUpdateBackground&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;后台定位&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;scope.address&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/address/wx.chooseAddress.html&quot;&gt;wx.chooseAddress&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;通讯地址&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;scope.invoiceTitle&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/invoice/wx.chooseInvoiceTitle.html&quot;&gt;wx.chooseInvoiceTitle&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;发票抬头&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;scope.invoice&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/invoice/wx.chooseInvoice.html&quot;&gt;wx.chooseInvoice&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;获取发票&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;scope.werun&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/werun/wx.getWeRunData.html&quot;&gt;wx.getWeRunData&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;微信运动步数&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;scope.record&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/media/recorder/wx.startRecord.html&quot;&gt;wx.startRecord&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;录音功能&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;scope.writePhotosAlbum&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.saveImageToPhotosAlbum.html&quot;&gt;wx.saveImageToPhotosAlbum&lt;/a&gt;, &lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/media/video/wx.saveVideoToPhotosAlbum.html&quot;&gt;wx.saveVideoToPhotosAlbum&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;保存到相册&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;scope.camera&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/component/camera.html&quot;&gt;camera&lt;/a&gt; 组件&lt;/td&gt;
&lt;td&gt;摄像头&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;wx.getSetting&lt;/h4&gt;
&lt;p&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/setting/wx.getSetting.html&quot;&gt;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/setting/wx.getSetting.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;获取用户的当前设置。&lt;strong&gt;返回值中只会出现小程序已经向用户请求过的&lt;/strong&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/authorize.html&quot;&gt;权限&lt;/a&gt;. 其实在这里会看到, 权限的逻辑应当是, 当 authSetting 中存在相应逻辑, 直接返回结果, 否则调起授权弹窗. 这个接口没有任何副作用, 可以放心使用.&lt;/p&gt;
&lt;h4&gt;wx.openSetting&lt;/h4&gt;
&lt;p&gt;直接打开授权设置, 回调值与 getSetting 一致. 这个接口感觉只能引导用户自己改授权. 其实都要做好失败的处理.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[css 最佳实践]]></title><description><![CDATA[总结, 记录一直以来遇到的 CSS 问题, 和最佳实践. CSS 方案 纯 CSS 基本不会编写纯 CSS. 公司的架构是使用纯 CSS + post CSS + gulp 的组合, 比较落后. 在工作的经常会遇到命名重复, 样式覆盖等问题, 再加上使用和 bootstrap…]]></description><link>https://pakholeung37.github.io/css 最佳实践/</link><guid isPermaLink="false">https://pakholeung37.github.io/css 最佳实践/</guid><pubDate>Thu, 11 Jun 2020 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;总结, 记录一直以来遇到的 CSS 问题, 和最佳实践.&lt;/p&gt;
&lt;h2&gt;CSS 方案&lt;/h2&gt;
&lt;h3&gt;纯 CSS&lt;/h3&gt;
&lt;p&gt;基本不会编写纯 CSS. 公司的架构是使用纯 CSS + post CSS + gulp 的组合, 比较落后. 在工作的经常会遇到命名重复, 样式覆盖等问题, 再加上使用和 bootstrap 类似的 css 框架, 样式覆盖更加严重. 感觉不会写代码了. 没办法清空样式. 命名不规范导致的样式污染问题也同样非常严重. 不会再爱了. 如果要写以 global tree 架构的 css, 建议还是直接上 scss + BEM&lt;/p&gt;
&lt;h3&gt;SCSS + BEM&lt;/h3&gt;
&lt;p&gt;在前 react 项目 soundtrap 中使用过这种架构, 是以 styles 文件树组织的 global css tree 输出单一编译 css 文件的一种方案. 优点是可以减少样式污染的问题. 但是没办法从根本上解决这个问题. 毕竟 BEM 只是一种规范, 怎么用还是人决定的. 同样因为 global 属性防止不了写出有污染的代码. 另这种风格反人类, 经常可以写出非常长的 CSS selector, 只要嵌套的足够深. 输出的 css 和 dom 结构可读性尚可, 但是仍然避免不了冗长. 另此方案没有强绑组件和样式的关系, 反正也是想写哪就写哪. 同样看人, 在团队中使用不见得比纯 CSS 管用.&lt;/p&gt;
&lt;h3&gt;react CSS Module &amp;#x26; svelte&lt;/h3&gt;
&lt;p&gt;CSS Module 应该是目前所有框架主流解决方案. 强绑样式到组件上, 有效避免全局污染, 又可以按需加载, 实在是非常好的解决方案. dom 可读性方面略有欠缺. 在 react 上则可读性也是一般, 毕竟 react 本来就不绑定 CSS Module, CSS Module 方案都是第三方的方案.&lt;/p&gt;
&lt;p&gt;在此方案上提几点实践建议:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;放弃 BEM, CSS Module 能很好解决 BEM 的问题, 不需要再使用 BEM 来构成复杂, 难以阅读, 冗长的 CSS Selecotor&lt;/li&gt;
&lt;li&gt;扁平化 scss, 过多的嵌套会让选择器非常长,难以阅读 也加大浏览器解析成本和 css 文件大小, 尽量只在使用 &amp;#x26; 的情况下使用嵌套.&lt;/li&gt;
&lt;li&gt;项目文件和 css module 文件放在一起吧. 特别是 react 这种天生只有第三方方案的选手.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Vue scoped CSS&lt;/h3&gt;
&lt;p&gt;早些年流行的 vue css 的解决方案, 通过向 vue component 中注入一个自定义的 attribute hash, 通过 attribute 选择器来实现 scope, 这种做法优点在于可以保持 html 结构和文档的简洁, 当然也造成一定的问题. attribute 选择器的优先级是很高的, 这会导致 css 侵入组件变得异常的困难. 同时 attribute 选择器在性能上也不如后代选择器. 所以新项目还是建议直接使用 CSS Module 来的实在.&lt;/p&gt;
&lt;h3&gt;CSS in JS&lt;/h3&gt;
&lt;p&gt;被誉为前端未来的 css 方案, 注意 CSS in JS 和 CSS Module 有本质上的区别, CSS Module 是通过改写选择器的名称来实现 scoped 的概念, 生成的 CSS 依然是静态的, 而 CSS in JS 则是真正意义上的动态 CSS. 我试用过 styled-component, 实在蛋痛, 没用了. 当然也有不可比拟的优点, 动态样式, 按需引入, 可惜要花时间计算 css 样式, css 样式在没有 SSR 的情况下体验难以评估(毕竟 CSS 都是内嵌在 JS 中, 要等到关键 CSS 运行完才能加载完成), 感觉坑很多, 没看了.&lt;/p&gt;
&lt;h2&gt;技巧&lt;/h2&gt;
&lt;h3&gt;FlexBox trick&lt;/h3&gt;
&lt;p&gt;在使用 flexbox 时有一个非常常见的需求, 要求 flex 项目保持一定的间距, 但是最右的项目希望紧贴 container 的右侧. 通常的做法并不能满足这个要求&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;assets/2929ad9e-c414-4c1f-ab82-68fa43aee023&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;在上面这个例子中, 右侧边距为 child 右边距加上容器右边距, 没办法和左侧一致. 一个办法是, 将 child 的左右边距设置为一致, 但是这个行为违反直觉, 也会为左右边距变得更宽, 不是太合理. 另一种做法, 则可以给上层 container 设置一个和 child 右边距一致的负右边距, 让他在视觉上将这种效果抵消&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;assets/fc74c98f-22cd-dba7-8a0e-03e0878c9f17&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;上述例子中, container 设置负右边距, 使得在视觉上抵消了 child 的右边距.&lt;/p&gt;
&lt;h2&gt;最佳实践&lt;/h2&gt;
&lt;h3&gt;CSS Module 命名 使用&lt;/h3&gt;
&lt;p&gt;vue-loader 有箱即用的&lt;a href=&quot;https://vue-loader.vuejs.org/zh/guide/css-modules.html#%E7%94%A8%E6%B3%95&quot;&gt;CSS Module 支持&lt;/a&gt;, 这会向 vue 组件中注入一个$style 的变量. 在 react 中, 通常是直接 import *.module.css 以支持 CSS Module,&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;./another-stylesheet.css&quot;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Import regular stylesheet&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Button&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Component&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;render&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// reference as a js object&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;button&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;className&lt;/span&gt;&lt;span class=&quot;token script language-javascript&quot;&gt;&lt;span class=&quot;token script-punctuation punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;styles&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;Error Button&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;button&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我看了很多的示例, 基本都是使用点号作为属性访问器, 一般建议使用”_“作为单词分隔符. 但是我还是建议使用[]作为属性访问器.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;使用[]访问能支持 old-fashion 的 css 编写方式, 特别是”-“的使用.&lt;/li&gt;
&lt;li&gt;阅读性&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;assets/7dca8732-4353-b2ff-03d6-d33f6183576d&quot; alt=&quot;img&quot;&gt;&lt;img src=&quot;assets/906ec645-e77e-ae7f-e9e6-15ef9e5edd7b&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;上图分别是在 vue 中使用 CSS Module 的点号和方括号的比较. 可以看到使用方括号有更好的阅读性, 更像原来 css 的写法.&lt;/p&gt;
&lt;p&gt;在这基础上我建议使用尽可能短的 CSS Module 对象名, 例如上面我是用”s”代替冗长的”$style”, 这个可以在&lt;code class=&quot;language-text&quot;&gt;&amp;lt;style module=&amp;quot;s&amp;quot;&amp;gt;&lt;/code&gt;中这样设置. 这只是 computed 的一个语法糖, 但是可以大幅提可读性.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  computed&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;$style
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;CSS Module 最佳侵入实践&lt;/h3&gt;
&lt;p&gt;在开发时有时候会有改变第三方组件的样式的需求, 如何可以在不影响其他地方的第三方组件样式改变独立样式就变得可以研究. 答案是使用 CSS Module 的&lt;a href=&quot;https://github.com/css-modules/css-modules#exceptions&quot;&gt;:global 特性&lt;/a&gt;. 首先需要真正理解 CSS Module 只是通过改选择器的名称来形成 scope, global 特性则刚好相反, 他会形成不具有 scope 特性的 css 选择器.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;css&quot;&gt;&lt;pre class=&quot;language-css&quot;&gt;&lt;code class=&quot;language-css&quot;&gt;&lt;span class=&quot;token selector&quot;&gt;.special&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token selector&quot;&gt;:global(.internal-component-name)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;display&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; none&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上面是一个使用:global 影响第三方组件样式的例子, 首先通过一个 css module 选择器来包裹这个第三方组件, 形成 scope, 在 scope 内部再改变第三方组件的样式. 它最终会影响形如&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;special-&amp;lt;css module hash&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;interal-component-name&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;的组件, 而不会影响到原有的组件.&lt;/p&gt;
&lt;h3&gt;等比例自适应&lt;/h3&gt;
&lt;p&gt;利用 padding-bottom 的百分比属性是相对于宽度的特点, 将一个容器实现宽度自适应, 高度等比例的效果.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;assets/a61b9eda-4f8f-a568-c5c3-0ce50874785a&quot; alt=&quot;img&quot;&gt;&lt;img src=&quot;assets/190b75c4-8ef1-4976-4fbe-5953daabaf37&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;例如在上述案例中, 希望中心视频的比例是固定 1.78:1 的效果, 在原先的设定中, width 设定为 345, height 设定为 194, 但是由于宽度是可变的, 导致在宽度变化时, 视频容器的比例也变化了, 解决办法是使用 padding-top, 先将容器的比例固定, 同时需要设定 height = 0 来配合, 这部分高度被 padding-top 占据了&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;assets/4908329e-248b-cc5c-78e5-6782cc5af727&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;css&quot;&gt;&lt;pre class=&quot;language-css&quot;&gt;&lt;code class=&quot;language-css&quot;&gt;&lt;span class=&quot;token selector&quot;&gt;video-wrapper&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 100%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 0&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;padding-top&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 56.18%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; // 1&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 1.78
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;assets/c1b8841c-0083-f35b-6bbf-3fc1d7c5b846&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;同时这部分高度是不属于子容器的高度的, 需要调整子容器 postion 为相对于父容器 absolute,&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;css&quot;&gt;&lt;pre class=&quot;language-css&quot;&gt;&lt;code class=&quot;language-css&quot;&gt;&lt;span class=&quot;token selector&quot;&gt;video-wrapper&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; relative&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 100%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 0&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;padding-top&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 56.18%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; // 1&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 1.78
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token selector&quot;&gt;video&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 100%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 100%&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; absolute&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://www.google.com/url?sa=t&amp;#x26;rct=j&amp;#x26;q=&amp;#x26;esrc=s&amp;#x26;source=web&amp;#x26;cd=&amp;#x26;ved=2ahUKEwj3pore3PjpAhV0yIsBHYP5DmYQFjAAegQIBRAB&amp;#x26;url=https%3A%2F%2Fjuejin.im%2Fpost%2F5b0784566fb9a07abd0e14ae&amp;#x26;usg=AOvVaw1SO2l68MxeVcbLKOAasfQZ&quot;&gt;CSS 实现宽高等比例自适应矩形- 掘金&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.google.com/url?sa=t&amp;#x26;rct=j&amp;#x26;q=&amp;#x26;esrc=s&amp;#x26;source=web&amp;#x26;cd=&amp;#x26;ved=2ahUKEwj3pore3PjpAhV0yIsBHYP5DmYQFjADegQIBBAB&amp;#x26;url=http%3A%2F%2Fwww.alloyteam.com%2F2015%2F05%2Fcss%E4%B8%AD%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E5%AE%B9%E5%99%A8%E6%8C%89%E6%AF%94%E4%BE%8B%E7%BC%A9%E6%94%BE%2F&amp;#x26;usg=AOvVaw1pMmgdUJCZgqKVsntPAEeB&quot;&gt;css 中如何做到容器按比例缩放– AlloyTeam&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[图片优化相关]]></title><description><![CDATA[前言 在部分场景下, 设计器可能会在滚动过程中造成严重影响体验的卡顿【pc—页面滚动到一个放了十几张超过 1m…]]></description><link>https://pakholeung37.github.io/图片优化相关/</link><guid isPermaLink="false">https://pakholeung37.github.io/图片优化相关/</guid><pubDate>Sun, 31 May 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;前言&lt;/h2&gt;
&lt;p&gt;在部分场景下, 设计器可能会在滚动过程中造成严重影响体验的卡顿&lt;a href=&quot;https://www.tapd.cn/30747598/bugtrace/bugs/view?bug_id=1130747598001029787&quot;&gt;【pc—页面滚动到一个放了十几张超过 1m 的图片的多图文模块时就会卡顿】&lt;/a&gt;在本次案例中, 将针对多图文模块进行优化, 希望通过这次优化, 提供普适的解决方案.&lt;/p&gt;
&lt;h2&gt;图片懒加载&lt;/h2&gt;
&lt;p&gt;图片懒加载应该是非常常用的技术, 目前的技术方案大概有原生 onscrll + 类 getBoundingClientRect api(如 offsetTop, clentHeight)之类的, 第二种是使用 IntersectionObserver API.&lt;/p&gt;
&lt;h3&gt;原生 onscroll + 类 getBoundingClientRect api&lt;/h3&gt;
&lt;p&gt;优点是各浏览器支持良好, 缺点也很明显, 这类计算位置的 api 会导致回流, 强制重绘, 可能造成页面闪烁, 并且可能引起额外的卡顿, 必须通过节流等手段降低调用频率.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/bf6721af259146e2d2315dfb7a764d17/fdaf8/20200531105917-4ea51960-edc8-4c07-8828-8f6e78a9f733.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 47.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAPoAAAD6AG1e1JrAAABdUlEQVQoz01R2Y7cIBD0///VKop2smuDMTZjwJjbt2cmG+U95TxEkUqourqqG0SxPn4C++uXz8vg4nK+ABMyADIfz7wdcdlBYIOoXQKZ9ge6xb+wy4uywU8rCACfzQtK4G8mSOO0jdoGmxaXlsHn4r/Nq/EJI9N6YI++Bm0o5/OprEcLyuASbgdu06xdLLbnF5Ln1+84b1woG2fj8xgmmGA1QJjUiFjEiRZEaby2mBULPNWlOUyrGt2NlI2803tbi5ZJUfcdOBUXUFZtA4XrnggOwmRXdFKr0Q82dFp3M9fnXe5Cnb1+9P0u5CHMUymIh7j04+pe/BAwFKzr8Yb5eOkQfugbn1g7MZzi6Jpcs0BYpEAdqtY1IXkeGfUl9RVPdXHXZowTPkNa+6Heeax5pE0gSlWtKetI2lw3oUKgtSwE3zjSJMoxN9JC+mzSavLWjva7vFWeVp6UYyXevhF+K1PdzG3pyIctqWGD8+VISWR1aj4d+QPTxNTpjIdfXQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;img&quot;
        title=&quot;img&quot;
        src=&quot;/static/bf6721af259146e2d2315dfb7a764d17/fcda8/20200531105917-4ea51960-edc8-4c07-8828-8f6e78a9f733.png&quot;
        srcset=&quot;/static/bf6721af259146e2d2315dfb7a764d17/12f09/20200531105917-4ea51960-edc8-4c07-8828-8f6e78a9f733.png 148w,
/static/bf6721af259146e2d2315dfb7a764d17/e4a3f/20200531105917-4ea51960-edc8-4c07-8828-8f6e78a9f733.png 295w,
/static/bf6721af259146e2d2315dfb7a764d17/fcda8/20200531105917-4ea51960-edc8-4c07-8828-8f6e78a9f733.png 590w,
/static/bf6721af259146e2d2315dfb7a764d17/fdaf8/20200531105917-4ea51960-edc8-4c07-8828-8f6e78a9f733.png 674w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;IntersectionObserver&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API&quot;&gt;Intersection Observer&lt;/a&gt; API 提供了一种异步观察目标元素与祖先元素或顶级文档&lt;a href=&quot;https://developer.mozilla.org/zh-CN/docs/Glossary/Viewport&quot;&gt;viewport&lt;/a&gt;的交集中的变化的方法。利用这个 api 可以实现懒加载. 优点是使用浏览器的 api, 只有回调的部分是在主线程运行, 更快更高效. 缺点是在 IE 和低版本 Safari 支持不佳. 当然为了支持低版本, w3c 提供了&lt;a href=&quot;https://github.com/w3c/IntersectionObserver/tree/master/polyfill&quot;&gt;polyfill&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1725ffe00c17149cd8a4f3b06e8a2e06/9bb7a/20200531105917-74697407-d67d-4b90-8a62-d361366e2f62.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 65.54054054054055%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAPoAAAD6AG1e1JrAAACEklEQVQoz01RWbKcMAzk/gdL5TEDNjZesfFuY5h5S5IDRPM+UlF1UY2Q1C009PcvwPX5O5TD+HQ8PwE2FgCQ9vgo5zMdFxAog+TmE5B6vcPX4V+zL4faQ6gdiC/NhuzK8Xqt3YaiXZTWwVO74HIDmJCH/5VhMIzM/XE8PzYXYztBELh2HmZtPoIsuIMylyuQ4fz4BXh8/QGRVW6hdJeaz83GvMeyxwpGNpe+m19tO5A9mlCMywOsBACFPdUf94kIiRjHjBMmFi4wF/O6ziuD/ETpwhXT20xXyBMhBumTDmWLFQlJIpKX4MfKMqkLto6yk8nO1SnEyVVVIUbVhehMHEyefNBgI1aTGlaKZKyeQl5cVNIprrvZz11cVF1cPth2qFZbOqLukl9UP/mwGjfJjbs8rQyFSZwrLQtNqOIpbtIWa5oGKd5XVUSGSNllux0SMgPRlsHu/QF73uzbkubJjZN5i7eR6xuOWAdBMyYFsUD9d2ineWBLRoPYI9yzXe+I89mNoq9rI8jd8jxpg5aGSEWsUX4QmTnIAkTiS515owPVFgntS4dfejM/wTOYn+wYbqNQdxRmYjHNCykYlIMPENwwbGcCyosyE1N7aoi9mklC0z7ezZsfRy7B9qKCJAlD6eqJd9+2dyVetueB20CNgzu/LuzvrBGcZuzvBd03g0jDkIHj8U5V4SXnkovMglbED/oXA9aiytJ/HDwAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;img&quot;
        title=&quot;img&quot;
        src=&quot;/static/1725ffe00c17149cd8a4f3b06e8a2e06/fcda8/20200531105917-74697407-d67d-4b90-8a62-d361366e2f62.png&quot;
        srcset=&quot;/static/1725ffe00c17149cd8a4f3b06e8a2e06/12f09/20200531105917-74697407-d67d-4b90-8a62-d361366e2f62.png 148w,
/static/1725ffe00c17149cd8a4f3b06e8a2e06/e4a3f/20200531105917-74697407-d67d-4b90-8a62-d361366e2f62.png 295w,
/static/1725ffe00c17149cd8a4f3b06e8a2e06/fcda8/20200531105917-74697407-d67d-4b90-8a62-d361366e2f62.png 590w,
/static/1725ffe00c17149cd8a4f3b06e8a2e06/9bb7a/20200531105917-74697407-d67d-4b90-8a62-d361366e2f62.png 676w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;方案&lt;/h2&gt;
&lt;p&gt;在目前的解决方案中, 使用的是 IntersectionObserver 的方案,并且不带 polyfill, 因为造成卡顿的主要原因并不是图片有没有使用懒加载. 而且 polyfill 本身可能引入额外的开销和性能问题, 在权衡下, 这次方案中没有加入 polyfill, 也没有加入 polyfill 的规划.实现懒加载的代码位于 editor.js/plugins/lazyload.&lt;/p&gt;
&lt;h2&gt;如何使用&lt;/h2&gt;
&lt;h3&gt;普通&lt;/h3&gt;
&lt;p&gt;由于在本次实现中引入了一个专门处理设计器#miniApp(目前只支持主页, 自定义页)的图片懒加载指令 v-mp-lazy, 只需要在要使用懒加载的 img 标签或其他标签(默认转化为 style:backgroundImage)添加 &lt;code class=&quot;language-text&quot;&gt;v-mp-lazy=&amp;quot;&amp;lt;your image src&amp;gt;&amp;quot;&lt;/code&gt; 指令即可使用懒加载. 和小程序一样, 这个懒加载是上下一屏, 总共 3 屏的加载.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;image-wrapper&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;v-mp-lazy&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;https://abcde.com/abcd.jpg&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;进阶&lt;/h3&gt;
&lt;p&gt;你可能会有特殊的需求, 例如在一个#miniApp 下的一个滚动列表使用懒加载, 这时候, 你需要直接调用 v-lazy-contianer 这个指令, 这个指令可以帮助将这个 container 标记一个父容器. 在他里面的懒加载容器需标记为 v-lazyload. 其实会发现 v-mp-lazy 也是用这种方式实现的, 在 plugins/lazyload/install.js 里同样定义了一个 v-mp-lazy-container 指令以标记父容器.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;// parentContainer.vue
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt;
  &lt;span class=&quot;token attr-name&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;parent-container&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token attr-name&quot;&gt;v-lazy-container&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;{
  name: &amp;lt;your container name&gt;,
  options: &amp;lt;ObserverOptions without root&gt;
}&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
// childContainer.vue
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt;
  &lt;span class=&quot;token attr-name&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;child-container&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token attr-name&quot;&gt;v-lazyload&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;{ name: &amp;lt;name&gt;, src: &amp;lt;your image src&gt; }&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;然后你会发现什么都不会发生, 因为这部分逻辑还没实现, 你可以按照这个接口的模式, 在 plugins/lazyload/install.js 文件下完成你的实现:)&lt;/p&gt;
&lt;p&gt;如果上面的形式满足不了你(例如无法标记父容器), 你也可以使用编程式完成懒加载, 具体 api 可以参考 plugins/lazyload/lazyload.js 下的注释&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;vue&quot;&gt;&lt;pre class=&quot;language-vue&quot;&gt;&lt;code class=&quot;language-vue&quot;&gt;// example // parentContainer.vue
&amp;lt;script&amp;gt;
import { LazyLoad } from &amp;quot;plugins/lazyload&amp;quot;;
  somefuncition() {
    window._lazyload = new LazyLoad({ dataSrc: &amp;quot;data-sth-src&amp;quot; });
    window._lazyload.startObserve({
      root: $(&amp;quot;#parent-container&amp;quot;),
      rootMargin: &amp;quot;200px 0px&amp;quot;,
      threshold: 0,
    })
}
&amp;lt;/script&amp;gt;

// childContainer.vue
&amp;lt;div class=&amp;quot;#child=container&amp;quot;&amp;gt;
  &amp;lt;div class=&amp;quot;image-wrapper&amp;quot; data-sth-src=&amp;quot;https://abcd.com/abcd.jpg&amp;quot;&amp;gt;&amp;lt;/div&amp;gt;
&amp;lt;/div&amp;gt;
&amp;lt;script&amp;gt;
somefuncition() {
   window._lazyload.addTarget($(&amp;quot;#child-container .image-wrapper&amp;quot;));
}
&amp;lt;/script&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;使用这个方法的重点在于, 必须保证在调用相关方法时父容器或子容器已经插入都 dom 中, 否则将无法完成 observe, 另外 lazyload 实例的生成也要考虑到, 最重要的是, 你可能需要手动调用 Lazyload.removeTarget, LazyLoad.destroy 以避免可能存在的内存泄漏. 不过 startObserve 和 addTarget 的调用时机就没有什么考究, 因为 LazyLoad 里面使用了 cache, 所以即便在 observer 未生成时你也可以将观察对象加进去.&lt;/p&gt;
&lt;h2&gt;渲染&lt;/h2&gt;
&lt;p&gt;设计器卡顿的主要原因应当是页面渲染问题. 我测试用到的是 7 张 5000px × 5000px 的图片, 每张的图片只有 100k 左右, 在页面滚动的时候, 可以看到, 主线程几乎被绘制合成过程塞爆, 鉴于我每张图片其实很小, 所以其实和图片大小是没什么关系的, 主要是因为图片像素大, 绘制合成层时间长导致的主线程阻塞.&lt;/p&gt;
&lt;h3&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/64af89578a8ff5eb62c8d7f0c9d83acb/321ea/20200531105917-3ef124a3-22c3-4ca6-8a66-6130d5146a93.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAAzElEQVQI1xWMy27CQAxF8/+f0kJVQVEUqbSbLisWiJBGhUAmYcbjx8yQhK7rWEeWde+RM2OMB+8cMAsAeE8iQUSMS3Vjzx13lglJmxiSOiGkaXpY55g5u8fIQkkXquWjIPnbYwjtzc0/PZq+T+IJ7HiXFDAwDIkmnXHIQqKe2u/L1+bwVLn9R73Jy0VRvnzWq/dqVRyXRbnY/rxtq3VxfM3LZX541nz6G/ftLmspNA7PCmAD1ABfQQzGk8XfGa/HjMOOorZqnpyGtjbXf/oa0xPc5N0gAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;img&quot;
        title=&quot;img&quot;
        src=&quot;/static/64af89578a8ff5eb62c8d7f0c9d83acb/fcda8/20200531105917-3ef124a3-22c3-4ca6-8a66-6130d5146a93.png&quot;
        srcset=&quot;/static/64af89578a8ff5eb62c8d7f0c9d83acb/12f09/20200531105917-3ef124a3-22c3-4ca6-8a66-6130d5146a93.png 148w,
/static/64af89578a8ff5eb62c8d7f0c9d83acb/e4a3f/20200531105917-3ef124a3-22c3-4ca6-8a66-6130d5146a93.png 295w,
/static/64af89578a8ff5eb62c8d7f0c9d83acb/fcda8/20200531105917-3ef124a3-22c3-4ca6-8a66-6130d5146a93.png 590w,
/static/64af89578a8ff5eb62c8d7f0c9d83acb/321ea/20200531105917-3ef124a3-22c3-4ca6-8a66-6130d5146a93.png 786w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;通过添加 translateZ 黑魔法, 这个属性可以提升这些图片层级, 强制使用 GPU 来渲染这图层, 所以也会导致更快的渲染, 并且不会阻塞主进程.&lt;/p&gt;
&lt;p&gt;当然你也可以把&lt;a href=&quot;https://developer.mozilla.org/zh-CN/docs/Web/CSS/will-change&quot;&gt;will-change&lt;/a&gt;加上, 但是这个属性我控制不好, 可能会导致负优化, 没加.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;css&quot;&gt;&lt;pre class=&quot;language-css&quot;&gt;&lt;code class=&quot;language-css&quot;&gt;&lt;span class=&quot;token selector&quot;&gt;.image-wrapper&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;transform&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;translateZ&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/6d43cb556a173ce640786e42cbdc7446/0a47e/20200531105917-0ef3e9c9-00f4-45e6-abb3-c3161c092c04.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 18.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAPoAAAD6AG1e1JrAAAAwElEQVQI1w2K2W7DIBAA/f9/10aN4sQHNrC7LMYcAYe6Dy4vo5FmunyU8zzZGetLPrK0a6015tgk1mAi6U01gV3TjrHGdm6JvffjMHaf8whvb5J0uda/jwrzdV35N4ntpaKQfl79BGlpVEFwgVSDLZBLuvVfHTuLhoBgMZ7croFcitbvQq5KgwZUCKtWgO0hicjOARtt4Pt+6+5qeRE89PrULBiExR6X0SjBOBkYCCamJ8LMuGzY6kBytjSB+ukf/1QD2m9KH2cxAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;img&quot;
        title=&quot;img&quot;
        src=&quot;/static/6d43cb556a173ce640786e42cbdc7446/fcda8/20200531105917-0ef3e9c9-00f4-45e6-abb3-c3161c092c04.png&quot;
        srcset=&quot;/static/6d43cb556a173ce640786e42cbdc7446/12f09/20200531105917-0ef3e9c9-00f4-45e6-abb3-c3161c092c04.png 148w,
/static/6d43cb556a173ce640786e42cbdc7446/e4a3f/20200531105917-0ef3e9c9-00f4-45e6-abb3-c3161c092c04.png 295w,
/static/6d43cb556a173ce640786e42cbdc7446/fcda8/20200531105917-0ef3e9c9-00f4-45e6-abb3-c3161c092c04.png 590w,
/static/6d43cb556a173ce640786e42cbdc7446/0a47e/20200531105917-0ef3e9c9-00f4-45e6-abb3-c3161c092c04.png 600w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;这种方法只是一种 hack, 并不代表这个属性可以滥用, 最好的方法还是使用缩略图.&lt;/p&gt;
&lt;h2&gt;one more thing&lt;/h2&gt;
&lt;p&gt;本次提交中有一个 mpImage 组件, 位于/components/mpImage/, 这个组件的本意是保持和小程序&lt;code class=&quot;language-text&quot;&gt;&amp;lt;image&amp;gt;&lt;/code&gt;的同构实现的, 这次也将其中的懒加载换成 v-mp-lazy. 总之将他当成小程序的&lt;code class=&quot;language-text&quot;&gt;&amp;lt;image&amp;gt;&lt;/code&gt;标签使用即可&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;vue&quot;&gt;&lt;pre class=&quot;language-vue&quot;&gt;&lt;code class=&quot;language-vue&quot;&gt;// mode
&amp;lt;mp-image src=&amp;quot;http://abcde.com/abcd.jpg&amp;quot; mode=&amp;quot;aspectFill&amp;quot;&amp;gt;&amp;lt;/mp-image&amp;gt;
// lazyload
&amp;lt;mp-image src=&amp;quot;http://abcde.com/abcd.jpg&amp;quot; lazy-load&amp;gt;&amp;lt;/mp-image&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://developer.mozilla.org/zh-CN/docs/Web/API/IntersectionObserver&quot;&gt;Intersection Observer - Web API 接口参考| MDN&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/94426820&quot;&gt;IntersectionObserver 和图片懒加载 - 知乎专栏&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://developers.weixin.qq.com/miniprogram/dev/component/image.html?search-key=lazy-load&quot;&gt;image | 微信开放文档 - 微信开放社区 - 腾讯&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/tuupola/lazyload&quot;&gt;tuupola/lazyload: Vanilla JavaScript plugin for … - GitHub&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/hilongjw/vue-lazyload&quot;&gt;hilongjw/vue-lazyload: A Vue.js plugin for lazyload … - GitHub&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://developers.google.com/web/fundamentals/performance/rendering/stick-to-compositor-only-properties-and-manage-layer-count?hl=zh-cn&quot;&gt;坚持仅合成器的属性和管理层计数 - google developers&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.google.com/url?sa=t&amp;#x26;rct=j&amp;#x26;q=&amp;#x26;esrc=s&amp;#x26;source=web&amp;#x26;cd=&amp;#x26;ved=2ahUKEwi-jfyYydjpAhXQyosBHWB0AiAQFjAJegQIBxAB&amp;#x26;url=https%3A%2F%2Fjuejin.im%2Fpost%2F5bdd9c506fb9a049f069b296&amp;#x26;usg=AOvVaw1c_843nYCbOK9AGG39Ks5W&quot;&gt;用 CSS 开启硬件加速来提高网站性能- 掘金&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://juejin.im/entry/59dc9aedf265da43200232f9&quot;&gt;详谈层合成（composite） - 掘金&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://juejin.im/post/5da52531518825094e373372&quot;&gt;浏览器层合成与页面渲染优化&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://aerotwist.com/blog/on-translate3d-and-layer-creation-hacks/&quot;&gt;On translate3d and layer creation hacks - aerotwist&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://medium.com/@dan_abramov/you-might-not-need-redux-be46360cf367&quot;&gt;You Might Not Need Redux&lt;/a&gt;)&lt;/p&gt;</content:encoded></item><item><title><![CDATA[twilight: patternMatch code review & explaination]]></title><description><![CDATA[前言 patternMatch…]]></description><link>https://pakholeung37.github.io/twilight patternMatch code review &amp; explaination/</link><guid isPermaLink="false">https://pakholeung37.github.io/twilight patternMatch code review &amp; explaination/</guid><pubDate>Tue, 19 May 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;前言&lt;/h2&gt;
&lt;p&gt;patternMatch 是一个进行类正则的模式匹配类, 再设计中, 可以利用这个类来完成模块组合的一些限制功能, 例如限制一个组件的子节点是某几种组件,限制一个组件能添加的有限个子节点. 限制一个子组件只能出现在一个组件中有限次等等. 其中的原理和正则几乎的一样, 就是基于所给模式构造一个确定有限状态自动机.&lt;/p&gt;
&lt;p&gt;在&lt;a href=&quot;https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E7%90%86%E8%AE%BA&quot;&gt;计算理论&lt;/a&gt;中，&lt;strong&gt;确定有限状态自动机&lt;/strong&gt;或&lt;strong&gt;确定有限自动机&lt;/strong&gt;（英语：deterministic finite automaton, DFA）是一个能实现状态转移的&lt;a href=&quot;https://zh.wikipedia.org/wiki/%E8%87%AA%E5%8A%A8%E6%9C%BA&quot;&gt;自动机&lt;/a&gt;。对于一个给定的属于该自动机的状态和一个属于该自动机字母表{\displaystyle \Sigma }的字符，它都能根据事先给定的转移函数转移到下一个状态（这个状态可以是先前那个状态）。&lt;/p&gt;
&lt;h2&gt;重点类/方法/类型解析&lt;/h2&gt;
&lt;h3&gt;NodeSchema&lt;/h3&gt;
&lt;p&gt;nodeSchema 是对具体节点的描述, 通常必须具有 type 唯一标志, children 描述子元素的模式, 和 groups 表示所属组别.&lt;/p&gt;
&lt;h3&gt;PatternMatch parse&lt;/h3&gt;
&lt;p&gt;输入一个模式匹配串和一个节点定义表, 输出一个可对输入进行匹配的自动机. 是外部使用的接口类. 通过这个类就能判断输入的新的组件是否符合模式.&lt;/p&gt;
&lt;p&gt;里面最主要用到了几个算法, 一个是 parseExpr, 可以将一个处理过的表达式转化为 AST, 另一个是使用 nfa 和 dfa 将这个 AST 进一步转化成可用于匹配的对象.&lt;/p&gt;
&lt;h3&gt;dfa&lt;/h3&gt;
&lt;p&gt;dfa 最重要的作用是把一个 nfa 转化成一个 dfa, 并且这个 dfa 就是一个可供最后匹配的自动机, 暂时没细看具体实现.&lt;/p&gt;
&lt;h3&gt;nfa&lt;/h3&gt;
&lt;p&gt;这个方法可以将模式串转化成一个 nfa, 比较重要, 主要是建立状态转换表并返回.&lt;/p&gt;
&lt;h2&gt;运作&lt;/h2&gt;
&lt;p&gt;首先这里比较重要的是定义自己的 NodeSchema, 例如以下 schema&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; ArticleList &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ArticleList&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  children&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Article*&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; Article &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Article&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  group&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;atom&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; Swiper &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Swiper&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  children&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Slide*&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; Slide &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Slide&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  children&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Container+&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; Container &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Container&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  children&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;然后可以使用一个 createSchema 方法将这些 nodeschemazhuang 转化成一个键值对, 用一个对象表示, 这个对象就是模式匹配要用到的 schema 对象. 编译器会在模式串上面链接这个 schema 对象, 在 parseExpr 的 parseExprAtom 阶段, 符合条件的 NodeSchema 会链接到 NameExpression 上&lt;/p&gt;</content:encoded></item><item><title><![CDATA[tiny compiler - code review]]></title><description><![CDATA[original: the-super-tiny-compiler.js]]></description><link>https://pakholeung37.github.io/tiny compiler - code review/</link><guid isPermaLink="false">https://pakholeung37.github.io/tiny compiler - code review/</guid><pubDate>Sat, 16 May 2020 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;original: &lt;a href=&quot;https://github.com/jamiebuilds/the-super-tiny-compiler/blob/master/the-super-tiny-compiler.js&quot;&gt;the-super-tiny-compiler.js&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;/* the tiny compiler */&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;/**
 * 前言, 工作以来, 编译原理忘记的差不多, 其实会发现编译原理真的是一门很重要的技术
 * 不仅包含软件工程, 程序设计这些概念. 在前端有很多库其实都需要一定的编译原理的概念
 * 和应用. 例如Babel, webPack各种css, js loader, vue内置的template, uniapp, wepy,
 * taro这些小程序框架, editor的实现等等, 基本上比较大的框架和库基本都有编译原理的影子,
 * 包括我工作的小程序模板等等, 其实都有些编译原理的概念, 这里从这个tiny-compiler做个
 * 索引, 抛砖引玉, 一步步重建编译器的构造思维, 技术框架和具体实现.
 *
 */&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;/**
 * tokenizer最重要的功能是take every step, 然后组成单词, 根据语义生成token,
 * 这部分的概念主要是状态机的代码编写,状态机方案有很成熟的例子,
 * 也可以通过正则来完成状态机. 我记得是由根据规则生成tokenizer的程序
 * 比较基础, 在实际应用中, 除非构建到非常低级的语言
 * 不然基本不可能到这一步, 所以tokenizer这部分,就不用怎么看.
 */&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;tokenizer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; current &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; tokens &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;current &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; char &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;char &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;(&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      tokens&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;paren&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        value&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;(&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      current&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;char &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;)&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      tokens&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;aren&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        value&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;)&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      current&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;WHITESPACE&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token regex&quot;&gt;/\s/&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;WHITESPACE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;char&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      current&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;NUMBERS&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token regex&quot;&gt;/[0-9]/&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;NUMBERS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;char&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;NUMBERS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;char&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        value &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; char
        char &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      tokens&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;number&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;char &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&quot;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;
      char &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;char &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&quot;&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        value &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; char
        char &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      char &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      tokens&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;string&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;LETTERS&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token regex&quot;&gt;/[a-z]/i&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;LETTERS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;char&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;
      &lt;span class=&quot;token comment&quot;&gt;/**
       * 这里展现状态机一个循环结构, 实际上也需要这样来实现。
       */&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;LETTERS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;char&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        value &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; char
        char &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; input&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      tokens&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;continue&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TypeError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;invaild char&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; tokens
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/**
 * parser是语言从具体编写的代码转换到AST的过程.
 * 例如vue的template -&gt; virtual DOM(virtual DOM从这个结构上来说就是AST了)
 * 例如svlete compile时开启ast的结果, 其实都是AST. AST是抽象语法树的(Abstract Syntax Tree)
 * 缩写, 在编译原理中是一种中间形式的具体实现, 不过现在都是用AST了.
 */&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;tokens&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; current &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;walk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; token &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; tokens&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;token&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;number&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      current&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;NumberLiteral&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        value&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; token&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tokens&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;paren&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; tokens&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;(&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      token &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; tokens&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; node &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;CallExpression&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        name&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; tokens&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        params&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      token &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; tokens&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        token&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;paren&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;token&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;paren&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; token&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;)&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;params&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;walk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        token &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; tokens&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;current&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
      current&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; node
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TypeError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;token&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; ast &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Program&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    body&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;/**
   * 这个parser是递归结构, 可以看到其实tokenizer输出的tokens是一个线性序列
   * 到了parser这一步是通过递归, 转化成树结构了, walk这个表明parser
   * 是每次读一个token step by step进行的, 所以, 有多少个token, 就有多少个节点.
   * 当然这依赖于具体实现. 合并多个token到一个节点, 也是可以的.
   *
   */&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;current &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; DOMSettableTokenList&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    ast&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;body&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;walk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; ast
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/**
 * traverser应当是处理核心业务最重要的过程, 基本上核心的业务, 都是在这个遍历器上操作
 * 例如babel, svelte, loader的插件, 都有钩子去实现一些外部逻辑, 这个过程就是深度优先遍历整个语法树
 * 通过这个过程你可以改造语法树, 添加叶节点, 优化语法树等. 我个人很喜欢这个enter, exit的钩子设计
 * 可以做到编译器和比较重的一些优化, 代码检查等逻辑解耦.
 */&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;traverser&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;ast&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; visitor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;traverseArray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;array&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; parent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;child&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;traverseNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;child&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; parent&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;traverseNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;node&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; parent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; methods &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; visitor&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;methods &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; methods&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;enter&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      methods&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;enter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; parent&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Program&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;traverseArray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;body&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; node&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;CallExpression&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;traverseArray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;params&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; node&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;NumberLiteral&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;StringLiteral&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;break&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;methods &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; methods&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exit&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      methods&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; parent&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;traverseNode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ast&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/**
 * 语法树转换器, 这部分主要还是上面提到的利用遍历器对语法树进行修改的方法,
 * 这里是直接将语法树生成为目标语言的语法树既是 subject AST =&gt; target AST的实现
 */&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;transformer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;ast&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; newAst &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Program&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    body&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  ast&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_context &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; newAst&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;body
  &lt;span class=&quot;token function&quot;&gt;traverser&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ast&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    NumberLiteral&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;enter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;node&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; parent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;NumberLiteral&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          value&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    StringLiteral&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;enter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;node&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; parent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;StringLiteral&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          value&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    CallExpression&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;enter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;node&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; parent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; expression&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; any &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;CallExpression&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          callee&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Identifier&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            name&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          arguments&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; expression&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;arguments
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;CallExpression&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          expression &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            type&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ExpressionStatement&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            expression&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; expression&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;_context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;expression&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; newAst
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/**
 * codegen 也没什么好说的, 主要是用AST生成目标语言的具体代码.
 */&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;codeGenerator&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Program&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;body&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;codeGenerator&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ExpressionStatement&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;codeGenerator&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;expression&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;;&quot;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;callExpression&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;codeGenerator&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;callee&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;(&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;arguments&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;codeGenerator&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;, &quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;)&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Identifier&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;NumberLiteral&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;StringLIteral&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&quot;&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;&quot;&apos;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TypeError&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;type&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;compiler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; tokens &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;tokenizer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; ast &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parser&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;tokens&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; newAst &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;transformer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ast&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; output &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;codeGenerator&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;newAst&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; output
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[react 最佳实践]]></title><description><![CDATA[状态管理方案 状态管理一直是前端框架重中之重, 选择合适的状态管理框架能有效提高效率, 提高项目可维护性, 状态可预测性. 很头痛的是 react 可选的方案实在太多. 以前用过一段时间的 redux + redux-thunk, 模板代码略多 redux…]]></description><link>https://pakholeung37.github.io/react 最佳实践/</link><guid isPermaLink="false">https://pakholeung37.github.io/react 最佳实践/</guid><pubDate>Tue, 12 May 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;状态管理方案&lt;/h2&gt;
&lt;p&gt;状态管理一直是前端框架重中之重, 选择合适的状态管理框架能有效提高效率, 提高项目可维护性, 状态可预测性.&lt;/p&gt;
&lt;p&gt;很头痛的是 react 可选的方案实在太多. 以前用过一段时间的 redux + redux-thunk, 模板代码略多&lt;/p&gt;
&lt;h3&gt;redux&lt;/h3&gt;
&lt;p&gt;原生坦克, 不配备弹药. 不可置否 redux 很优秀, 与其说他是一个状态管理库, 不如说是状态管理框架. 必须配备额外的库才能体现出 redux 的强大. 强硬的 action creator 蛋疼的 typescript 支持都让原生 redux 非常难用. 围绕一个 action 通常需要编写 acition, creator, reducer, mapProps 以及额外代码 typescript 支持. 使用原生 redux 给我一种过度设计的感觉.&lt;/p&gt;
&lt;h3&gt;dva&lt;/h3&gt;
&lt;p&gt;redux + redux-saga + react-router + reselect 的封装, 文档堪忧, 离开 dva-cli 啥也不是.&lt;/p&gt;
&lt;h3&gt;redux + reduxjs/toolkit&lt;/h3&gt;
&lt;p&gt;真正意义上的开箱即用的方案, 目前也是选择这种方案, 本质和 dva 一样, 是 redux + redux-thunk + reselect + immer 的封装. 但是能作为一个单独库使用. 再加上 useSelector, useDispatch 的体验感爆棚, 比各种 mapProps 高到不知道哪里去. 真正意义上的 redux best practice. 另外 immer 着实强大, 一统天下指日可待.( 不支持 iE9 )&lt;/p&gt;
&lt;h2&gt;hook first&lt;/h2&gt;
&lt;p&gt;新时代, 新架构 抛弃以往笨重的 class component 形式, 采用基于 hook 的架构是更好的选择. 其实你会发现, 基于 hook 的 react component 其实和 svelte 很像, 官方也说明了, 要跟上时代的脚步, 预编译的流行几乎板上钉钉, function component 能在往后更好的优化做铺垫, 如果现在开始写, hook 是更好的选择&lt;/p&gt;
&lt;p&gt;hook 也是更好组织代码的一种架构. 反正用就 hook 没错&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://tylermcginnis.com/why-react-hooks/&quot;&gt;Why React Hooks&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[项目管理 最佳实践]]></title><description><![CDATA[包含代码规范, git workflow, 命名规范等 eslint 使用 eslint 规范你的代码. eslint-recommanded 另外实在不建议使用 airbnb-style, 处女座可以用一下, 用过的最严格的 lint 规则 google…]]></description><link>https://pakholeung37.github.io/项目管理 最佳实践/</link><guid isPermaLink="false">https://pakholeung37.github.io/项目管理 最佳实践/</guid><pubDate>Tue, 12 May 2020 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;包含代码规范, git workflow, 命名规范等&lt;/p&gt;
&lt;h2&gt;eslint&lt;/h2&gt;
&lt;p&gt;使用 eslint 规范你的代码. &lt;a href=&quot;https://cn.eslint.org/docs/rules/&quot;&gt;eslint-recommanded&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;另外实在不建议使用 airbnb-style, 处女座可以用一下, 用过的最严格的 lint 规则&lt;/p&gt;
&lt;p&gt;google 的好像也不错.&lt;/p&gt;
&lt;p&gt;总结来说 lint 是项目管理必备的工具, 可以有效统一代码风格.&lt;/p&gt;
&lt;p&gt;另外建议注释掉 webpack 中 pre lint 的代码, 编译时不需要 lint 了, 有编辑器的提醒就足够了, 开启 lint 之后拖慢你的开发效率.&lt;/p&gt;
&lt;h2&gt;prettier&lt;/h2&gt;
&lt;p&gt;我使用 prettier 的规则很简单, 末尾强制分号, 缩进使用两个空格, 其他不强求. 主要是 preiiter 配合 vscode 可以 format On Save. 有效规范风格.&lt;/p&gt;
&lt;h2&gt;命名风格&lt;/h2&gt;
&lt;p&gt;命名最重要的是有意义, 其实看完 google javascript style 就差不多了, 其实和上面的 eslint 差不多, 不过 eslint 只是对一些代码风格的实现, 里面有更多关于 style 规范的东西, 可以看一下.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/airbnb/javascript&quot;&gt;https://github.com/airbnb/javascript&lt;/a&gt;
&lt;a href=&quot;https://google.github.io/styleguide/jsguide.html&quot;&gt;https://google.github.io/styleguide/jsguide.html&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;注释风格&lt;/h2&gt;
&lt;p&gt;大兄弟, 听说过 jsDoc 吗&lt;a href=&quot;https://google.github.io/styleguide/jsguide.html&quot;&gt;use JSDoc&lt;/a&gt;, JsDoc 不单是一种规范, 而且是必须严格执行的. 特别是一些公用的工具函数, 就必须强制编写 JsDoc 了. 不懂规范不要紧,&lt;/p&gt;
&lt;p&gt;使用 vsCode 插件 JsDoc 一步升天, 你值得拥有.&lt;/p&gt;
&lt;p&gt;另外一些注释风格也是必须遵守的.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// FIXME:  以FIXME开头的注释字段, 表明有潜在BUG需要被修复&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// !   表明注释很重要, 或方法被废弃&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// TODO 表明此方法需要被实现&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;不懂不要紧, Better Comments 插件欢迎你.&lt;/p&gt;
&lt;p&gt;![image (2)](assets/image (2).png)&lt;/p&gt;
&lt;h2&gt;副作用管理&lt;/h2&gt;
&lt;p&gt;时刻保持清晰自己写的代码是不是纯函数, 有没有副作用, 是不是异步的.&lt;/p&gt;
&lt;p&gt;在项目中经常一些在内部调用接口的函数没有回调或者返回 promise, 这是很不好的习惯. 函数纯不纯, 一定要在心中. 程序设计, 副作用无可避免, 但是可免则免.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[svelte 最佳实践]]></title><description><![CDATA[store 结构与命名 一个项目的 store 最好放在一个 store 文件夹下集中管理, 当这不是绝对的, 我见过以页面组织 store 的用法. 但是如果想让你的 store 能再所有地方方便地引用到, 最好还是集中到 store…]]></description><link>https://pakholeung37.github.io/svelte 最佳实践/</link><guid isPermaLink="false">https://pakholeung37.github.io/svelte 最佳实践/</guid><pubDate>Mon, 11 May 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;store&lt;/h2&gt;
&lt;h3&gt;结构与命名&lt;/h3&gt;
&lt;p&gt;一个项目的 store 最好放在一个 store 文件夹下集中管理, 当这不是绝对的, 我见过以页面组织 store 的用法. 但是如果想让你的 store 能再所有地方方便地引用到, 最好还是集中到 store 文件夹下.&lt;/p&gt;
&lt;p&gt;而命名最好带有明确意义的名词 例如 user.js, menu.js, session.js 等, 避免出现意义不明或者使用动词来命名. store 一般指名实体的数据, 同时也避免缓存函数, 递归等. 应当作为一个 json-like 的结构来使用, 这会使得你的 app 在现在和将来更快和更好优化.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=ff4fgQxPaO0&quot;&gt;Faster apps with JSON.parse (Chrome Dev Summit 2019)&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;形式&lt;/h3&gt;
&lt;p&gt;这里想先谈一谈 flux 和 redux.&lt;/p&gt;
&lt;p&gt;redux 作为官方指定 store 方案和 flux 实现, 是有他的过人之处的.&lt;/p&gt;
&lt;p&gt;flux 的架构说白了就是为了单向数据流.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/124ebc5f080b831c2501997a861c71d7/3c492/flux-overview.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 54.72972972972974%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAAB7klEQVQoz11Sy27UMBTNn7Eo0zJx4rycl+PYiePYmTDpdCjTQiuEhJBKN0hTNlRIsOOxQAh1xbb9hMIvID6DO6QCVOnoKrJzzr3nHlskirM0T5MsidM8o1FIXAd72N/AC5wpQpMJmmyjqX1z+B+skvHOzFqldWuMNlI2rCix62McoCmq+8Xi9Gw4XavlgWu72A3g6h+5ruRyb9nP+mG+C3V3WMi6ISFOkyCw7x6+er3+8evl9c/jdx8SfxoTL4kwdr0bMswM/KqClq2UCib3cMjyIE0IRkgt9lfr84fr82515LtuTGJWRISQG7K9vaNXx88uLp9eXO6fvUlCX6uW5bkoOaN5mBbTRGwFNEjBTbb8dLT35XB4v6KMuQhbaOde/+T5i6vrk6vvj95+LDMgNwWlvGRS5BErt2h7J5U447LJ5l8PFt8ed58f0LJwbNcCA3GcCqWFMpQJQlJecs6F4FUYxEmc1VKJumGMxyRTppWdakwL7sIgsmB07GDHRhCGj/3OdLB22P/9fi5rCcmZVmulZ11vdKeVMarjrAIPkLE1Wve9ACr8OswHWDu05aWAaziZzYBm/gTZgShgo6JNQZl1K/dRxUEuAF4L8MeeIxNS3EQjalk18K5uk8cMRwn4BmNgj+YFVGgFWn9DBvwG/E/zcFOJJ5sAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;flux overview&quot;
        title=&quot;flux overview&quot;
        src=&quot;/static/124ebc5f080b831c2501997a861c71d7/fcda8/flux-overview.png&quot;
        srcset=&quot;/static/124ebc5f080b831c2501997a861c71d7/12f09/flux-overview.png 148w,
/static/124ebc5f080b831c2501997a861c71d7/e4a3f/flux-overview.png 295w,
/static/124ebc5f080b831c2501997a861c71d7/fcda8/flux-overview.png 590w,
/static/124ebc5f080b831c2501997a861c71d7/efc66/flux-overview.png 885w,
/static/124ebc5f080b831c2501997a861c71d7/c83ae/flux-overview.png 1180w,
/static/124ebc5f080b831c2501997a861c71d7/3c492/flux-overview.png 1300w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;为了实现这种单向数据流, 其实我认为它的核心是思想是, 只有 action 能引起 store 的变化, 而只有 store 变化才会触发 view 变化. flux 本身架构是非常优秀的, 围绕 flux 也有很多实现, vue 基于这种思想也造了 vuex 的轮子. 不过问题是, 围绕剥离 action, store, dispatch 之间需要大量的模板代码.&lt;/p&gt;
&lt;p&gt;围绕 action 的构建需要大量的代码, 下面我在 react-redux 的一个练手项目写的代码, 为了剥离实际行为和 action type 而引入的 actionCreator 我认为是一种糟粕.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/fb88b0ef7ffd3fdb16c3533be72520c2/50383/image-1597999412139.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 108.1081081081081%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsSAAALEgHS3X78AAABpUlEQVQ4y51Ui5KDIAzs///qja1AiCCP3AZPz16txaPN0I6ybDab3GqtkkuRPE2SHqNk7yVQELKzeIdgFiJqu76ra92P1q0B5txeco7FOkI4sda2i/ZrD/QOdAMsOEweLNMCrv+rvB46Y/cEmOZZRBkhSq5b6AXteUrtkhX0nKFqGILE4SER6bJlcWYST1HYB2HGb2g7A7QPUDXEx7ipaUieWiF44v+nnEuWEOOLaiubPasuhlnTWTVMBZqWjXn7fmD2BJi0ytCQv+4yGSNkPHwYJca5AdYd4Bm7F9v4CUaGwT17KTV3e+845awA+8PX9XuyjaacYZmCFos8C1OCbdQyS+vN6tMrKVfEOBgxI8JYgHippf52zRWG2gXK0oe4FKgqQDk80OdDgCWkVpByRVHmn5SZUCS/pMyXpw3CG3QIOsW1iUPbFNKU/6bdNb4ssQQURwsQEaWWw67pGl+Ldn3d8Lko6kNolzFU1TarhoEz9gAJXNNQYz/CTgFVQ/Mgud9HGYZBRtjHWQf25a3BP7YeRwSsQ5h9q65HB7uKol48814vw28kWMyT7BL9eAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image&quot;
        title=&quot;image&quot;
        src=&quot;/static/fb88b0ef7ffd3fdb16c3533be72520c2/fcda8/image-1597999412139.png&quot;
        srcset=&quot;/static/fb88b0ef7ffd3fdb16c3533be72520c2/12f09/image-1597999412139.png 148w,
/static/fb88b0ef7ffd3fdb16c3533be72520c2/e4a3f/image-1597999412139.png 295w,
/static/fb88b0ef7ffd3fdb16c3533be72520c2/fcda8/image-1597999412139.png 590w,
/static/fb88b0ef7ffd3fdb16c3533be72520c2/50383/image-1597999412139.png 740w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;![image (1)](assets/image (1)-1597999422534.png)而 reduce 的方案也不是那么尽人意, 通过比对 action.type 来决定实际 sate 的改变, 似乎又是另一种模板代码. 围绕只是想改变一个值做了那么多工作, 实在让人心寒. 说实话 redux 一直给我一种理念高大上, 效果很一般的感觉. 可能我从未真正需要 redux&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;It is natural to compare Redux to an approach that doesn’t require “boilerplate” code to update the state, and to conclude that Redux is just complicated. In a way it is, and by design so.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://medium.com/@dan_abramov/you-might-not-need-redux-be46360cf367&quot;&gt;You Might Not Need Redux&lt;/a&gt;&lt;/p&gt;
&lt;hr&gt;</content:encoded></item><item><title><![CDATA[关于微前端的一些思考和总结]]></title><description><![CDATA[…]]></description><link>https://pakholeung37.github.io/关于微前端的一些思考和总结/</link><guid isPermaLink="false">https://pakholeung37.github.io/关于微前端的一些思考和总结/</guid><pubDate>Wed, 29 Apr 2020 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;前言&lt;/h2&gt;
&lt;p&gt;微前端是最近几年在理论层面比较流行的一种说法, 意图将微服务的一套实践搬到前端来, 也是各个大公司在项目管理实践中总结出的方法论.&lt;/p&gt;
&lt;h2&gt;目的&lt;/h2&gt;
&lt;p&gt;微前端主要是应对大型项目在开发过程中所遇到的一些问题的一种方法论, 企图在前端中引入和微服务相似的架构, 来达到页面各个部分的开发, 技术栈, 迭代, 测试, 发布等各个环节的分离, 页面各个部分只通过暴露的接口来进行通信, 可以让前端项目以更小的划分来进行开发, 并且相互之间不会有任何影响.&lt;/p&gt;
&lt;h2&gt;挑战&lt;/h2&gt;
&lt;p&gt;在微前端的实践路上也有很多前所唯有的挑战, 和后端微服务不一样, 微服务在架构上是有现实映射支持的, 在前端浏览器, 则可能没有对应的映射, 实践的路上也是困难重重. 在这些问题可以划分几个更具体的问题: 代码分离和聚合, 公共资源共享, 独立样式, 应用间通信, 测试等.&lt;/p&gt;
&lt;p&gt;在这里我列出几种方案, 以及他们的优缺点和解释这些方案是如何解决以上这些问题的. 不过同样地, 没有银弹.&lt;/p&gt;
&lt;p&gt;iFrame.&lt;/p&gt;
&lt;p&gt;iframe 作为一种成熟的标签在前端的很多地方, 及很早就开始应用. 传统而言, iframe 作为优秀的沙盒方案, 可以有效隔离全局变量, 样式, 路由等. 他可以很直观地分割一个页面中的两个应用, 完全可以独自架构, 测试, 上线. 但是同样地, 这个方案也有他致命的确定. iframe 运行在新的浏览器进程中致使他在很多方面都丧失灵活性. 例如应用之间的通信会变成进程间的通信, 这种消耗在某些情况下是不可以接受的.&lt;/p&gt;
&lt;h2&gt;具象问题&lt;/h2&gt;
&lt;p&gt;在架构微前端时虽然没办法测试方案是否完备, 但是如果你的微前端架构方案能回答出以下问题, 则方案相对健壮.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;能否通过一个 url 链接, 从 app 的外部链接定位到当前页面的状态?&lt;/li&gt;
&lt;li&gt;各个应用是否使用同一份格式化样式代码?&lt;/li&gt;
&lt;/ol&gt;</content:encoded></item><item><title><![CDATA[wsl with ss 坑和解决方案]]></title><description><![CDATA[最近在使用 yarn 安装 node-sass cypress 时下载额外脚本有连接超时的问题, 遂翻墙 环境: 家用: win10 wsl2 ssr 端口 1080 公司: win10 wsl ssr 端口 1080 proxychains4 proxychains…]]></description><link>https://pakholeung37.github.io/wsl with ss 坑和解决方案/</link><guid isPermaLink="false">https://pakholeung37.github.io/wsl with ss 坑和解决方案/</guid><pubDate>Mon, 27 Apr 2020 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;最近在使用 yarn 安装 node-sass cypress 时下载额外脚本有连接超时的问题, 遂翻墙&lt;/p&gt;
&lt;p&gt;环境:&lt;/p&gt;
&lt;p&gt;家用: win10 wsl2 ssr 端口 1080&lt;/p&gt;
&lt;p&gt;公司: win10 wsl ssr 端口 1080&lt;/p&gt;
&lt;h2&gt;proxychains4&lt;/h2&gt;
&lt;p&gt;proxychains4 是支持 socks5 proxy 的联级代理, 但是只能做一层代理, 该代理为应用层级, 可规定应用走代理链. 理想很美好, 现实很残酷. 家用和公司电脑均无法通过这种方式连接网络. 无法 curl www.google.com, 无论采用 wsl2 和 wsl1. 放弃了&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/haad/proxychains&quot;&gt;proxychains - github&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;shadowsocksR http 代理&lt;/h2&gt;
&lt;p&gt;使用 shadowsocksR 的”允许来自局域网的连接”&lt;/p&gt;
&lt;p&gt;[&lt;a href=&quot;https://moe.best/gotagota/ss-ssr-allow-lan.html&quot;&gt;SS/SSR] 分析&amp;#x26;相关科普：“允许来自局域网的连接”到底怎么用&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;具体原理在于, linux 在系统层级是不支持 socks5 代理的, 但是支持 http 和 https 的代理. 而在 ssr 的客户端中是有使用 http 代理来翻墙的. 例如 PAC 模式即智能代理模式就是使用 http 来代理 1080 端口的, 另外还有一个 socks5 代理同样运行在 1080 端口, 所以 ssR 其实是在同一个端口上监听了两种代理协议.&lt;/p&gt;
&lt;p&gt;所以其实只需要 wsl 的 http 代理设置到本机的 1080 端口就可以了.&lt;/p&gt;
&lt;p&gt;实战中可以使用&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;http_proxy&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;http://127.0.0.1:1080&quot;&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;https_proxy&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;http://127.0.0.1:1080&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;用于设置当前终端代理. 重新带来终端后需重新设置, 这个模式只能跑 http, 对于其他需要走 socks5 的流量就差点意思了, 不过对于目前情况是够用的.&lt;/p&gt;
&lt;p&gt;也可添加脚本简化开启和关闭 proxy&lt;a href=&quot;https://fe.rualc.com/note/npm-speedup.html#peng-dao-de-wen-ti&quot;&gt;用 Proxy 进一步提高 npm 安装速度&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;no_proxy&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;localhost,127.0.0.1,mysite.com &lt;span class=&quot;token comment&quot;&gt;# 白名单&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function-name function&quot;&gt;proxyon&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;http_proxy&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;http://127.0.0.1:1080&quot;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# 改成你自己的地址&lt;/span&gt;

  &lt;span class=&quot;token builtin class-name&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token assign-left variable&quot;&gt;https_proxy&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;http://127.0.0.1:1080&quot;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# 改成你自己的地址&lt;/span&gt;

  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;HTTP Proxy on&quot;&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function-name function&quot;&gt;proxyoff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;token builtin class-name&quot;&gt;unset&lt;/span&gt; http_proxy https_proxy &lt;span class=&quot;token comment&quot;&gt;# 取消 proxy&lt;/span&gt;

  &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;HTTP Proxy off&quot;&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

proxy &lt;span class=&quot;token comment&quot;&gt;# 可以加入这一行实现打开终端直接开启 proxy&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最近发现在 wsl2 下使用的常规 svelte-realword(sapper - rollup) 无法 watch /destop/&lt;em&gt;project&lt;/em&gt;/src/**文件变更, 只能改回 wsl1&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Advanced Vue Featrues - Reactivity]]></title><description><![CDATA[本文是对 FrontendMaster - Advanced Vue.js Features from the Ground Up 第二章 Reactivity 总结。 本章旨在解释 vue 的响应式原理。 在 vue 文档中有这张图  大概解析了 vue…]]></description><link>https://pakholeung37.github.io/Advanced Vue Featrues - Reactivity/</link><guid isPermaLink="false">https://pakholeung37.github.io/Advanced Vue Featrues - Reactivity/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;本文是对 FrontendMaster - Advanced Vue.js Features from the Ground Up 第二章 Reactivity 总结。&lt;/p&gt;
&lt;p&gt;本章旨在解释 vue 的响应式原理。&lt;/p&gt;
&lt;p&gt;在 vue 文档中有这张图&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/86e39b17b2cceb26157d6fbba5856bf5/c1b63/1240-20200817211931708.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAACBElEQVQoz41S308TQRC+v5KERxKiIUGjD74YHzRRfNeoUSQ+KKBGAhogYkShamoFhRarlpbrtdxhr+V6vd6Pvf057t32oNEXN5vL3Mx88818sxr83+ECPEQJE8NODXALuu/B2wQvB911wJYK9Dy/WK5EKJY2YfzRp9a5+drUatPqYekRQoG7r3FxVN8cNz6Mk9KosBdYyuT2+tV60+378id/4J19vH95UZ94sj+TszKsBDvLtDSytzb2fW0MF0fo73nCgDEi0gTKuPzmKu7kXPXmSuPCs9r99QbgOIkJCUY62HOi/VxeOH4KqJoWHcymKBDht99ZE7PVK0t1w4mBM54W1SDLjanoBZRJSTg/kUWaypazNE3XDxMJBMaqqpYCBefMD4L2sUMJkYWB0ZQ2yWCcVnTjqNUGTkXq4hhLOSXPgJkwSihNVyKCCJEoUrVty9/5cmhaHdfzCEJqaSzGXa9PKdXUZAXzV4TjtE/uev042RAvf2vdu5abnvr4YnqXhLJVrmhln4M9cxA7tl4wfuaNH1EcZzoltIu3Nt5eurN7/e7s5Ey52ElGQEgwdpKQMB+GznLj64q+9apWgIEGSWxjYe/NmRvb568uXXxgNX0QlGec2QuTgzlOzTIPjqxGx1Y7UhLjCOdfllYffq6XzFPvMFg6wgiFQSQvRvifBBhe+F/nD6c70j+DFGZCAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image&quot;
        title=&quot;image&quot;
        src=&quot;/static/86e39b17b2cceb26157d6fbba5856bf5/fcda8/1240-20200817211931708.png&quot;
        srcset=&quot;/static/86e39b17b2cceb26157d6fbba5856bf5/12f09/1240-20200817211931708.png 148w,
/static/86e39b17b2cceb26157d6fbba5856bf5/e4a3f/1240-20200817211931708.png 295w,
/static/86e39b17b2cceb26157d6fbba5856bf5/fcda8/1240-20200817211931708.png 590w,
/static/86e39b17b2cceb26157d6fbba5856bf5/efc66/1240-20200817211931708.png 885w,
/static/86e39b17b2cceb26157d6fbba5856bf5/c83ae/1240-20200817211931708.png 1180w,
/static/86e39b17b2cceb26157d6fbba5856bf5/c1b63/1240-20200817211931708.png 1200w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;大概解析了 vue 的响应式原理，但是比较粗浅，在 reactivity 中，Evanyu 深入解析了具体 vue 是怎么实现实例的响应式的。&lt;/p&gt;
&lt;p&gt;首先，vue 中用到了一个 api Object.defineProperty 这个 api 无法向下兼容，导致 vue 在 ie8 及往下的版本都无法使用 vue。&lt;/p&gt;
&lt;p&gt;具体实现中，每个 components 实例都拥有自己的 data，props 或者是 computed 或 watched，这些属性在实例化的时候都会经过一个 observe 函数进行转化。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 简单 observe&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;observe&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;obj&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;obj&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; obj&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;defineProperty&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;obj&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; value
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;newValue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; newValue
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这是响应式的关键，通过重置变量的 setter 和 getter，可以重置变量的值，指向，实现响应式。但是这还不够，这样并不能实现所谓了响应式。&lt;/p&gt;
&lt;p&gt;例如在 vue 中&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    a&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;computed&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;光凭借简单的 observe，computed 的值无法随着 a 的更新而更新，因为 setter 和 getter 暂时只影响当前值，没办法更新依赖它的值。&lt;/p&gt;
&lt;p&gt;所以正确的思路应该是在 getter 中添加依赖，并且能在调用 setter 时找到该依赖，并更新依赖它的值。&lt;/p&gt;
&lt;p&gt;为此，新增一个 Dep class&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;window&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Dep &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Dep&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;subscribers &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;depend&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;activeUpdate&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;subscribers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;activeUpdate&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;notify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;subscribers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;subscriber&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;subscriber&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;observe&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;obj&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;obj&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; dep &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Dep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; obj&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;defineProperty&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;obj&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        dep&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;depend&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; value
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

      &lt;span class=&quot;token keyword&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;newValue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; newValue
        dep&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;notify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; activeUpdate

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;autorun&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;wrapperUpdate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    activeUpdate &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; wrapperUpdate
    &lt;span class=&quot;token function&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    activeUpdate &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;wrapperUpdate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;至此，一个简单的响应式框架就做好了，这里重点关注 getter 依赖添加，activeUpdate 和 Dep 是如何将 update 函数添加到订阅器上的。由于 js 的单线程，js 每次只能运行一个函数，activeUpdate 会在进行 autorun 时记录当前 autorun 的 update。vue 中 update 的代码会运行在 autorun 下。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// example&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; state &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; count&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;autorun&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;count&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;调用 autorun 后在 update 内部使用了 state.count，触发了依赖，当前 update 函数就会添加到 subscribers 上&lt;/p&gt;
&lt;p&gt;给予一个简单的 sample observer&lt;/p&gt;
&lt;p&gt;从写一个更复杂的 observe 函数，使之可以很好的识别 data&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;observe&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;obj&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;obj&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;hasOwnProperty&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;data&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; obj&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; data&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; dep &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Dep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      Object&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;defineProperty&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;obj&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          dep&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;depend&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; value
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;newValue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
          value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; newValue
          dep&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;notify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        enumerable&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;delete&lt;/span&gt; obj&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;data
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;测试样例&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; state &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      a&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;observe&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// { a: [Getter/Setter] }&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;autorun&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;此代码第一次运行时返回 1，是 a，b 的值，当 state.a 重新赋值时，update 再次运行 返回 3。这意味这当 state 被改变时，会触发 update 函数，如果在 update 中添加改变视图的方法，例如 document.getElement(‘div‘).text = state.a; state 的改变则会驱动视图变化，perfect。这就是 vue 的响应式原理。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[CRP资源整理及quick quiz]]></title><description><![CDATA[Google DeveloperCRP 系列文章 和上面文章同一作者的 Udacity 课程：网站性能优化 CRP 详述：understanding critical render path | bitofcodes async 和 defer javascipt 在 CRP…]]></description><link>https://pakholeung37.github.io/CRP资源整理及quick quiz/</link><guid isPermaLink="false">https://pakholeung37.github.io/CRP资源整理及quick quiz/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://developers.google.com/web/fundamentals/performance/critical-rendering-path/&quot;&gt;Google DeveloperCRP 系列文章&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;和上面文章同一作者的 Udacity 课程：&lt;a href=&quot;https://classroom.udacity.com/courses/ud884&quot;&gt;网站性能优化&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;CRP 详述：&lt;a href=&quot;https://bitsofco.de/understanding-the-critical-rendering-path/&quot;&gt;understanding critical render path | bitofcodes&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;async 和 defer javascipt 在 CRP 理论下的分析：&lt;a href=&quot;https://bitsofco.de/async-vs-defer/&quot;&gt;Asynchronous vs Deferred JavaScript&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;&amp;lt;script&amp;gt;&lt;/code&gt;标签位置方案详述：&lt;a href=&quot;https://www.html5rocks.com/en/tutorials/speed/script-loading/&quot;&gt;Deep dive into the murky waters of script loading&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;quick quiz&lt;/h2&gt;
&lt;p&gt;Q：请简述 critical render path。&lt;/p&gt;
&lt;p&gt;A：在浏览器请求资源的时候，最先请求到的一定是一个 html 文件，所有的其他资源一定是围绕这个入口进行加载的。关键渲染路径就在于浏览器加载其他资源和构建相关模型以及渲染到屏幕的策略。&lt;/p&gt;
&lt;p&gt;一个正常的 CRP 包含以下步骤：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;构建 DOM&lt;/li&gt;
&lt;li&gt;构建 CSSOM&lt;/li&gt;
&lt;li&gt;运行 JavaScript 脚本&lt;/li&gt;
&lt;li&gt;创建渲染树&lt;/li&gt;
&lt;li&gt;生成布局&lt;/li&gt;
&lt;li&gt;绘制画面&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4613ac68a76ed8e8429de3f5a766adff/0f2bc/1240-20200817211711642.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 29.054054054054056%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABKklEQVQY02NgAILHgj2ML9i7OV4xVHE+5+hmB4m9ZO5ieMPQzUAWeM/QIfOOuffVL+HZ/98xdO0Hib1h7mHdGtzD8Ia7n/m97AyWN2y9zOuS+hhA9Hup6Sxv2HuZF1RMYHjN2sP8Tnwqy1vmHuY3DC0IQx9K9GW/E5hUfkeqJ5SBEvCOta/7teSUeffFe5IY/jMwPJLsb38nPGXOG5aevBWpPfxvOPua34lMmQ3kl2+J6BMB0jXvhCbPfsPaW7W4uJ/vNUtPBdAhs98y9TS9YWjjYHjL1X/7g8rsj28YuhYcsu5Sfc814fwHrXmf33D0rV4Z2SEGpM++V5z1CWjAzm1BvTJAAw++E5z8GUjvX1LUL/KGuXvPO76Jn4AGngYayIPh4lIGZYp8DAAmV3+u+gqXpwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image&quot;
        title=&quot;image&quot;
        src=&quot;/static/4613ac68a76ed8e8429de3f5a766adff/fcda8/1240-20200817211711642.png&quot;
        srcset=&quot;/static/4613ac68a76ed8e8429de3f5a766adff/12f09/1240-20200817211711642.png 148w,
/static/4613ac68a76ed8e8429de3f5a766adff/e4a3f/1240-20200817211711642.png 295w,
/static/4613ac68a76ed8e8429de3f5a766adff/fcda8/1240-20200817211711642.png 590w,
/static/4613ac68a76ed8e8429de3f5a766adff/0f2bc/1240-20200817211711642.png 742w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;一般而言，这个过程是顺序执行的，唯一需要关注的，是 JavaScript 如何影响 DOM 和 CSSOM 的构建。&lt;/p&gt;
&lt;p&gt;JavaScript 是一种解析阻塞的资源。一旦 html 解析器遇到一个 script 标签，它将会立即加载并执行脚本，同时 blocking html parser。而且，script 还可能会改变一些样式，这意味着，脚本将会在 CSSOM 构建完毕后才会执行。这里有一篇参考文章：&lt;a href=&quot;https://developers.google.com/web/fundamentals/performance/critical-rendering-path/adding-interactivity-with-javascript&quot;&gt;使用 JavaScript 新增互動功能&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;关键路径决定了页面将会如何呈现到客户端，并决定了呈现的速度。关键路径的优化则会影响页面首次加载的性能。&lt;/p&gt;
&lt;p&gt;一般而言，首次加载的性能瓶颈一般是在网络上和解析上。加载资源的顺序和速度会直接影响首次加载的性能。所以对于如何优化关键路径，可以分为两大类：1、尽早加载网页关键资源，例如关键
CSS 和关键 JS。2、优化可能产生阻塞的代码，例如 js 运行阻塞 dom 构建等。&lt;/p&gt;
&lt;p&gt;Q：简述 async 脚本的执行路径。&lt;/p&gt;
&lt;p&gt;A：async 是 HTML5 的提案，目的是防止阻塞 dom 构建，async 脚本将会并行 dom 构建进行加载，并且在加载完毕后立刻执行。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a9a9694452a0495fd7fa751b9f8bb028/6937a/1240-20200817211711742.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 23.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABEUlEQVQY0yWQ23aDIBBF/f9/60Nf+tBEk6YRTVC8AALedkfLWrNgAefMnpMZY3Decaxt2849xAmlFOu6smyJuFjm1ePiiBk3uhFSH1isOd9iHJiTPbXZs3xwu+eYrmFnFdMZ63qK25WYAmEeseEtZg2919QCULWGbmgI4YWNGjcoZtex7SuZ1m9K9aRp3tIpSI8d70cu12/SfNCNjCJ0Iuyc5l5riqrm+VA0r4ohHYYlybai3MlUVfL4/aEoruT5ha43DIMRwpyUIml1eBFNi9yHFtUKZaf5vBk+vmqcfuCtYlkmIdzIUhKKGM+a5//zQea9PzMdXEOtNb0uMb0mLUGoJ4likki8DCR/bIP1w5nhHyLtfssUCwkDAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image&quot;
        title=&quot;image&quot;
        src=&quot;/static/a9a9694452a0495fd7fa751b9f8bb028/fcda8/1240-20200817211711742.png&quot;
        srcset=&quot;/static/a9a9694452a0495fd7fa751b9f8bb028/12f09/1240-20200817211711742.png 148w,
/static/a9a9694452a0495fd7fa751b9f8bb028/e4a3f/1240-20200817211711742.png 295w,
/static/a9a9694452a0495fd7fa751b9f8bb028/fcda8/1240-20200817211711742.png 590w,
/static/a9a9694452a0495fd7fa751b9f8bb028/efc66/1240-20200817211711742.png 885w,
/static/a9a9694452a0495fd7fa751b9f8bb028/6937a/1240-20200817211711742.png 1094w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Q：简述 defer 脚本的执行路径。&lt;/p&gt;
&lt;p&gt;A：如上图，defer 一样可以并行 dom 构建加载，并会在 dom 构建完毕后立刻执行。&lt;/p&gt;
&lt;p&gt;Q：为什么要使用 async 和 defer，它们又有什么问题。&lt;/p&gt;
&lt;p&gt;A：async 和 defer 的都是为了防止原始脚本标签阻塞 dom 构建而提出的，并行加载可以让他们更快地加载。但是同样，他们两者也有问题。第一、async 和 defer 都无法保证脚本的执行一致性。&lt;/p&gt;
&lt;p&gt;例如一下代码&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;html&quot;&gt;&lt;pre class=&quot;language-html&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;// async提案
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;script&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;1.js&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;script&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;2.js&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
// defer提案
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;script&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;1.js&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;script&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;2.js&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;async 在这种代码中，无法保证 1.js 运行在 2.js 之前，defer 则会在某些浏览器中存在 bug 导致 2.js 部分代码可能提前与 1.js。致使两个脚本无法顺序运行。defer 提案由于严重的 bug，现在几乎不会用了。async 则只会使用在独立的，关键的脚本之上。&lt;/p&gt;
&lt;p&gt;Q：请比较 async 和 defer 异同。&lt;/p&gt;
&lt;p&gt;A：上面说的也很详细，async 和 defer 都能并行于 parser 加载，不同是 async 会在加载完成时执行，defer 则在 dom 构建完成时执行。&lt;/p&gt;
&lt;p&gt;Q：如何应用 CRP 分析加快网站的加载速度。&lt;/p&gt;
&lt;p&gt;A：上面也说到过，关键在于如何尽早地加载关键资源和防止阻塞 dom 构建。&lt;/p&gt;
&lt;p&gt;能用的策略包括：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;最小化、压缩、缓存关键资源。&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;最小化渲染阻塞资源。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用 media query 防止加载非关键 CSS&lt;/li&gt;
&lt;li&gt;使用 inline CSS&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;最小化解析阻塞资源。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;推迟 JavaScript 执行&lt;/li&gt;
&lt;li&gt;异步加载 JavaScript&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Q：综述 script 标签放置问题。&lt;/p&gt;
&lt;p&gt;A：&lt;a href=&quot;https://www.html5rocks.com/en/tutorials/speed/script-loading/#toc-enough&quot;&gt;https://www.html5rocks.com/en/tutorials/speed/script-loading/#toc-enough&lt;/a&gt;自己看吧。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[TypeScript：最佳实践]]></title><description><![CDATA[类型保护 typescript 中有三种正常的类型保护，包括自定义类型保护，typeof 类型保护和 instanceof 类型保护。其中 typeof 只能用于 javascript 定义的六种基础类型，而 instanceof…]]></description><link>https://pakholeung37.github.io/TypeScript：最佳实践/</link><guid isPermaLink="false">https://pakholeung37.github.io/TypeScript：最佳实践/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;类型保护&lt;/h2&gt;
&lt;p&gt;typescript 中有三种正常的类型保护，包括自定义类型保护，typeof 类型保护和 instanceof 类型保护。其中 typeof 只能用于 javascript 定义的六种基础类型，而 instanceof 只能用于当类型在要检查类型的原型链中。对于其他 typescript 中其他丰富的类型，typeof 和 instanceof 都无能为力。&lt;/p&gt;
&lt;h2&gt;自定义类型保护&lt;/h2&gt;
&lt;p&gt;那么只剩下自定义保护能使用了，在官方文档中使用如下例子讲解自定义保护。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;isFish&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;pet&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Fish &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Bird&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; pet &lt;span class=&quot;token keyword&quot;&gt;is&lt;/span&gt; Fish &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Fish&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;pet&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;swim &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;undefined&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;但是有很多问题。第一，它使用了违反直觉的类型断言，因为不断言，就访问不到属性.swim。第二，如果 Fish 没有特例属性，则无法将它和其他类型区分。考虑以下例子&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Cash&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;PayPal&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  email&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;CreditCard&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  cardNumber&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
  securityCode&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; PaymentMethod &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Cash &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PayPal &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; CreditCard

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;StringifyPaymentMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;menthod&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; PaymentMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;函数要在内部区分各种支付方式，然后使用不同的处理方法。&lt;/p&gt;
&lt;p&gt;在这里普通的类型保护就起不了作用了。&lt;/p&gt;
&lt;p&gt;应用字面字符串类型，则可很好解决这个问题。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Cash&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; kind&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Cash&apos;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;PayPal&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; kind&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;PayPal&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; email&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;CreditCard&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; kind&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;CreditCard&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; cardNumber&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; securityCode&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; PaymentMethod &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Cash &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; PayPal &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; CreditCard&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;StringifyPaymentMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;menthod&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; PaymentMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;switch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mentod&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Cash&apos;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;PayPal&apos;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;CreditCard&apos;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里的好处有两点：一是不用再使用类型断言，二是不再依赖类型特定属性（其实说到底就是加了一个特例属性嘛）。但是即便是不使用类型断言，类型还是被保护了，在 case ‘Cash’内部，Method 则会被直接当做 Cash 类型。&lt;/p&gt;
&lt;p&gt;依靠这种自定义的类型保护，可以更好的判断包括 interface，泛型等非标准类型。&lt;/p&gt;
&lt;h2&gt;索引类型&lt;/h2&gt;
&lt;p&gt;使用索引类型，编译器就能够检查使用了动态属性名的代码&lt;/p&gt;
&lt;p&gt;考虑以下例子：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Type&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  a&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;number&lt;/span&gt;
  b&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
  c&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;prop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;obj&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Type&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; key&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;b&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; obj&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;可以预料到，function prop 返回类型将是 number | string | string[]，因为你无法预料输入参数是 a，b，还是 c，因为是动态的。但编译器知道只能是这三个值，所以返回值只能是 number，string 或 string[]。&lt;/p&gt;
&lt;p&gt;但这似乎不是我们想要的，我们希望编译器在编译的时候就知道将会返回值的类型。&lt;/p&gt;
&lt;p&gt;typescript 拥有关键字 keyof，用以指代一个类型的所有 key 的值的集合。&lt;/p&gt;
&lt;p&gt;在这个例子中可以将&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;prop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;obj&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Type&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; key&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;b&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;改成&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;prop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;obj&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Type&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; key &lt;span class=&quot;token keyword&quot;&gt;keyof&lt;/span&gt; Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;cool, 但是状况似乎没什么变化。&lt;/p&gt;
&lt;p&gt;这里就要引入到 typescript 中的索引类型。在 typescript 中指定索引 T[K]，则会被解释成类型。例如这里&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;prop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;obj&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Type&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Type&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;则会被解析成 number。利用这个特性，可以解决这个问题&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Type&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  a&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;number&lt;/span&gt;
  b&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;
  c&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; prop&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;K&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;keyof&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;obj&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; key&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; obj&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;key&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在这个例子中，返回值会被隐式解释成 T[K]，换言之，返回值直接与参数 key 和 obj 关联了，现在它可以正确指示返回值。&lt;/p&gt;
&lt;p&gt;这种模式也被广泛应用于 typescript 的一些装饰性的类型，例如考虑以下例子：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Point&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  x&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;number&lt;/span&gt;
  y&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;number&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; ReadOnlyPoint &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ReadOnly&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Point&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// ReadOnlyPoint {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   readonly x: number;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   readonly y: number;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// }&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;ReadOnly 的定义&lt;/h2&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; ReadOnly&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;readonly&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;P&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;keyof&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在这个例子中，利用了泛型 ReadOnly 装饰了接口 Point，使之变成了一个只读的类型。这种模式也同样可以应用于 nullable，optional 等装饰性的类型上&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; Nullable&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;P&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;keyof&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; Optional&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;P&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;keyof&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;甚至还可以形成装饰链&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;typescript&quot;&gt;&lt;pre class=&quot;language-typescript&quot;&gt;&lt;code class=&quot;language-typescript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; CustomPoint &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ReadOnly&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Nullable&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Optional&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Point&lt;span class=&quot;token operator&quot;&gt;&gt;&gt;&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// CustomPoint {&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   readonly x?: number | null | undefined;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//   readonly y?: number | null | undefined;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// }&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[git 最佳实践]]></title><description><![CDATA[记录在工作过程中使用 git 的一些问题和解决方案]]></description><link>https://pakholeung37.github.io/git 最佳实践/</link><guid isPermaLink="false">https://pakholeung37.github.io/git 最佳实践/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;记录在工作过程中使用 git 的一些问题和解决方案&lt;/p&gt;</content:encoded></item><item><title><![CDATA[gitlab-ci quick quiz]]></title><description><![CDATA[以快问快答的形式综述关于我所知道的 gitlab-ci Q: gitlab-ci 是做什么? A: gitlab-ci 是一种为自动集成/自动部署而生的工作流模式. 通过配置相应的脚本, 可以在进行相应 git 操作之后运行部署脚本. 进而形成 push…]]></description><link>https://pakholeung37.github.io/gitlab-ci quick quiz/</link><guid isPermaLink="false">https://pakholeung37.github.io/gitlab-ci quick quiz/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;以快问快答的形式综述关于我所知道的 gitlab-ci&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Q: gitlab-ci 是做什么?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;A&lt;/strong&gt;: gitlab-ci 是一种为自动集成/自动部署而生的工作流模式. 通过配置相应的脚本, 可以在进行相应 git 操作之后运行部署脚本. 进而形成 push -&gt; 集成 -&gt; 构建 -&gt; 部署的自动化流程. 一般而言, 在 gitlab 中使用 ci 需要服务器分配一个 runner, 这个 runner 的形式可以有很多种, 并不局限于虚拟机, docker, 真实服务器等. 也不局限操作系统. 通过创建 gitlab-ci.yml 脚本, 可以操控 runner 完成这些任务.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Q: gitlab-ci 和 github actions 有什么异同?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;A&lt;/strong&gt;: 在 github action 中, 所有 runner 都是以 docker 的形式出现的. 但是官方提供了大量的 image 供使用, 而 gitlab-ci 则不局限于 docker. 当然也没有初始化的必要. 除了 github actions, 其实还有很多类似 circle-ci 等优秀的集成自动化工具. 都是非常优秀的.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Q: 简述一下什么是 stages, jobs, pipeline.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;A&lt;/strong&gt;: 在 runner 的概念中, 从概念的大小依次排序应当是 pipeline -&gt; stages -&gt; jobs. pipeline 是与每次提交相关联的一个 stages 的集合. 即是本次自动化处理任务的一个总称. 每个 pipeline 则互不影响, 可并行执行. stage 是对自动化作业流水线的每个阶段的总称, 很好理解, 每个 pipeline 都是由一个个 stages 串联而成的. 当一个 stage 成功后则会触发下一个 stage 执行, 一个 stage 失败后则会终止整个 pipeline. 值得注意的是, 在 gitlab 中, stage 是必须串行的, 不存在分支控制进入不同的 stage(其实是可以使用 when 进行简单的分支控制), 一旦定义了 stage, 则必须进入(当然你可以 skip). 而 jobs 则是每个 stage 中 runner 执行每次任务的一个基本单元. 在每个 stage 中, job 都是并行执行的, 他们之间互不影响. 所以你可以看到在理想的状态下, 每个 jobs 应该是可以分配给不同的 runner 执行, 达到并行速度最优.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Q: 简述一下 gitlab 的 yml 语法.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;A&lt;/strong&gt;: 快速教程请看&lt;a href=&quot;https://juejin.im/post/6844903902387650567&quot;&gt;GitLab CI 介绍——入门篇&lt;/a&gt;, 详细请看&lt;a href=&quot;https://docs.gitlab.com/ee/ci/yaml/README.html&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Q: 在 yml 语法上, 有什么考究的吗?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;A&lt;/strong&gt;: 需要注意破折号的使用, script 中使用的是字符串数组, 他的一般形式为&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; xxxxxx
  &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; xxxxxx
  &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; xxxxxx&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;而我所使用的是&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yml&quot;&gt;&lt;pre class=&quot;language-yml&quot;&gt;&lt;code class=&quot;language-yml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; xxxxxx
    xxxxxx
    xxxxxx&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;会被当做一条字符串.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Q: 相较于之前的脚本, 我做了哪些改进?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;A&lt;/strong&gt;: 在附录 2 中有以前的 gitlabci 脚本. 对比来看&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;stage 运用&lt;/strong&gt; 可以看到, 我的脚本每个 stage 更加的细化, 包含更新库代码, 安装依赖, 构建项目, 部署项目等环节. 旧脚本只有安装依赖的过程和部署&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;安装依赖的方法&lt;/strong&gt; 在我的脚本中, 安装依赖前一个 stage 是更新库代码, 这样的做法是因为你的依赖包和版本可能会更新, 如果仅仅安装依赖, 那你新的包和版本并不能更新到仓库中. 另外, 可以看到我使用了&lt;code class=&quot;language-text&quot;&gt;yarn --frozen-lockfile&lt;/code&gt;这个脚本的作用是保持 yarn.lock, 这样的好处是使用 yarn 安装和检查依赖时, 会严格按照.lock 文件的版本来进行, 可以更好的控制各个依赖的版本.&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;控制流&lt;/strong&gt; 我的 stage 是有明确 success fail 的, 旧的脚本则总是成功.&lt;/p&gt;
&lt;p&gt;在旧的脚本中使用的是如下形式的工作流&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;- &lt;span class=&quot;token function&quot;&gt;ssh&lt;/span&gt; -p &lt;span class=&quot;token number&quot;&gt;50805&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$SSH_REMOTE&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; EOF
- &lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; ~/git/repo/edu/fk-education/
- &lt;span class=&quot;token function&quot;&gt;yarn&lt;/span&gt; --frozen-lockfile
- EOF&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这个工作有两个问题: 1. 由于利用了 ssh, 在 ssh 代码的时候, 脚本 exit code 恒为 0, 即成功, 这样导致一个 jobs 恒为 true, 无法在脚本真正出错的时候即刻终止 pipeline 的运行. 2. 在 ssh 的脚本中间一条命令如果出现错误, 那下一条命令仍然会继续执行, 这是不能被容忍的. 为此需要使用正确的流&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;- &lt;span class=&quot;token function&quot;&gt;ssh&lt;/span&gt; -p &lt;span class=&quot;token number&quot;&gt;50805&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$SSH_REMOTE&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; EOF
- &lt;span class=&quot;token builtin class-name&quot;&gt;cd&lt;/span&gt; ~/git/repo/edu/fk-education/ &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;yarn&lt;/span&gt; --frozen-lockfile &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;exit&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
- EOF&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;新修改的代码有一些不一样的区别, 1, 在命令与命令之间添加了&amp;#x26;&amp;#x26;逻辑, 而且, 这些命令虽然换行了, 但是没有加破折号, 意味着这些语句都是当作一条语句来执行的. 2, 在命令末尾新增了 exit code, 如果前面有命令执行失败, 则会进入||, 使 ssh 脚本非正常退出, 并且 code 为 1(正常应该为 0), 经过检验, runner 的成功和失败其实都是看最后一条命令的 exit code 的, 这样写, 则可以正确地返回正确的 stage 状态, 及时中断 stage.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;如何控制分支构建流程&lt;/strong&gt; 旧的脚本控制分支构建流程是直接写在脚本上的&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;only&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;a
&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; prod&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我认为这是不合理的, 第一, 这种做法控制手法低效, 如果我有几个分支, 完全不一样的脚本, 或者几种 jobs 混杂在一起, 这样的脚本通常需要编写出非常多而且不合理的代码才能做到. 而我的选择是直接在每个分支中绑定一个该分支的.gitlab-ci.yml, 每个分支的 ci 流程都有自己的流程脚本. 可以比较合理地解决这个问题.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;git 操作&lt;/strong&gt; 我的代码中有绑定当前分支的分支名的变量&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;git fetch origin $CI_COMMIT_REF_NAME &lt;span class=&quot;token important&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
git checkout $CI_COMMIT_REF_NAME &lt;span class=&quot;token important&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
git pull &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;更加合理地获取当前 ci 构建的分支的代码.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Q: 简述一下你在 fetch 阶段的 git 操作.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;A&lt;/strong&gt;: 请看大屏幕&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; fetch origin &lt;span class=&quot;token variable&quot;&gt;$CI_COMMIT_REF_NAME&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;# 获取远程分支commit信息&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; checkout &lt;span class=&quot;token variable&quot;&gt;$CI_COMMIT_REF_NAME&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;# 切换到该远程分支&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; pull &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# 拉取代码合并到本地&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;附录&lt;/h2&gt;
&lt;h3&gt;附录 1 - 我的 gitlab-ci.yml&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;stages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; fetch
  &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; install_deps
  &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; build
  &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; deploy

&lt;span class=&quot;token key atrule&quot;&gt;variables&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;SSH_REMOTE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; faier@dev3.faidev.cc
&lt;span class=&quot;token key atrule&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;stage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; fetch
  &lt;span class=&quot;token key atrule&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; ssh &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;p 50805 $SSH_REMOTE &amp;lt;&amp;lt; EOF
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; cd ~/git/repo/edu/fk&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;education/ &lt;span class=&quot;token important&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
      git fetch origin $CI_COMMIT_REF_NAME &lt;span class=&quot;token important&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
      git checkout $CI_COMMIT_REF_NAME &lt;span class=&quot;token important&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
      git pull &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;
      exit 1
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; EOF
&lt;span class=&quot;token key atrule&quot;&gt;install_deps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;stage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; install_deps
  &lt;span class=&quot;token key atrule&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; ssh &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;p 50805 $SSH_REMOTE &amp;lt;&amp;lt; EOF
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; cd ~/git/repo/edu/fk&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;education/ &lt;span class=&quot;token important&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
      yarn &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;frozen&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;lockfile &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;
      exit 1
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; EOF
&lt;span class=&quot;token key atrule&quot;&gt;build:h5-weixin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;stage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; build
  &lt;span class=&quot;token key atrule&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; ssh &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;p 50805 $SSH_REMOTE &amp;lt;&amp;lt; EOF
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; cd ~/git/repo/edu/fk&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;education/ &lt;span class=&quot;token important&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
      yarn build&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;h5&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;weixin &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;vconsole &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;
      exit 1
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; EOF
&lt;span class=&quot;token key atrule&quot;&gt;deploy:h5-weixin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;stage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; deploy
  &lt;span class=&quot;token key atrule&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; ssh &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;p 50805 $SSH_REMOTE &amp;lt;&amp;lt; EOF
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; cp ~/git/repo/edu/fk&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;education/dist/build/h5/index.jsp.inc ~/svn/web/edu/entrance/index.jsp.inc &lt;span class=&quot;token important&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
      cp &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;r ~/git/repo/edu/fk&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;education/dist/build/h5/static ~/svn/res/edu/h5/ &lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;|&lt;/span&gt;
      exit 1
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; EOF&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;附录 2 - gitlab 上常规的&lt;a href=&quot;http://gitlab.faidev.cc/yueke/myueke-wxapp/blob/master/.gitlab-ci.yml&quot;&gt;gitlab-ci.yml&lt;/a&gt;&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;stages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; install_deps
  &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; deploy

&lt;span class=&quot;token key atrule&quot;&gt;before_script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; echo &quot;starting task&quot;

&lt;span class=&quot;token key atrule&quot;&gt;install_deps&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;stage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; install_deps
  &lt;span class=&quot;token key atrule&quot;&gt;tags&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; jmin&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;tag&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;myueke
  &lt;span class=&quot;token key atrule&quot;&gt;when&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; manual
  &lt;span class=&quot;token key atrule&quot;&gt;only&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; prod
  &lt;span class=&quot;token key atrule&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; echo &apos;install dep&apos;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; cd D&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;/prod/myueke&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;wxapp
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; fnpm install
  &lt;span class=&quot;token key atrule&quot;&gt;allow_failure&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean important&quot;&gt;true&lt;/span&gt;

&lt;span class=&quot;token key atrule&quot;&gt;deploy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;stage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; deploy
  &lt;span class=&quot;token key atrule&quot;&gt;tags&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; jmin&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;tag&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;myueke
  &lt;span class=&quot;token key atrule&quot;&gt;only&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; prod
  &lt;span class=&quot;token key atrule&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; echo &apos;build and upload&apos;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; cd D&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;/prod/myueke&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;wxapp
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; pwd
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; git branch
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; git pull
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; npm run build
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; wxpatch build &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;no&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;cache
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; npm run upload
  &lt;span class=&quot;token key atrule&quot;&gt;allow_failure&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean important&quot;&gt;true&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[HelloWorld!]]></title><description><![CDATA[春蚕到死丝方尽，梅花香自苦寒来。金风梨的第一个版本终于发布了。 这篇文章首发于我在阿里云上部署的该项目，并不一定是项目的最终归属，你可以点击这里(已失效)查看金风梨在阿里云上的版本。 不管怎么说，作为一个 beta…]]></description><link>https://pakholeung37.github.io/hello-world/</link><guid isPermaLink="false">https://pakholeung37.github.io/hello-world/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;春蚕到死丝方尽，梅花香自苦寒来。金风梨的第一个版本终于发布了。&lt;/p&gt;
&lt;p&gt;这篇文章首发于我在阿里云上部署的该项目，并不一定是项目的最终归属，你可以&lt;a href=&quot;http://120.79.157.195/&quot;&gt;点击这里(已失效)&lt;/a&gt;查看金风梨在阿里云上的版本。&lt;/p&gt;
&lt;p&gt;不管怎么说，作为一个 beta 版本，我觉得这个版本虽然说不上尽善尽美，但也算得上是呕心沥血，稍后可能会在网站上写一系列关于我在写这个项目的心路历程。也可能不会。&lt;/p&gt;
&lt;p&gt;不管怎么说，作为一个首发版本，它应该有一个版本号。我觉得谷歌在版本命名方面就很有意思，每个安卓版本都是以开发代号为首字母的糖果命名，很好。听起来不是很 geek，但是很萌。鉴于此，我决定把当前第一个版本命名为&lt;strong&gt;金风梨酥&lt;/strong&gt;，以纪念一直以来陪伴我奋战的游戏 ID。&lt;/p&gt;
&lt;p&gt;说起来，我为什么要写一个这样的项目呢？&lt;/p&gt;
&lt;p&gt;最初，对于我来说，金风梨只是一个练手项目。每一个程序员，在网络上，都深受一句话荼毒——不写博客的美工不是好程序员。于是我就跑去写“博客”了。但是写着写着我发觉，与其写个只有我能写的博客，不如大家一起来写，独乐乐不如众乐乐。于是便开始了有金风梨的雏形&lt;a href=&quot;https://github.com/Pakhoalot/iblog&quot;&gt;iblog&lt;/a&gt;。后来，我最希望的是这个项目最终能在母校汕大上线。&lt;/p&gt;
&lt;p&gt;我在大学四年，大概没认真写过一些很长的文章（作业不算）。没有为那些突发的灵感或深刻的思想做过一些记录。有过，但是放弃了。我在手机上以记事本的形式，记录一些灵感，后来换手机了，就没写了。我也在朋友圈中发过一些我很喜欢，一些我称得上是杰作，艺术品的圈文。因为朋友圈的局限性，也只是做了短期的策划。想过写的影评，没有写；构思很久的小说，没有写；想体验一把导演瘾的剧本，没有写。到底还有多少想写的东西，没有写出来。曾经高中三年，在智力巅峰水平的时候，尽管没有时间，但还是用日记本偷偷写了很多东西。大学时期的水平，比这差多了。&lt;/p&gt;
&lt;p&gt;我觉得这不是一个当代大学生，社会主义的接班人，国家栋梁的精神风貌。现代的学生，其实不单止是大学生，因为手机的出现，一些中学生甚至小学生也出现类似的倾向。每天接收的信息很多，但是产出很少，为什么？因为要接收的信息真的很多，这些信息甚至怎么刷都刷不完。于是也出现当代人特有症状：手机焦虑症。没有手机不能活，有红点要马上刷新其实都是焦虑的体现。这种话题其实在早些年一直都有探讨，但是最近几年似乎都不在谈起，人们似乎都沉浸在信息过载当中，没有人愿意拔出来。&lt;/p&gt;
&lt;p&gt;现在有太多的互联网产品在分散人们的注意力了。朋友圈是一款内敛克制的产品，不应该对它太过强求。真正该引起人们重视的应该是微博，抖音，直播这类产品。相较于很多刷新无极限的产品，这几款产品过度娱乐化，很容易消耗掉人们仅剩的注意力。&lt;/p&gt;
&lt;p&gt;扯得有点远了。总而言之，我觉得作为一个大学生，其实已经有能力去产出一些东西了，如其去消费别人的成果，倒不如作为一个生产者，真正地去做产出一些东西。毕竟能下场踢球，就绝不当教练（这个比喻貌似不是很恰当）。&lt;/p&gt;
&lt;p&gt;已经有简书，知乎专栏，公众号等产品，这个项目有什么不同的吗？&lt;/p&gt;
&lt;p&gt;论写作，这些产品都很好，但是这些产品有点快，有点急，我希望有一个平台能做一些慢一些的事情。除了简书外，很多产品都把写作过于功利化，用户和网站基本就是作者和编辑这样的关系。从你写的第一个字开始，你的文字就被定性为稿子，注定要发布，要分享，不然就是草稿，是没用的。这种想法本身就很功利。所以我希望有个地方，你可以慢慢写一些想写的东西，例如读书笔记，日记，一些想法，碎碎念，都可以。万一那天高兴了，就把作品发出来。用户之间的关系并不是一种读者作者这样的关系，写的人不是为取悦读的人而写，而是自己喜欢写。这样就很棒（其实这方面简书就做的很好啦）。&lt;/p&gt;
&lt;p&gt;另外我还是期望有一个以学生为圈子的这样一个平台，又或者是一个由身边的人组成的平台。比如说，当你看到一篇很不错的文章，而你发现写这篇文章正是每天与自己擦肩而过的人的时候，你也许会产生一种更加强烈的“他可以写我也可以写”的念头的。又或者你看到一篇写得不怎么样的文章（其实这种时候应该更多吧，毕竟人就这么多，文章质量都很高是不太可能的），你也许会产生一种“我行我上”的念头。其实重点还是在于你开始创作，而不是你一开始就能写得多好 。&lt;/p&gt;
&lt;p&gt;最后，其实还是希望能够在自己离开母校之前，做一些贡献。汕头大学有一个神奇的网站，名曰金凤（汕头大学的校徽就是一只金色的凤凰，校花也是凤凰花，想必金凤作者对这个网站也是有特殊的感情。当然我将这个项目命名为金风梨也是收到金凤的启发）。金凤 bt 资源全靠用户上传，没有第一方资源，资源提供很不稳定。但是一些热门的资源首发后，无论在什么平台上，在金凤总是会第一时间就发出资源。我对于同学们这种资源搜刮和共享精神是由衷的敬佩的。但是人的精力始终有限，一些冷门的资源往往会失效甚至基本找不到。&lt;/p&gt;
&lt;p&gt;我对金凤可谓又爱又恨。爱是因为在这个宽带有限的大山里头，金凤给予了同学们仅限的人文关怀；恨是因为作为一个网站，金凤在资源管理方面做的是不怎么样。但是作为金凤云和金凤影院的存在，我觉得金凤都已很好的完成了他的使命。飞扬之后，金凤作为一个资源分享的平台上持续运作了 3 年吧，在此期间，我一直怀疑为什么还没有人做一个像样的分享平台出来，丝毫没有意识到自己也是一个计算机专业的学生。本着 you can you up 的精神，我觉得现在我有能力做一个取代金凤的平台，接过金凤的棒。虽然以前总说金凤这么烂，我也能做，但其实做起来才知道，金凤有今天的成绩真的挺不容易的，在这里就表达对金凤最嵩高的敬意吧。&lt;/p&gt;
&lt;p&gt;扯七扯八说了很多，本来还想还这篇 helloworld 中简述一下目前版本的功能状况和现存 bug 的情况的，现在看来只能再开一篇文章记录了。总之，就这样把，很高兴现在除了写东西外什么都做不了的金风梨的第一个版本诞生了，按惯例还是要说一句：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;HelloWorld!&lt;/strong&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[javascript中的执行环境]]></title><description><![CDATA[在学习 JavaScript 的时候出现很多难以理解的概念，例如闭包，回调，this，作用域，作用域链，执行环境等等。但是这些概念难懂，归根到底都是对 call stack 模型的把握太差。只要理解好 JavaScript…]]></description><link>https://pakholeung37.github.io/javascript中的执行环境/</link><guid isPermaLink="false">https://pakholeung37.github.io/javascript中的执行环境/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;在学习 JavaScript 的时候出现很多难以理解的概念，例如闭包，回调，this，作用域，作用域链，执行环境等等。但是这些概念难懂，归根到底都是对 call stack 模型的把握太差。只要理解好 JavaScript 调用栈模型，所有这些问题概念对会很容易解决。&lt;/p&gt;
&lt;p&gt;这里贴上 youtube 上对于 call stack 解释非常好的视频&lt;a href=&quot;https://www.youtube.com/watch?v=jTGb4t31vCY&quot;&gt;JavaScript Foundations: Execution Context and Call Stack&lt;/a&gt;，以及一篇绝世神文&lt;a href=&quot;http://dmitrysoshnikov.com/ecmascript/javascript-the-core/&quot;&gt;JavaScript. The Core&lt;/a&gt;，这位作者 Dmitry Soshnikov 的&lt;a href=&quot;http://dmitrysoshnikov.com/&quot;&gt;博客&lt;/a&gt;也是干货满满，对一些 JavaScript 的基础概念都有深入的讲解，而且覆盖面非常全。&lt;/p&gt;
&lt;h2&gt;执行环境（execution context）&lt;/h2&gt;
&lt;p&gt;执行环境是 javascript 中很重要的概念，它定义了变量和函数有权访问的其他数据，决定了他们各自的行为。与之关联的是一个变量对象（variable object）。&lt;/p&gt;
&lt;p&gt;一个执行环境的变量对象定义了以下这些属性：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;作用域链（Scope Chain）：定义了当前上下文的作用域链。&lt;/li&gt;
&lt;li&gt;变量环境（Variable Environment）:定义了当前上下文中所有变量。&lt;/li&gt;
&lt;li&gt;this 绑定（this Binding）：定义了当前上下文 this 的绑定。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 340px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/6a691de80e33b1c01724c80eb1963d72/9f933/1240-20200817210458335.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 72.97297297297297%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACTklEQVQ4y11U124qUQzc//8HOigSCEQntJC8gugPkAjRQws99IB9PdbdlRKk0dnjMx7XxEgmkxyPxy0kEgl+fn7+hVQq9ev+x4cAcOx2+8rIZrOcyWQU+AbZ6/UqfD4fu1wu9vv9/PT0xB6Ph91uN0ciEc7lcpYfIHcC14jFYhyNRi2Ew2F1cjgcComqwk6nU4F7IBBg+EH4Pwh3m81GmmE6nf4VLZ/PK15eXvQE5+3tjQuFAr++vqodGZo8k4tgxuPxoPv9Tjj/Avbb7UbL5ZLW6zXtdjsL39/ftNls1I73y+WCPpJxvV75/f2dG40GF4tF/vj44FKppLb9fs94n0wmPBwO+fPzk5vNJtfrdUW73eZOp8PdbpdFVPtvHI9HjbJarejr60vP2WymUUVQMZ/P6Xw+a1YiQIPBgESEFosFbbdbggYqkT6SIQIbAD8RVghJTxHdiNNGBLZ4h10CKERcOabf4XBYh0KhK3rIp9OJhcASSSE9YukJ//z8KCRjHo1GLMJaNiBZK288HuubJKX7aphNr1arVKvVtKRyuUzT6ZSkfyTBtGQANqBSqShXhNQuAXRA8kdBBhqPSMgQ34D5DbsQWUQ0cylL7RgSssQgYAMfFWGPDThJDywhUwxCAN7gbN7xZrYGYtJXLRd+WHJDdo1RNrIwVwMZYF3ErieEwIOIDEl7ihNcCIKDn64N+oR0Idjr9ay9kjXRMjAwZAAnZIFgGAJOc//AxXDxj8VAVv1+nzAtc4IAJgrIG7daLesOngnwIA4OvoPBIP8D4UMpW+9Pj1YAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image&quot;
        title=&quot;image&quot;
        src=&quot;/static/6a691de80e33b1c01724c80eb1963d72/9f933/1240-20200817210458335.png&quot;
        srcset=&quot;/static/6a691de80e33b1c01724c80eb1963d72/12f09/1240-20200817210458335.png 148w,
/static/6a691de80e33b1c01724c80eb1963d72/e4a3f/1240-20200817210458335.png 295w,
/static/6a691de80e33b1c01724c80eb1963d72/9f933/1240-20200817210458335.png 340w&quot;
        sizes=&quot;(max-width: 340px) 100vw, 340px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;这里概念在 ES5，ES6 出现了一些变化，详细可以看&lt;a href=&quot;http://dmitrysoshnikov.com/ecmascript/javascript-the-core-2nd-edition/#execution-context&quot;&gt;JavaScript. The Core: 2nd Edition&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;调用栈（call stack or execution stack）&lt;/h2&gt;
&lt;p&gt;调用栈是程序运行的一个很重要的概念，如果不是很清楚可以先看一下&lt;a href=&quot;https://www.youtube.com/watch?v=Q2sFmqvpBe0&amp;#x26;t=299s&quot; title=&quot;The Call Stack&quot;&gt;The Call Stack&lt;/a&gt;这个视频，里面也详实解释到包括 C 或汇编运行时的调用栈情况。&lt;/p&gt;
&lt;p&gt;在 javascript 上这个情况要更复杂一些，它使用到一种叫环境栈的结构，一个函数调用压栈时，同时也会生成该函数的执行环境，进入环境栈。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1e0fc7a4a3552c1329a41318feb21d13/7a4b2/1240-20200817210458378.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 57.432432432432435%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACIElEQVQoz32Sy2sTURTG52/wDxBRqC7cCIJ1bRWrC5Ei2K1dCIpIUduFD9QurI9V3QitWNpFkVKx4kIhaIOBoBUVS5NJNGk6sWmapEkmM3nMKz/vTB70Yb1w5lzOnPPd73znSDRPvV5n67FMEyWRIBIOIYcW0TVtW87GOvcuuZ9W0DRqfJwe5fmtPp5c7Obe+SMMntrPzTMHhe/gWtce7p47zMiVs0wMXeZn4H0bqIUheQHHaQAKRlOPb3Cn5xAD3R30H9vNwMl9vJsa48ObaSYf9POw7zjXT+zlfm+neHzMq3Mcuw0qbaScTSWbCQ7Vsk46uURmRaFUE/80G71qUjMtcpk1TMvGFnllTd3UusewVi0zfKGLwdMH0NTCJo0MwTqTK7CcypJNp8kXdIoFFVvUh774udS5i8DsRIOIbbcAq7wdHWao96in3czIbeaElp9mJ1F+yyRzFX7EMnyVl4mlVoknYvhePuORaP/p1R7C835a0kmCK06Trtvq6lKEed9r5mZe4H81Tjjyi2KxgpYuC/Asiwt/+PY9zoKcQFGUdidOcw7tKZumgWVZjZfcATkNb9kO6+s5UqsrVCsVKqqGIUQ1hXRG1cYQm+G22l6b7XvleNRd30oslTTisThJJclaJiOGYbPTkdxV+Z+5rFVVJZ/Po+u60LvmxbbmGaLDXCmHFIlE2MlkWSYajRIMBgkEAt7dtX/lhuUwvs8+/gJ9NBTjhrQzcgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image&quot;
        title=&quot;image&quot;
        src=&quot;/static/1e0fc7a4a3552c1329a41318feb21d13/fcda8/1240-20200817210458378.png&quot;
        srcset=&quot;/static/1e0fc7a4a3552c1329a41318feb21d13/12f09/1240-20200817210458378.png 148w,
/static/1e0fc7a4a3552c1329a41318feb21d13/e4a3f/1240-20200817210458378.png 295w,
/static/1e0fc7a4a3552c1329a41318feb21d13/fcda8/1240-20200817210458378.png 590w,
/static/1e0fc7a4a3552c1329a41318feb21d13/efc66/1240-20200817210458378.png 885w,
/static/1e0fc7a4a3552c1329a41318feb21d13/c83ae/1240-20200817210458378.png 1180w,
/static/1e0fc7a4a3552c1329a41318feb21d13/7a4b2/1240-20200817210458378.png 1240w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;实际情况中，当一个函数 caller 调用一个 callee 时，会根据 caller 传递的参数初始化 arguments 变量和 callee 本身的 local variable 生成一个变量对象（activation object），这个变量对象是就是新的 execution context 的 variable object。&lt;/p&gt;
&lt;p&gt;同时会生成一个 scope chain，scope chain 的一种链表结构，在创建时会拿取 caller 的 execution context 中的 Scope chain，而后把自己的 variable object 加到链表头部。当前 context 的 Scope chain 则指向此链表头。其实说到底，Scope chain 就是 variable object chain，其中没有什么特别难理解的。这样形成的 Scope chain 符合词法作用域的特点。&lt;/p&gt;
&lt;p&gt;最后再在环境栈压入当前执行环境，至此完成整个入栈过程。出栈就不多说了，无非就是销毁执行环境，然后出栈。这样整个执行环境栈模型大致叙述完毕。有了这套模型，其实很多 JavaScript 的难点都迎刃而解了。&lt;/p&gt;
&lt;h2&gt;this binding&lt;/h2&gt;
&lt;p&gt;javascript 最令人迷惑的一个变量就是 this 指针了。很多人对各种 this 绑定云里雾里，不知其解。理解 this，最重要的其实还是要知道 javascript 根本没有 this 变量。&lt;/p&gt;
&lt;p&gt;其实很多人的对接触 this 都是从 c++或 java 等 OOP 中来的。javascript 对 this 的处理和他们区别很大。在 c++的 class 模型中，this 是作为一个隐藏指针，传递给 methods 的，也就是说每个 methods 都会拿到一个 this 变量，作为自己的 local variable。而且，他们的 method 不会像句柄一样传来传去，所以也导致这些 this 比较容易理解。&lt;/p&gt;
&lt;p&gt;然而在 JavaScript 中，function 的中是没有名为 this 的变量的，所有的 this，都是引用当前顶层 execution context 的 this。也就是说，理解 this 是 context 的 property 而不是 variable object 的 property 这一点很重要。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;NOTE: 在 ese6 中确实有了 lexical environment this，以支持 arrow function。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;关于 this binding 继承自父 context 还是辅以其他值，可以看另一篇文章&lt;a href=&quot;http://dmitrysoshnikov.com/ecmascript/chapter-3-this/&quot;&gt;ECMA-262-3 in detail. Chapter 3. This.&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;动态作用域&lt;/h2&gt;
&lt;p&gt;虽然 JavaScript 使用的是词法作用域，但是它提供一些方法去添加当前 context 的 scope chain 头部。例如 with 或 catch 块。不多说。&lt;/p&gt;
&lt;h2&gt;闭包和回调&lt;/h2&gt;
&lt;p&gt;回调就是闭包的应用，就不说了。闭包的实现在闭包的函数中具有一个[[scope]]的属性用于保存父 Scope chain。最重要是 JavaScript 的垃圾回收机制不会回收这些被引用的 variable object，虽然父级 context 可能被销毁（例如在异步回调之前，外部函数已调用完毕，它的 context 自然销毁了），但是在[[scope]]属性 Sc 链表中所引用 variable object 是不会销毁的。这就是闭包。当闭包被调用的时候，会生成新的 context，而后会将 context 的 Scope chain 初始化为 actived object + [[scope]]，这样，闭包就可以访问到它父 Scope 的变量了。&lt;/p&gt;
&lt;p&gt;值得注意的是[[scope]]是在函数创建的时候就初始化好了，而并不是在调用的时候初始化。所以其实所有的函数，都是闭包。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[js中的import和require]]></title><description><![CDATA[因为经常需要使用 nodejs 和 es6 来写 JavaScript 代码，所以有必要总结一下 js 中 import 和 require 的用法和问题。 require - exports require 是早期 js 还有没有 module…]]></description><link>https://pakholeung37.github.io/js中的import和require/</link><guid isPermaLink="false">https://pakholeung37.github.io/js中的import和require/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;因为经常需要使用 nodejs 和 es6 来写 JavaScript 代码，所以有必要总结一下 js 中 import 和 require 的用法和问题。&lt;/p&gt;
&lt;h2&gt;require - exports&lt;/h2&gt;
&lt;p&gt;require 是早期 js 还有没有 module 的年代的产物，是模块解决方案 commonJs 的一部分。也是 node
JS 官方使用的，使用最多的模块方案。直到现在，nodejs 的稳定版本仍然在使用 commonJS，如果需要 import 则需要打开实验设置。&lt;/p&gt;
&lt;p&gt;在 nodeJS 中，如果要引入某个模块，则有如下格式：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; a &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;a&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;而他们对应的 exports 形式则可以如下：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; a
&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; a &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; a &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;exports &amp;#x26; module.exports&lt;/h2&gt;
&lt;p&gt;值得关注的是 commonJS 常用 exports 和 module.exports 两个变量，但是只有 module.exports 是真正映射出去的值，他们之间的关系形如：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; module&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;exports&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;exports 只是一个指向 module.exports 的变量。&lt;/p&gt;
&lt;p&gt;形如&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; a &lt;span class=&quot;token comment&quot;&gt;// 使用module.exports = a;&lt;/span&gt;
exports &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 使用module.exports = {};&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;则不会被映射到包外。&lt;/p&gt;
&lt;h2&gt;cjs 加载方式&lt;/h2&gt;
&lt;p&gt;模块采用运行时加载，优先读取缓存的模式。也就是说模块只会在第一次 require 进行加载，并对返回结果进行缓存。所以形如下列代码这样做都是可以的：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; a2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;// 在任何地方都可以进行require&lt;/span&gt;

exports&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//模块返回一个new A(),但是多处require这个模块后，调用的是同一个对象。&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;import - export&lt;/h2&gt;
&lt;p&gt;与 require，import 是 es6 的模块化方案，也就是正规军了，大部分浏览器原生支持 import 了。在大多数情况下推荐优先使用 import。&lt;/p&gt;
&lt;p&gt;import 形式如下：&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; a1 &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; a &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; a &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; a &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;而因为有 default 关键字的存在，他的 export 形式也更加多变&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token number&quot;&gt;1.&lt;/span&gt; any &lt;span class=&quot;token comment&quot;&gt;// 对于第一条可以export noting 或 everything&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;2.1&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; a &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;2.2&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;3.1&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; a &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;3.2&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;anyname&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 只需使用export default关键词， 其他没所谓&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;其中值得注意的是 3.1 的情况。&lt;/p&gt;
&lt;p&gt;一般来说按照规范，export 一个对象，然后在 import 时解构赋值是完全 make sence 的，规范也允许你这样做。但是，由于目前大部分前端项目都使用 babel 和 webpack，在这种情况下将会导入失败，详细情况在&lt;a href=&quot;https://www.jianshu.com/p/ba6f582d5249&quot;&gt;这篇文章&lt;/a&gt;有提及到。&lt;/p&gt;
&lt;h2&gt;esm 加载方式&lt;/h2&gt;
&lt;p&gt;和 commonJS 不同的是 import 使用的是静态编译。这样做有很多好处，例如可以运行前判断得出模块之间的依赖关系，进行代码检查。但是由于是静态编译，一些 require 动加载的奇技淫巧就无法使用了，&lt;/p&gt;
&lt;p&gt;比如说&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;js&quot;&gt;&lt;pre class=&quot;language-js&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;xx&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;b&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;详细可以看一下&lt;a href=&quot;https://zhuanlan.zhihu.com/p/33843378&quot;&gt;深入理解 ES6 模块机制&lt;/a&gt;这篇文章。另外里面也谈到两个方案在处理循环依赖时的处理。&lt;/p&gt;
&lt;h2&gt;webpack+babel 中具体表现&lt;/h2&gt;
&lt;p&gt;首先可以说的是，目前其实只有 commonJS，具体是 es6 的模块方案会被编译成 commonJS 的形式，所以其实没差。在项目中你可以看到 import 懒加载，也导致了有 export default {} 这样的 bug。所以目前来说不用太纠结这件事。但是在前端使用标准的模块语法是一个好习惯。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[script tag方案详述]]></title><description><![CDATA[https://www.html5rocks.com/en/tutorials/speed/script-loading/]]></description><link>https://pakholeung37.github.io/script tag方案详述/</link><guid isPermaLink="false">https://pakholeung37.github.io/script tag方案详述/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a href=&quot;https://www.html5rocks.com/en/tutorials/speed/script-loading/&quot;&gt;https://www.html5rocks.com/en/tutorials/speed/script-loading/&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[this in JavaScript]]></title><description><![CDATA[上次谈到执行环境的时候，也谈到了 this，说道 this 值实则与函数无关，而与上下文有关。再者，this 的值在创建上下文的时候就已经确定了，无法在 runtime 中改变，例如 这篇文章将探讨创建上下文时，this 值将如何改变。 引用类型-ReferenceType…]]></description><link>https://pakholeung37.github.io/this in JavaScript/</link><guid isPermaLink="false">https://pakholeung37.github.io/this in JavaScript/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;上次谈到执行环境的时候，也谈到了 this，说道 this 值实则与函数无关，而与上下文有关。再者，this 的值在创建上下文的时候就已经确定了，无法在 runtime 中改变，例如&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; b
  &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; a
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 这样当然不可以了，但是在python却可以&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这篇文章将探讨创建上下文时，this 值将如何改变。&lt;/p&gt;
&lt;h2&gt;引用类型-ReferenceType&lt;/h2&gt;
&lt;p&gt;在这之前先看一下 JavaScript 內建类型的伪代码&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; valueOfReferenceType &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  base&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;base object&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  propertyName&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;property name&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;引用类型的值只有两种情况：&lt;/p&gt;
&lt;p&gt;当处理一个标识符时；&lt;/p&gt;
&lt;p&gt;或处理一个属性访问器；&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// 标识符&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; a
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;//属性访问器&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; b&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
a&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;b &lt;span class=&quot;token comment&quot;&gt;//是一个引用类型，且是一个属性访问器，他的base是a&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;而对于关联的 this 值的改变，则只会和以下情况有关：&lt;/p&gt;
&lt;p&gt;在一个函数上下文中，this 的值由调用者 caller 提供，且由调用函数的方式决定（即由函数如何调用决定）。&lt;/p&gt;
&lt;p&gt;如果调用括号(…)的左边是引用类型的值，this 将设为这个引用类型值的 base 对象&lt;/p&gt;
&lt;p&gt;在其他情况下（与引用类型不同的任何其它属性），this 的值都为 null。不过，实际不存在 this 的值为 null 的情况，因为当 this 的值为 null 的时候，其值会被隐式转换为全局对象。&lt;/p&gt;
&lt;p&gt;可以看以下例子&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; foo &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function-variable function&quot;&gt;bar&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;alert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; bar &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; foo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bar
foo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;bar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Reference, OK =&gt; foo&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;bar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Reference global&lt;/span&gt;

foo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;bar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// Reference, OK =&gt; foo&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;foo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bar &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; foo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bar&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// global&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; foo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bar&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// global&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;foo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bar&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; foo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;bar&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// global&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;alert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// global&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;第一种调用适用第一种情况，this 是由引用类型 foo.bar 调用，base 是 foo，所以 this 指向 foo。&lt;/p&gt;
&lt;p&gt;第二种情况，this 由引用类型 foo.bar 调用，base 是 bar，this 指向 global&lt;/p&gt;
&lt;p&gt;第三种情况则适用第二种情况，由左侧括号调用，而左值则是引用类型，base 为 foo。&lt;/p&gt;
&lt;p&gt;第四种情况， 赋值运算符调用 getValue 方法，返回结果是函数对象，不是引用类型，则 this 设定为 global&lt;/p&gt;
&lt;p&gt;第五种、第六种情况也一样，使用操作符调用了 getValue 方法，得到函数对象，同样设定为 global。&lt;/p&gt;
&lt;p&gt;第七种情况可以看到左值为函数对象时是怎么作用的，同样设定为 global。&lt;/p&gt;
&lt;p&gt;来看一件更酷的东西&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;alert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// global&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;alert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;foo &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; foo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;prototype&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;constructor&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// true&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// another form of the call expression&lt;/span&gt;

foo&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;prototype&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// foo.prototype&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这个例子充分印证 this 值在由不同引用句柄调用而发生的变化。&lt;/p&gt;
&lt;p&gt;当直接调用的时候，引用类型的 base 为 global，自然 this 指向 global。&lt;/p&gt;
&lt;p&gt;而当使用 foo.prototype.constructor 调用时，情况却发生了变化，由于句柄变成了 foo.prototype，所以自然 this 指向了 foo.prototype，也就是 foo 的原型对象。&lt;/p&gt;
&lt;h2&gt;base 值的改变&lt;/h2&gt;
&lt;p&gt;之前的一些情况都是在父上下文是 global 上的一些情况，并没有探讨父上下文更复杂的情况。在有些时候，base 会被设置成激活对象（Activation Object）。&lt;/p&gt;
&lt;p&gt;看以下这个例子。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// global&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;bar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// the same as AO.bar()&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里引用类型 bar 调用了，内部函数 bar 被父函数 foo 调用，上下文的 base 则被设置成父上下文的
AO，AO 总是返回 this 的值为 null，而调用 bar(),相当于调用 AO.bar()则 null.bar()，this 指向 global。&lt;/p&gt;
&lt;p&gt;看另一个例子&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function-variable function&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  x&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// 20&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;使用 with 语句后，with 对象添加到 Scope chain 的前面，AO 前面插入 with 对象，此时 base 被指向到 with 对象了，foo 的 base 是 with 对象，this 指向 with 对象，this.x = 20。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[前端静态资源优化]]></title><description><![CDATA[在网页性能优化中，为了能快的载入网页，有很多优化手段，其中一种命题，是如何降低网站的传输比特，使得在相同的带宽下，可以更快地载入需要的数据。 最小化代码 现在前端使用构建工具例如 webpack，gulp 都会使用到 minify code…]]></description><link>https://pakholeung37.github.io/前端静态资源优化/</link><guid isPermaLink="false">https://pakholeung37.github.io/前端静态资源优化/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;在网页性能优化中，为了能快的载入网页，有很多优化手段，其中一种命题，是如何降低网站的传输比特，使得在相同的带宽下，可以更快地载入需要的数据。&lt;/p&gt;
&lt;h2&gt;最小化代码&lt;/h2&gt;
&lt;p&gt;现在前端使用构建工具例如 webpack，gulp 都会使用到 minify code 这样的功能。&lt;/p&gt;
&lt;p&gt;脚本最小化比较简单，方法一般有删除多余空格和不必要字符或注释，替换过长的字符变量等。&lt;/p&gt;
&lt;p&gt;大部分构建工具都会内置最小化的工具，例如 webpack 中有 UglifyjsWebpackPlugin，使用 uglify
JS3，一般不需要开发者担心。&lt;/p&gt;
&lt;h2&gt;压缩文本&lt;/h2&gt;
&lt;p&gt;为了进一步降低带宽，开发者可以配置静态资源服务器进行 gzip 压缩传输。例如在 nginx 中就可以配置 gzip 压缩。但是需要注意的是 compress 是一种用运算换带宽的方法，会进一步加重服务器性能负担。另外注意的是这里说明的是压缩文本，对于图片和大文件等不适宜采取压缩方法，因为对于图片，使用静态压缩比较适合，而大文件则会严重加重服务器负担，而且效果还不明显。&lt;/p&gt;
&lt;h2&gt;减少库使用&lt;/h2&gt;
&lt;p&gt;在引入库的时候，尽量引入子库。不要因为要使用某个功能或函数，就引入整个库，在控制容量方面，这很致命。例如要使用 debounce 而引入整个 lodash 库。按需导入才是引用库的正解。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; _ form &lt;span class=&quot;token string&quot;&gt;&apos;lodash&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;//不要引入整个库&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; _debounce &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;lodash/debounce&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//引入子库&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里需要注意的是，在 webpack3+版本中使用了 tree shaking 技术，原理是使用了 es6 的静态引入分析。但是，现在大部分的前端项目都使用了 babel，使用的模块化方案是 commonJS，tree shaking 名存实亡。还是需要开发者按需导入。&lt;/p&gt;
&lt;h2&gt;流行库 CDN 加速&lt;/h2&gt;
&lt;p&gt;使用流行库例如 JQuery，Bootstrap，Lodash 等，可以使用 CDN 加速。但是在现代构建工具例如 webpack 中使用这种技术则会比较生硬。你需要在构建的入口 html 中，添加库引用，然后还要在全局定义一个变量。实际上，现代框架对全局变量的态度都是拒绝使用的。但是 CDN 加速有时候有时候又是不可避免的。&lt;/p&gt;
&lt;h2&gt;图片优化&lt;/h2&gt;
&lt;p&gt;web 中图片的优化主要有一下几种策略：选择正确的格式，调整图片分辨率，图片压缩，懒加载等。前三种就不多说了，说说懒加载。图片懒加载技术应该提升网站用户体验非常重要而常用的手段。懒加载除了可以节约用户流量外，还可以有效提升网页加载速度，因为浏览器不用去加载，渲染这些资源。详细可以看&lt;a href=&quot;https://developers.google.com/web/fundamentals/performance/lazy-loading-guidance/images-and-video/&quot;&gt;google-Developer Lazyload&lt;/a&gt;。&lt;/p&gt;
&lt;h2&gt;资源合并&lt;/h2&gt;
&lt;p&gt;资源合并在构建工具中用的很多，例如在 webpack 中可以把整个项目的代码包括库都打包进一个 main.js 的文件当中。这样可以节约 httpRequest。浏览器对于同一个域（注意是域而不是网页）可以并行的 httpRequest 是有限的，例如在 chrome 中，是 6 个，所以减少 httpRequest 可以有效提高网页加载速度。&lt;/p&gt;
&lt;p&gt;图片资源则可以使用 sprite。例如在 svg 或 icon 中都会使用 sprite，同样可以有效减少 httpRequest 数量。&lt;/p&gt;
&lt;h2&gt;cookie-free&lt;/h2&gt;
&lt;p&gt;cookie-free domain 主要还是用在一些静态资源上，由于浏览器向服务器通讯时需要带上 cookie，这会增加上行带宽的消耗，对于 js，css，图片等不需要 cookie 访问的资源可以使用 cookie-free。具体方法是使用不同域的静态资源服务器，这样由服务器设置的 cookie 不会设置到静态资源服务器上。避免发送无用的 cookie。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[建站记录]]></title><description><![CDATA[本文主要是对搭建本项目的问题解决方案进行记录。 我选用的是阿里云的轻应用服务器，一次性买了一年，花了 120，大概 10 块一个月。非常超值，主要是因为阿里有学生优惠政策，建议每个学生都人手一台，真的买不了吃亏。 服务器-阿里云轻应用服务器 镜像：ubuntu-16.0…]]></description><link>https://pakholeung37.github.io/建站记录/</link><guid isPermaLink="false">https://pakholeung37.github.io/建站记录/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;本文主要是对搭建本项目的问题解决方案进行记录。&lt;/p&gt;
&lt;p&gt;我选用的是阿里云的轻应用服务器，一次性买了一年，花了 120，大概 10 块一个月。非常超值，主要是因为阿里有学生优惠政策，建议每个学生都人手一台，真的买不了吃亏。&lt;/p&gt;
&lt;p&gt;服务器-阿里云轻应用服务器&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;镜像：ubuntu-16.04 主要是在 mint，比较好上手。&lt;/li&gt;
&lt;li&gt;cpu：单核 没什么好吐槽的了，毕竟 9.9，就是没办法测试 cluster 性能。&lt;/li&gt;
&lt;li&gt;内存：2G&lt;/li&gt;
&lt;li&gt;硬盘：40G 不知道是不是 ssd，因为之前买 vultr，他家用的 ssd。&lt;/li&gt;
&lt;li&gt;IP：120.79.157.195&lt;/li&gt;
&lt;li&gt;域名：pakholeung.xyz 6 块全年，简直不要钱。&lt;/li&gt;
&lt;li&gt;备案：还没有成功备案。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;其实最主要的还是在技术方面的选型。&lt;/p&gt;
&lt;p&gt;vue 虽然是前端框架，但是最后 build 出的仍然是静态文件，这点是不会变的。所以在服务器还是要架设静态文件服务上才能用。nginx 并不是我最开始的选择，我有更熟悉的 apache、或者是现在在使用的 node，都可以作为 web 服务。但是我最后还是选择用 nginx 了。听说 nginx 服务性能很好，能做很多事情，负载均衡，反向代理等，我觉得这是一个接触 nginx 比较好的机会。&lt;/p&gt;
&lt;h2&gt;关于 nginx 的配置&lt;/h2&gt;
&lt;p&gt;nginx 搭配向 vue 这种前端框架最大的问题应该是路由。就是当 vue、react 这类用上 virtual router 的时候，nginx 在处理 http 请求路径时并不会返回这些框架入口。例如 vue 入口应该是 index.html，在访问 &lt;code class=&quot;language-text&quot;&gt;http://xxx.xxx.xxx/&lt;/code&gt; 时会正确返回 index.html 资源。但是访问&lt;code class=&quot;language-text&quot;&gt;http://xxx.xxx.xxx/xxx&lt;/code&gt;时并不会返回正确的资源。因为对于 nginx 来说这些静态资源不存在。所以有必要将全部的路径都配置到 index.html 上。&lt;/p&gt;
&lt;p&gt;在&lt;a href=&quot;https://router.vuejs.org/zh/guide/essentials/history-mode.html#%E5%90%8E%E7%AB%AF%E9%85%8D%E7%BD%AE%E4%BE%8B%E5%AD%90&quot;&gt;vue 官方文档&lt;/a&gt;就有提及到使用 nginx 时需要的配置&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;location / &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  try_files &lt;span class=&quot;token variable&quot;&gt;$uri&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$uri&lt;/span&gt;/ /index.html&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;目的同样是为了通配所有路径到 index.html 上。&lt;/p&gt;
&lt;p&gt;令人意外的是在配置 nginx.conf(这个文件的绝对路径可以通过命令&lt;strong&gt;nginx -t&lt;/strong&gt;得到)中，该代码不起作用。&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;http &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;#...&lt;/span&gt;
  include /etc/nginx/sites-enabled/*&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  server &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    listen &lt;span class=&quot;token number&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    root /var/www/html/dist&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    location / &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      try_files &lt;span class=&quot;token variable&quot;&gt;$uri&lt;/span&gt; &lt;span class=&quot;token variable&quot;&gt;$uri&lt;/span&gt;/ /index.html&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;原因是配置上头 include 语句导入了 default 配置。导致自定义配置不能生效，经检验无论在语句前配置还是后配置都不能覆盖该设置。只能注释掉。&lt;/p&gt;
&lt;h2&gt;api 服务器部分&lt;/h2&gt;
&lt;p&gt;在后台服务器其实用的就是 node 了，主要是不需要语言切换，比较方便。数据库用的 mongodb，在同一服务器上架设。这个数据库暂时没有设密，而且配置了任何主机都能访问，方便调试。&lt;/p&gt;
&lt;p&gt;mongodb 的配置是根据&lt;a href=&quot;https://www.cnblogs.com/jinxiao-pu/p/7121307.html&quot;&gt;这篇文章&lt;/a&gt;配置的。&lt;/p&gt;
&lt;p&gt;另外为了稳定服务器的运行，使用了 pm2 来运行，可以如果程序崩溃会重启服务，另外还配置了热更新，方便代码同步时重启服务。整体 pm2 配置在 server 根目录的&lt;strong&gt;ecosystem.config.js&lt;/strong&gt;文件中。&lt;/p&gt;
&lt;p&gt;另外服务器中的 config 文件下的 config 和开发本地的 config 有些许不同，主要是静态资源路径的设置。切勿覆盖掉服务器的 config 文件。&lt;/p&gt;
&lt;h2&gt;vue 部分&lt;/h2&gt;
&lt;p&gt;你并不需要把整个 vue 项目同步到服务器中，只需要把 dist 目录同步到服务器上就可以了。另外 src/config 文件下同样有关于服务器环境和本地开发环境的差异的设置，这些设置主要是靠构建时的定义环境有关。当&lt;strong&gt;process.env.NODE_ENV === ‘production’&lt;/strong&gt;时，为服务器配置。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[浏览器中的缓存机制]]></title><description><![CDATA[先贴两篇文章 MDN-HTTP 缓存、Google Developer-HTTP 缓存 关于缓存机制，这里只讨论两个关键字，一个是 cache-control，一个是 Etag。 其实有关缓存机制，总来的说只分两种情况，就是使用缓存前是否经过服务器确认。 cache…]]></description><link>https://pakholeung37.github.io/浏览器中的缓存机制/</link><guid isPermaLink="false">https://pakholeung37.github.io/浏览器中的缓存机制/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;先贴两篇文章 &lt;a href=&quot;https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching_FAQ&quot;&gt;MDN-HTTP 缓存&lt;/a&gt;、&lt;a href=&quot;https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching&quot;&gt;Google Developer-HTTP 缓存&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;关于缓存机制，这里只讨论两个关键字，一个是 cache-control，一个是 Etag。&lt;/p&gt;
&lt;p&gt;其实有关缓存机制，总来的说只分两种情况，就是使用缓存前是否经过服务器确认。&lt;/p&gt;
&lt;h2&gt;cache-control&lt;/h2&gt;
&lt;p&gt;cache-control 是整个缓存机制的核心，它确定服务器如何指示浏览器进行缓存（注意仅仅是指示，关于浏览器如何进行缓存，情况是不确定的）。&lt;/p&gt;
&lt;p&gt;一般来说，cache-control 只分两类指示，一种是指示缓存方式，另一种是指示是否私有。&lt;/p&gt;
&lt;p&gt;关键字：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;max-age：指示资源能被缓存的最大时间。&lt;/li&gt;
&lt;li&gt;no-cache：强制确认，必须经过服务器确认。&lt;/li&gt;
&lt;li&gt;no-store：指示浏览器即中间服务器不得缓存。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;而 public 和 private 则指示中间服务器是否能进行缓存。&lt;/p&gt;
&lt;p&gt;通常来说，一旦指定 max-age，如果浏览器正确缓存资源的情况下，则该资源直到过期之前都不会到服务器确认。&lt;/p&gt;
&lt;p&gt;一旦 max-age 过期，则轮到 Etag 出场。&lt;/p&gt;
&lt;h2&gt;Etag&lt;/h2&gt;
&lt;p&gt;Etag 是 HTTP 表头传递验证令牌，是一个资源的一个指纹，当客户端请求资源时，如果 Etag 已存在，则必带上该 Etag，发送到服务器。&lt;/p&gt;
&lt;p&gt;服务器收到 Etag 是，则会验证该指纹与资源指纹是否一致，如果资源未发生变化，则会返回 304，指示客户端可以继续使用缓存。&lt;/p&gt;
&lt;h2&gt;Revving&lt;/h2&gt;
&lt;p&gt;web 开发者发明了一种被 Steve Souders 称之为 &lt;code class=&quot;language-text&quot;&gt;revving&lt;/code&gt; 的技术。不频繁更新的文件会使用特定的命名方式：在 URL 后面（通常是文件名后面）会加上版本号。加上版本号后的资源就被视作一个完全新的独立的资源，同时拥有一年甚至更长的缓存过期时长。但是这么做也存在一个弊端，所有引用这个资源的地方都需要更新链接。web 开发者们通常会采用自动化构建工具在实际工作中完成这些琐碎的工作。当低频更新的资源（js/css）变动了，只用在高频变动的资源文件（html）里做入口的改动。&lt;/p&gt;
&lt;p&gt;这种方法还有一个好处：同时更新两个缓存资源不会造成部分缓存先更新而引起新旧文件内容不一致。对于互相有依赖关系的 css 和 js 文件，避免这种不一致性是非常重要的。&lt;/p&gt;
&lt;p&gt;缓存机制到这里为止。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[版本金凤梨酥日志]]></title><description><![CDATA[…]]></description><link>https://pakholeung37.github.io/版本金凤梨酥日志/</link><guid isPermaLink="false">https://pakholeung37.github.io/版本金凤梨酥日志/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;本版本目前开放的功能：&lt;/p&gt;
&lt;p&gt;用户：&lt;/p&gt;
&lt;p&gt;你现在可以通过通过金风梨的注册页面注册，成为金风梨的用户，在上面发表你的文章。并且支持在设置页面，更改你的头像，昵称，个性签名等一系列字段。你也可以在个人主页页面浏览到你个人发布的文章和评论。&lt;/p&gt;
&lt;p&gt;文章：&lt;/p&gt;
&lt;p&gt;现在你可以通过右上角新文章捷径访问到文章编辑的页面，开始写你的文章了。你发布的文章将会根据发布时间顺序排列在首页。鉴于目前只有我在使用这个网站，所以首页内容是没有筛选的。&lt;/p&gt;
&lt;p&gt;写文章：&lt;/p&gt;
&lt;p&gt;现在你可以进行文章编辑了，而且支持自动保存哦。&lt;/p&gt;
&lt;p&gt;评论：&lt;/p&gt;
&lt;p&gt;成功登录的用户，现在可以在文章低下进行评论。并且目前为止，你发表过的评论只能在文章页进行删除操作。而且目前也支持子评论了，你可以对某个评论进行评论，你的评论将以时间正序出现在父评论下方。&lt;/p&gt;
&lt;p&gt;本版本目前看起来有其实不能用的功能：&lt;/p&gt;
&lt;p&gt;首页热门标签：&lt;/p&gt;
&lt;p&gt;看起来能用，其实不能用。而且我也没有加入文章分类的想法，目前还在研究，我打算使用标签或一级标签这样的设计来模拟分类。总的来说，我觉得官方分类的设计不是特别好。&lt;/p&gt;
&lt;p&gt;首页状态栏字段-发现-话题：&lt;/p&gt;
&lt;p&gt;看起来应该能用，但其实也是不能用。而且我也没意思让他能用。大概只是放着好看。&lt;/p&gt;
&lt;p&gt;状态栏搜索：&lt;/p&gt;
&lt;p&gt;很遗憾，搜索功能现在还没开始做。&lt;/p&gt;
&lt;p&gt;首页通知按钮：&lt;/p&gt;
&lt;p&gt;很遗憾，通知系统还没开始做。&lt;/p&gt;
&lt;p&gt;文章的 viewCount：&lt;/p&gt;
&lt;p&gt;其实是没有的。&lt;/p&gt;
&lt;p&gt;首页 banner：&lt;/p&gt;
&lt;p&gt;那几个漂亮的大美女只是在循环播放，并没有什么实质性的作用，当然也不能点击。&lt;/p&gt;
&lt;p&gt;目前大概就这些了。&lt;/p&gt;
&lt;p&gt;本版本看起来没有但是应该有的功能：&lt;/p&gt;
&lt;p&gt;用户提交信息筛查：&lt;/p&gt;
&lt;p&gt;其实最主要是对各个提交域进行限制，例如限制密码多少位，包含多少字母这样。但是我太懒了，先这样吧。&lt;/p&gt;
&lt;p&gt;文章标题长度限制：&lt;/p&gt;
&lt;p&gt;前端会出现限制，但是在后端并不会，单纯用 API 提交一个超长的标题并不会报错。&lt;/p&gt;
&lt;p&gt;硬删除：&lt;/p&gt;
&lt;p&gt;本项目所有的删除按钮都触发软删除，暂时无法进行硬删除。&lt;/p&gt;
&lt;p&gt;已发布的文章不能修改或删除：&lt;/p&gt;
&lt;p&gt;很快这个功能也会有了呵呵。&lt;/p&gt;
&lt;p&gt;本版本 bug 异常多，其中包括：&lt;/p&gt;
&lt;p&gt;未登录时，文章出现评论框，而且也出现子评论框。一旦评论，即刻报错。&lt;/p&gt;
&lt;p&gt;个人页面出现了文章计数，文章计数是后台在文章进行创建、删除时的计数结果，是纯静态的。目前计数会把草稿和私人笔记都计算在内，所以计数会比能看的高。&lt;/p&gt;
&lt;p&gt;封面上传时并不会触发自动保存，稍后会进行修复。&lt;/p&gt;
&lt;p&gt;文内上传图片是 bug 的重灾区，现在探明的 bug 包括，在图片上传完毕时并不会触发自动更新，图片上传时退出页面或直接发布导致向数据库插入 blob 地址，稍后会修复图片上传时能发布的问题。&lt;/p&gt;
&lt;p&gt;设置中个人信息很多域都不能为空，否则报错，稍后会进行修复。&lt;/p&gt;
&lt;p&gt;选中文内图片时，虽然可以虽然 link 和 image 按钮不为 disabled，但是没有任何反应，他的行为是正确的，只是没有 disabled。&lt;/p&gt;
&lt;p&gt;本版本存在的问题：&lt;/p&gt;
&lt;p&gt;备案还没有发下来，暂时域名 pakholeung.xyz 还没办法使用。&lt;/p&gt;
&lt;p&gt;服务器中运行是用的 pm2，热更新时会重启服务器，可谓相当舒服。但是我发现在 multer 中定义的上传相对路径对相对于运行命令的，也就是 pm2 start 时的运行路径。这点让我很意外，因为开发版本从未有过这样的问题。&lt;/p&gt;
&lt;p&gt;通过 articleID 你可以查看到任何想查看的内容，只是这个 id 很长很难记导致你很难获取。但是这仍然不寻常。&lt;/p&gt;
&lt;p&gt;目前版本 draft 只能保存到 10 篇，超过这个数量就久的文章就不会显示在草稿中了。你很难说这是一个 bug，但是产生幽灵草稿似乎也不是太好。&lt;/p&gt;
&lt;p&gt;本网站没有使用 ssr，更没有做 seo，所以基本没有任何方法通过搜索引擎搜索到本网站。这很糟糕。&lt;/p&gt;
&lt;p&gt;为了调试方便本网站使用的数据服务器并没有密码，任何人，任何地方，任何机器都可以访问到这个数据库。这很糟糕。&lt;/p&gt;
&lt;p&gt;服务器是单核的，所以我也没办法测试 pm2 的 cluster 模式了。&lt;/p&gt;
&lt;p&gt;内嵌在文章中的图片和封面都使用的是绝对路径，并以绝对路径的方式存入数据库。这很糟糕。&lt;/p&gt;
&lt;p&gt;另外我承认我在 css 方面造诣不高，架构很有问题。所以目前网站中大部分的变量例如颜色，都不是变量，而是以绝对值写入 css 中。&lt;/p&gt;
&lt;p&gt;另外暂时来说上传的图片还没有机制删除。目前也在考虑使用特定时间段遍历数据库然后删除没有指向的图片了，这个方法也很糟糕。还是建一个删除图片的接口比较好。&lt;/p&gt;
&lt;p&gt;暂时就这些吧。&lt;/p&gt;</content:encoded></item><item><title><![CDATA[金风梨优化记录]]></title><description><![CDATA[这次优化主要是针对站点首屏加载资源过多，拖慢首屏渲染而做出的优化尝试。 主要手段包括： 1、按需引入 iview，现在所有使用的 components 都要手动引入。 2、删除 prefetch 链接。具体参考vue-cli prefetch 一节。 3、gzip 压缩。…]]></description><link>https://pakholeung37.github.io/金风梨优化记录/</link><guid isPermaLink="false">https://pakholeung37.github.io/金风梨优化记录/</guid><pubDate>Thu, 12 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;这次优化主要是针对站点首屏加载资源过多，拖慢首屏渲染而做出的优化尝试。&lt;/p&gt;
&lt;p&gt;主要手段包括：&lt;/p&gt;
&lt;p&gt;1、按需引入 iview，现在所有使用的 components 都要手动引入。&lt;/p&gt;
&lt;p&gt;2、删除 prefetch 链接。具体参考&lt;a href=&quot;https://cli.vuejs.org/zh/guide/html-and-static-assets.html#prefetch&quot;&gt;vue-cli prefetch 一节&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;3、gzip 压缩。&lt;/p&gt;
&lt;p&gt;4、按需引入 highlight.js&lt;/p&gt;
&lt;p&gt;使用 Lighthouse 测试后会发现在首页测试中，performance 一项的得分由原来的 22 上涨到 88 分。效果也是比较好的。&lt;/p&gt;
&lt;h2&gt;按需引入 ivew&lt;/h2&gt;
&lt;p&gt;相关记录在项目 plugins/iview 文件，现在需要手动导入所需 components&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1bc35606fd9793930228f008fd10e1ed/7a4b2/1240-20200817211859449.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAC+UlEQVQoz1WQ3U+TZxyG3/9g/8KOlmxHZhkfgthidFuyLFmUsGiMZoKwuaEFt1UMKApWnJukU4TViYXZFWhTwEGFQoBCP2hpXyoq9vPtu8L4KNKSJVt0Hlx7VzzZwZX7/j0Hd/JcwuqTHvxjV/DaW5h36Jh72JLr/jEd7uFm3CPNiBM6UiEjhtYsP9T/yTXtKhdrwjTXylyp+4NzFSmqP4mhOSIhSO5G4s6z/O7RIo7UMN1XhW/wFE4lF0fPILu1xKY1xGcv4XKkmRhZY3Z8E1vPBl16CaN+k9Ofynz4TpiDeQkE2X8VyduI5LlAwP4NrgENTybrSXov5t6S3iaiLiX9N/DNLjPpiOCZkRkyp7nVsoK+aZ1Th5Ko3nLxUZ4DYSNqYSNizpGO9JKO9iq9d+dWuix2EPFeJ+b/iXFbhiFTmjHrNvd/zHD5yxVqy9coKwzy9hs3ee9N3c7gZqyPrYQ1x/O45TX9ymA/y6Ke+H9aPK0MDSa427XAr+Ywtw2rNLck+PbsOpWVEQ4fdXH0WABhM2YltdhD2Pczz+buIC0YiQfvkRDv5QZTwTZCQ2X8cl1F+7iP70YDNNjc6CeW+apfRmN+zmc3/6K64x8Otb5EyEg2FpztmAxajO1fYzU20Nd1nt/Ml5RBCzFXEz5rGdOWKi6bRqnpfEBVxzCnjVHyzwxzpC3IcdPflN/Z5uOOFztfXg+bFXbcrSskQ92sPL2vqLAQdjbgtRwm5KjFsBjg2ryPVq+HOrtMeecUn1uXqBjJYn+cwbmURdhK2BR3FjIKW6/JStbcnUkOILnrme1WIT6soFMO8H14jqvLIdpWt2lMZqmNvKRSfEXKPkjG8QAhGugmOt9FRCH6P+4qLrsRHeeYMpXhHqjGIE5zyzdFU2ASzaOnHFtY4sTjFb4IrBGcmWFp3o/w/gdq1OpiinYXoFbtoaSkGJWSpaoi1HuLqWs8jlZ3kj3FBeQXFbF3X6mSu3k3L49d+fnsKiykoKSE0gMH2Ld/P/8COIeLGJVNwTYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image&quot;
        title=&quot;image&quot;
        src=&quot;/static/1bc35606fd9793930228f008fd10e1ed/fcda8/1240-20200817211859449.png&quot;
        srcset=&quot;/static/1bc35606fd9793930228f008fd10e1ed/12f09/1240-20200817211859449.png 148w,
/static/1bc35606fd9793930228f008fd10e1ed/e4a3f/1240-20200817211859449.png 295w,
/static/1bc35606fd9793930228f008fd10e1ed/fcda8/1240-20200817211859449.png 590w,
/static/1bc35606fd9793930228f008fd10e1ed/efc66/1240-20200817211859449.png 885w,
/static/1bc35606fd9793930228f008fd10e1ed/c83ae/1240-20200817211859449.png 1180w,
/static/1bc35606fd9793930228f008fd10e1ed/7a4b2/1240-20200817211859449.png 1240w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/101dcdee3e50dafbda01afbfba55e26f/7a4b2/1240-20200817211859633.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAADIUlEQVQozx2R20/TBwCF+wfs2T0s2dtefHJEuZWKGHHIjIsEo2CmQRhMRZHLMI4AETQbLCyTObpQCHUi13VtYZWfvdALtOVHkdLSdtiWQmkLjUMGxgyTZfvW7eF7OsmXc3IkEec9AsZaAqZ6vM9q8Rnq8OrrWNTdYHW2CaNuBmW/ldHBWYYeWXnyH8pZ1KoZFB073DzzlsbSPW6X/EXVyT+RvHSWsWUrZkl9Bv/EJ7hVp1gYK2DTeo7fHReZtz7HKESYmvSg0ywxPuzk5+F5TPplhnp2aLwcpqnSzde1m1wt3EWyvVDNinCBBfV5tuxlJMUaEo5r+FTpOJSHWH/hJxjcIhJOsL76CsOUh5FBK1MTTvr6trlV/w+1DX/zadkuFy4GkSRDWrZWxlh1PWTD9RVJ911eiuXM9r6PvPEAvkUXoujDJXpY9qwh6Lyox90MKWfo749xveE1WflveOfdeQ68dwdJzDdK3Ksg4e5iY/4e8dkKYuazLI7mYFBICS4HCAdfsxrcZtm9xeQvXgZ67Qz02OiSR6lo26Pq7h/kfxahsMqFJCJ2ErE3EXV8wYb9FnH7VeKOm0Qtl0jYy5mz2Bl+YkY1Zkb/1ItqxM2P3VZ+6DTR/J2P4vYQpR1JZI37HPx8H0lIfMCKrQW/cIXQsyLilnPErKXEpk8T0OSiGdGjkM+hVDiQd8/Q0Wak9ctfaakbo2XAT6XmFeXKPYrkbyjpTQk3xTriKUHUVETCcpZ1UzFrphL86mxcQxn89L2K29WPuX9nnOYaHecLeij5uJv6kj4udzpJG0xSbXjLY9ce2sXUywlnDeHpcsLmStZsqbnGk4Q0hwhPZKQa5qB1TdM/95wBu4OHgo1v1AL3JwXaNRO0usJUBPZpi8KmoGXXoEXywtJAwHDtf1ZMN3AMytA9+ID5oRxsj44irOh5GvegDc2hDjoQIi66gnoK7d9yXTRzyb1N6287LFlt+EURyUcFxzieJyUnO528Y1Kk0mxkMim5sgzycrOob75CY3tVKs8m/UgmshwZmRmZfHj4MGlH0knLzEKae5S8/HyOnzjBvzEpeS1PSpLqAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image&quot;
        title=&quot;image&quot;
        src=&quot;/static/101dcdee3e50dafbda01afbfba55e26f/fcda8/1240-20200817211859633.png&quot;
        srcset=&quot;/static/101dcdee3e50dafbda01afbfba55e26f/12f09/1240-20200817211859633.png 148w,
/static/101dcdee3e50dafbda01afbfba55e26f/e4a3f/1240-20200817211859633.png 295w,
/static/101dcdee3e50dafbda01afbfba55e26f/fcda8/1240-20200817211859633.png 590w,
/static/101dcdee3e50dafbda01afbfba55e26f/efc66/1240-20200817211859633.png 885w,
/static/101dcdee3e50dafbda01afbfba55e26f/c83ae/1240-20200817211859633.png 1180w,
/static/101dcdee3e50dafbda01afbfba55e26f/7a4b2/1240-20200817211859633.png 1240w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/71f32fb5f69b5001e8ebdde89a5b4988/7a4b2/1240-20200817211859569.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAADGklEQVQozx2R20/bdRiH+z94oYnZhTFxV5tTGIzC2jIORSdiFINmTuJhcStiwENmjAm6xIRp1IhBNrG2G6xjQA+UQwuldNAB5dSWnvvrDwpdp9LByog7qBePX7148nnzXjx5D4rU7DkCY82EJlqJuFoErQSdLayMnkHytjM5uI5ZH8bUtcilDi/676cwdszQ27mA5dcQY6abNB3P85Zql7qDERTSRAMRu5ZV23P4zTUs9mvxW54nZKsi6TrN2JUE9kspBrqDQuITkghWQwybIYn5lxA2o8zphh0aX7jDKxUxFFtzJ8h5a0mOVjNv0rDYp2LTVUXWVUbG8waJwBap8F2Sq9uCHVHvit4OLmsS50AY52CalpY/aXp/mzcb/0GR9Z0lO9tM3HmCyEg9srOWdWc1qaFnWZuoJzi/gXcyJogy70nim5YI+rKYOiIYzgcwG2R0n/2F7vP7nGx9KCZc/pg/fGfIXH8dyVGLNFJBalhJyrKf9PhLQhLn6mWnwMFlvZ0rxhEhlWlvneGrD1z0dcc5rrtP5ak8VSIVsucUCWcDGXcdG+MVyCNHkIcOIQ3sIzVSg+y/TTq0x3po93+kgFh9ZQdD+zI/fDJD57lldF33aLr4gHd+fCCE7pMkHXVsTlQhD/8nexrZup+o6TFi4lk3Ihmmw1m8kZt4/GmmBd7VDD19ES78vETPQJy3Tfdo7HlI/U93xZedLxO3l7M2WopkOyRWfYrEwJMs6R9lyarFlUsznttkKCtxLRXCKAcxrIf4Or3CawtWmqNztEzt8a13j2+m8mJCh5aouYB1+wHWLE8g9T/Oau8+5i8+wuJgNbntHPk7eUJbt5i7tYF5M0F3OsxH4RkOmr6j7JqRttjfbLsd3F6cRbFieZHZXhWBfiX+vsPcMBZwXV+Iq+sAnquvsvZ7ho3cbwxH/ZiCPi4E5/hyyc17bguFHW2o2z6lU5wkNukisrCAQluj4Vh5KcqSYjTqMlSqMtQiy9VKNKpSPvziXc6e11F6VEnRkRKOqlUUK0soKC7imaJCCg4XotKoKNdWc6yykn8BUSt98LW8/U4AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image&quot;
        title=&quot;image&quot;
        src=&quot;/static/71f32fb5f69b5001e8ebdde89a5b4988/fcda8/1240-20200817211859569.png&quot;
        srcset=&quot;/static/71f32fb5f69b5001e8ebdde89a5b4988/12f09/1240-20200817211859569.png 148w,
/static/71f32fb5f69b5001e8ebdde89a5b4988/e4a3f/1240-20200817211859569.png 295w,
/static/71f32fb5f69b5001e8ebdde89a5b4988/fcda8/1240-20200817211859569.png 590w,
/static/71f32fb5f69b5001e8ebdde89a5b4988/efc66/1240-20200817211859569.png 885w,
/static/71f32fb5f69b5001e8ebdde89a5b4988/c83ae/1240-20200817211859569.png 1180w,
/static/71f32fb5f69b5001e8ebdde89a5b4988/7a4b2/1240-20200817211859569.png 1240w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;删除 prefetch&lt;/h2&gt;
&lt;p&gt;原来的策略会尽早 fetch 所有的 js 和 css，这不是我想要的，所以我通过 vue 文档中的 prefetch 一节，删除掉 prefetch 链接。&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b4205ee9c6f394a8e8fb4af650760ea9/7a4b2/1240-20200817211859600.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAB+0lEQVQoz31Sy5LTMBD0X5Fk10kIRfEbHDly48KZT+CP9kTxKK7EoWI7yW4iy7Jelp/NSMmGFAdU1aWxJPf09EykFcPxsIV1DbquxzgirKbvcJAcgh/Bn04oWAklDYwysNahaRpIqQiSvmuChdYakaHL4nSEECIcdl0XMPR9IJZ0r7hAlnH8ygxYYWFNC5+3tUTOOVxdhwSBUCsBwfbo+4HUjRgI4w2kNtClwDqt8HVtkKT0vrQhmaoqggxkxpigNvKB4AxKaSLtA8bnur1CT0gKN0T4PTFI8wpauXDnSJEuzgpbqqqmCiMlBR6zDQz54MmGYbjCE+vawYgKm6zCDyLM95KSnwk1KSoOB8hKBIVnD41FyQv4vfaZ2jYQP+9108FWikqt8I1KznfiqlCXJY77A+gJun68eHhRKC8lj/94aF0bCLdUapIrPD5J8LImggG+M62ls98PsCILjYoUeeQlO+eCqlv4MTK177JEyRTKqoHSDTXh4rUfL83w8+EzWPolqI5cbVCeduiHv424XW1HfrbeAh8jqPrfirZpivV6jSRJkOc5zVsW9it2O5zYCZx89ig8igKMsQAfFzSLARRHr9+8wnwRYzKZYLlc4O4+RjyfUxxjMY/x/uNbfPj0DnF8j8l0RudL3M1m9P5F+Gc69f/NsVq9JKzwBy1yJdfHJ1WdAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;image&quot;
        title=&quot;image&quot;
        src=&quot;/static/b4205ee9c6f394a8e8fb4af650760ea9/fcda8/1240-20200817211859600.png&quot;
        srcset=&quot;/static/b4205ee9c6f394a8e8fb4af650760ea9/12f09/1240-20200817211859600.png 148w,
/static/b4205ee9c6f394a8e8fb4af650760ea9/e4a3f/1240-20200817211859600.png 295w,
/static/b4205ee9c6f394a8e8fb4af650760ea9/fcda8/1240-20200817211859600.png 590w,
/static/b4205ee9c6f394a8e8fb4af650760ea9/efc66/1240-20200817211859600.png 885w,
/static/b4205ee9c6f394a8e8fb4af650760ea9/c83ae/1240-20200817211859600.png 1180w,
/static/b4205ee9c6f394a8e8fb4af650760ea9/7a4b2/1240-20200817211859600.png 1240w&quot;
        sizes=&quot;(max-width: 590px) 100vw, 590px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;gzip 压缩&lt;/h2&gt;
&lt;p&gt;通过在服务器配置 gzip 选项，压缩 1k 以上的 ascii 文档。配置/etc/nginx/nginx.conf 中 gzip 等选项可以做到。&lt;/p&gt;
&lt;p&gt;接下来可以尝试使用 cdn 和 cache-control，加速站点。&lt;/p&gt;</content:encoded></item></channel></rss>